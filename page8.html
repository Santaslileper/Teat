<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Nearby Map + Directions</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
body { margin:0; font-family:system-ui,sans-serif; background:#0d1117; color:#e6edf3;}
#map { height:55vh; }
#controls{padding:.5rem 1rem;background:#161b22;display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;}
#places{padding:1rem;max-height:40vh;overflow:auto;}
h2{text-align:center;margin:.7em 0;}
button{padding:.8em 1.4em;border:none;border-radius:10px;background:#238636;color:#fff;font-size:1rem;}
label{font-size:.9rem;}
li{margin:.4em 0;cursor:pointer;}
li:hover{color:#58a6ff;}
</style>
</head>
<body>
<h2>Nearby Places + Directions</h2>
<div id="controls">
  <button id="btn">Locate Me</button>
  <label><input type="checkbox" class="cat" value="highway" checked> Roads</label>
  <label><input type="checkbox" class="cat" value="amenity" checked> Amenities</label>
  <label><input type="checkbox" class="cat" value="shop" checked> Shops</label>
  <label><input type="checkbox" class="cat" value="leisure" checked> Parks</label>
</div>
<div id="map"></div>
<div id="places"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map');
let userMarker, routeLine;
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19, attribution:'© OpenStreetMap contributors'
}).addTo(map);

async function getNearby(lat, lon, cats){
  const filters = cats.map(c=>`node["${c}"](around:1000,${lat},${lon});way["${c}"](around:1000,${lat},${lon});`).join('');
  const query = `[out:json][timeout:25];(${filters}node["name"](around:1000,${lat},${lon});way["name"](around:1000,${lat},${lon}););out tags center geom;`;
  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
  const res = await fetch(url);
  const data = await res.json();
  return data.elements.filter(e=>e.tags && e.tags.name);
}

async function getRoute(fromLat,fromLon,toLat,toLon){
  const url=`https://router.project-osrm.org/route/v1/driving/${fromLon},${fromLat};${toLon},${toLat}?overview=full&geometries=geojson`;
  const res=await fetch(url);
  const data=await res.json();
  if(!data.routes||!data.routes[0]) throw new Error("No route found");
  return data.routes[0].geometry.coordinates.map(([lon,lat])=>[lat,lon]);
}

function clearRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
}

async function locate(){
  document.getElementById('places').innerText='Getting location…';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude:lat,longitude:lon}=pos.coords;
    map.setView([lat,lon],15);
    if(userMarker) map.removeLayer(userMarker);
    userMarker=L.marker([lat,lon]).addTo(map).bindPopup("You are here").openPopup();

    const cats=[...document.querySelectorAll('.cat:checked')].map(c=>c.value);
    const els=await getNearby(lat,lon,cats);
    document.getElementById('places').innerHTML=`<b>${els.length}</b> items found:<ul>`+
      els.map((e,i)=>`<li data-i="${i}">${e.tags.name}</li>`).join('')+'</ul>';

    document.querySelectorAll('#places li').forEach(li=>{
      li.onclick=async()=>{
        const e=els[li.dataset.i];
        clearRoute();
        let destLat=e.lat|| (e.center&&e.center.lat) || (e.geometry&&e.geometry[0].lat);
        let destLon=e.lon|| (e.center&&e.center.lon) || (e.geometry&&e.geometry[0].lon);
        if(!destLat||!destLon) return alert("No location data");
        const line=await getRoute(lat,lon,destLat,destLon);
        routeLine=L.polyline(line,{color:'yellow',weight:4}).addTo(map);
        map.fitBounds(routeLine.getBounds(),{maxZoom:17});
      };
    });
  },err=>{
    document.getElementById('places').innerText='Location error: '+err.message;
  },{enableHighAccuracy:true});
}

document.getElementById('btn').onclick=locate;
</script>
</body>
</html>