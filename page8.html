<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Sliding Map Key Navigator</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  /* Base styles */
  body { font-family: 'Inter', sans-serif; }
  
  /* --- SIMPLIFIED PIN STYLE (EASY TO RENDER) --- */
  .custom-pin {
    width: 14px;
    height: 14px;
    background-color: #f87171; /* Red-400 */
    border: 2px solid #b91c1c; /* Red-700 */
    border-radius: 50%; /* Simple circle */
    position: relative;
    box-shadow: 0 0 5px rgba(220, 38, 38, 0.7);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }
  .custom-pin.active {
    background-color: #3b82f6; /* Blue-500 */
    border-color: #1d4ed8; /* Blue-700 */
    box-shadow: 0 0 10px rgba(59, 130, 246, 1);
    transform: scale(1.5); /* Simple scale up on activation */
    z-index: 1000;
  }

  /* Key Panel transition and size on mobile */
  #key-panel {
    transition: transform 0.3s ease-in-out;
    transform: translateX(100%); /* Start hidden off-screen */
  }
  #key-panel.open {
    transform: translateX(0); /* Slide fully into view */
  }

  /* Custom slider and scrollbar styles for dark theme */
  input[type=range]::-webkit-slider-runnable-track { background: #4b5563; border-radius: 8px; height: 8px; }
  input[type=range]::-moz-range-track { background: #4b5563; border-radius: 8px; height: 8px; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
  #places-list::-webkit-scrollbar { width: 6px; }
  #places-list::-webkit-scrollbar-track { background: #1f2937; }
  #places-list::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
</style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden flex flex-col">

  <!-- Header and Controls Section -->
  <header class="p-4 bg-gray-800 shadow-xl z-20">
    <h1 class="text-2xl font-extrabold text-center text-blue-400 mb-4 tracking-wider">Interactive Map Key</h1>
    <div id="controls" class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">

      <!-- Locate Button -->
      <button id="btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 transition duration-150 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-green-500/50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
        </svg>
        Find My Location
      </button>

      <!-- Radius Slider -->
      <div class="flex flex-col w-full sm:w-48 p-2">
        <label class="text-sm font-semibold mb-2 flex justify-between">
          Search Radius: <span id="rangeVal" class="text-blue-400 font-bold">1000 m</span>
        </label>
        <input id="radius" type="range" min="200" max="2000" step="100" value="1000" class="w-full appearance-none h-2 bg-gray-700 rounded-lg cursor-pointer">
      </div>
      
      <!-- Toggle Key Button -->
      <button id="toggle-key-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 transition duration-150 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-500/50 hidden disabled:opacity-50" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
        Open Map Key
      </button>
    </div>
  </header>

  <!-- Map and Key Container (Full Screen height minus header) -->
  <div class="flex-grow relative w-full overflow-hidden">
    <!-- Map Container -->
    <div id="map" class="w-full h-full z-10"></div>

    <!-- Sliding Key Panel (Sidebar) -->
    <div id="key-panel" class="absolute top-0 right-0 h-full w-full max-w-sm bg-gray-900/95 backdrop-blur-sm shadow-2xl z-20 flex flex-col p-4 overflow-hidden">
      
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
        <h2 class="text-xl font-bold text-yellow-500">Map Key & Filters</h2>
        <button id="close-key-btn" class="text-gray-400 hover:text-white transition p-1 rounded-full bg-gray-800 hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Marker Visibility Filters -->
      <div id="marker-filters" class="mb-4 p-3 bg-gray-800 rounded-xl shadow-inner">
        <p class="font-semibold mb-2 text-gray-300 border-b border-gray-700 pb-1">Toggle Marker Visibility:</p>
        <div class="flex flex-wrap gap-x-4 gap-y-2">
            <!-- Filter checkboxes will be populated here -->
        </div>
      </div>
      
      <!-- Category Tabs (For List Filtering) -->
      <div id="category-tabs" class="flex flex-wrap gap-2 mb-4 overflow-x-auto whitespace-nowrap hide-scroll">
        <!-- Tabs will be injected here by JS -->
      </div>
      
      <!-- Results List (Scrollable area) -->
      <div id="places-list" class="flex-grow overflow-y-auto space-y-2 pb-4">
        <p class="text-gray-400 text-center p-4">Select filters and locations will appear here.</p>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Global state variables
const map = L.map('map');
const keyPanel = document.getElementById('key-panel');
const toggleKeyBtn = document.getElementById('toggle-key-btn');
const closeKeyBtn = document.getElementById('close-key-btn');

let userMarker = null;
let routeLine = null;
let highlightGroup = []; // Current route and map feature highlights
let markerGroup = L.layerGroup().addTo(map); // Layer group for all POI markers
let categorizedPlaces = {}; // Stores all fetched, processed data, grouped by category
let markerMap = new Map(); // Maps unique ID to Leaflet Marker object
let userLocation = null;
let currentActiveId = null; // ID of the currently selected place

// Define the categories and their friendly names
const CATEGORY_MAP = {
    highway: { label: 'Roads/Transit', icon: 'üõ£Ô∏è' },
    amenity: { label: 'Amenities', icon: 'üìç' },
    shop: { label: 'Shops', icon: 'üõçÔ∏è' },
    leisure: { label: 'Parks/Leisure', icon: 'üèûÔ∏è' },
};

// --- INITIALIZATION ---

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap contributors',
}).addTo(map);

document.getElementById('radius').oninput = e => {
  document.getElementById('rangeVal').textContent = e.target.value + ' m';
};

// Toggle Key Panel Logic
toggleKeyBtn.onclick = () => keyPanel.classList.toggle('open');
closeKeyBtn.onclick = () => keyPanel.classList.remove('open');

// --- UTILITY FUNCTIONS ---

function getDistance(lat1, lon1, lat2, lon2) {
    return L.latLng(lat1, lon1).distanceTo([lat2, lon2]);
}

async function getRoute(lat1, lon1, lat2, lon2) {
  const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
  const r = await fetch(url);
  const d = await r.json();
  if (!d.routes || !d.routes[0]) throw new Error("No driving route found.");
  return d.routes[0].geometry.coordinates.map(([lo, la]) => [la, lo]);
}

function clearRoute() {
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  highlightGroup.forEach(l => map.removeLayer(l));
  highlightGroup = [];
}

/**
 * Generates unique IDs, calculates distance, and assigns category for each element.
 */
function processElements(userLat, userLon, els) {
    const results = {};
    for (const key in CATEGORY_MAP) { results[key] = []; }

    let idCounter = 0;
    els.forEach(e => {
        const id = 'poi-' + idCounter++;
        const lat = e.lat || (e.center && e.center.lat) || (e.geometry && e.geometry[0] && e.geometry[0].lat);
        const lon = e.lon || (e.center && e.center.lon) || (e.geometry && e.geometry[0] && e.geometry[0].lon);

        if (!lat || !lon) return;

        let primaryCat = null;
        for (const cat in CATEGORY_MAP) {
            if (e.tags[cat]) { primaryCat = cat; break; }
        }
        
        if (primaryCat) {
            const placeData = {
                id: id,
                name: e.tags.name,
                distance: getDistance(userLat, userLon, lat, lon),
                category: primaryCat,
                destLat: lat,
                destLon: lon,
                element: e,
            };
            results[primaryCat].push(placeData);
        }
    });

    for (const cat in results) { results[cat].sort((a, b) => a.distance - b.distance); }
    return results;
}

// --- MAP & UI RENDERING ---

/**
 * Renders custom markers for all places and stores them.
 */
function renderMarkers(allPlaces) {
    markerGroup.clearLayers();
    markerMap.clear();

    allPlaces.forEach(place => {
        // Use the simplified, easy-to-render circular icon
        const markerIcon = L.divIcon({
            className: 'custom-pin',
            html: '',
            iconSize: [18, 18], // Adjusted size for the new circle
            iconAnchor: [9, 9], // Center anchor point
            popupAnchor: [0, -10]
        });

        const marker = L.marker([place.destLat, place.destLon], { 
            icon: markerIcon, 
            category: place.category 
        })
            .bindPopup(`<b>${place.name}</b><br>${CATEGORY_MAP[place.category].label}`)
            .addTo(markerGroup);

        marker.on('click', () => {
            handlePlaceSelection(place.id, place);
            keyPanel.classList.add('open'); // Open key when marker is clicked
        });
        
        markerMap.set(place.id, marker);
    });
}

/**
 * Toggles the visibility of markers based on the checked filters in the key panel.
 */
function toggleMarkers() {
    const checkedCategories = new Set();
    document.querySelectorAll('#marker-filters input[type="checkbox"]:checked').forEach(input => {
        checkedCategories.add(input.value);
    });

    markerGroup.clearLayers(); 
    
    // Add markers back if their category is checked
    markerMap.forEach(marker => {
        if (checkedCategories.has(marker.options.category)) {
            marker.addTo(markerGroup);
        }
    });
    
    // Re-render the list based on the new visible categories
    const activeTab = document.querySelector('.tab-btn.bg-blue-500')?.dataset.category || 'all';
    renderList(activeTab);
}

/**
 * Renders the filter checkboxes in the key panel.
 */
function renderFilterCheckboxes(results) {
    const filtersContainer = document.querySelector('#marker-filters .flex');
    filtersContainer.innerHTML = '';
    
    for (const key in CATEGORY_MAP) {
        if (Object.values(results).flat().some(p => p.category === key)) {
            const label = document.createElement('label');
            label.className = 'flex items-center space-x-1 text-sm cursor-pointer hover:text-blue-300 transition';
            label.innerHTML = `
                <input type="checkbox" class="marker-filter h-4 w-4 text-red-500 rounded border-gray-600 bg-gray-900 checked:bg-red-500" value="${key}" checked>
                <span>${CATEGORY_MAP[key].icon} ${CATEGORY_MAP[key].label}</span>
            `;
            filtersContainer.appendChild(label);
            
            label.querySelector('input').addEventListener('change', toggleMarkers);
        }
    }
}

/**
 * Renders the category tabs for list filtering and attaches handlers.
 */
function renderTabs(results) {
    const tabsContainer = document.getElementById('category-tabs');
    tabsContainer.innerHTML = '';
    
    const allPlaces = Object.values(results).flat();
    const categories = [{ key: 'all', label: `All (${allPlaces.length})`, icon: 'üåé' }];
    
    for (const key in results) {
        const count = results[key].length;
        if (count > 0) {
            categories.push({ key: key, label: `${CATEGORY_MAP[key].label} (${count})`, icon: CATEGORY_MAP[key].icon });
        }
    }
    
    categories.forEach(cat => {
        const tabButton = document.createElement('button');
        tabButton.textContent = `${cat.icon} ${cat.label}`;
        tabButton.dataset.category = cat.key;
        tabButton.className = 'tab-btn px-3 py-1.5 text-sm font-semibold rounded-lg transition duration-150 whitespace-nowrap';
        tabButton.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-blue-600', 'hover:text-white');
        
        tabButton.onclick = () => {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            tabButton.classList.add('bg-blue-500', 'text-white');
            tabButton.classList.remove('bg-gray-700', 'text-gray-300');

            renderList(cat.key);
        };
        tabsContainer.appendChild(tabButton);
    });

    if (categories.length > 0) {
        tabsContainer.querySelector('[data-category="all"]').click();
    }
}

/**
 * Renders the results list for the currently selected category, respecting marker visibility.
 */
function renderList(categoryKey) {
    const listContainer = document.getElementById('places-list');
    listContainer.innerHTML = ''; 

    let listItems = [];
    if (categoryKey === 'all') {
        listItems = Object.values(categorizedPlaces).flat();
        listItems.sort((a, b) => a.distance - b.distance);
    } else {
        listItems = categorizedPlaces[categoryKey] || [];
    }
    
    // Filter list items based on current marker visibility (checkbox state)
    const checkedCategories = new Set(
        [...document.querySelectorAll('#marker-filters input[type="checkbox"]:checked')].map(input => input.value)
    );
    
    const visibleItems = listItems.filter(item => checkedCategories.has(item.category));

    if (visibleItems.length === 0) {
        listContainer.innerHTML = `<p class="text-center text-gray-500 p-4">üö´ No visible places in this filter combination.</p>`;
        return;
    }
    
    visibleItems.forEach(item => {
        const distanceKm = (item.distance / 1000).toFixed(2);
        
        const div = document.createElement('div');
        div.className = 'result-item bg-gray-800 p-3 rounded-xl shadow-md border-2 border-transparent hover:border-blue-500 transition cursor-pointer';
        div.dataset.id = item.id;
        
        if (item.id === currentActiveId) {
            div.classList.add('border-blue-500', 'bg-gray-700');
            div.classList.remove('bg-gray-800');
        }

        div.innerHTML = `
            <div class="flex justify-between items-start">
                <span class="font-bold text-white">${item.name}</span>
                <span class="text-sm font-semibold text-blue-400 bg-gray-700 px-2 py-0.5 rounded-full">${distanceKm} km</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">Type: ${item.element.tags[item.category] || 'General POI'}</p>
        `;
        
        div.onclick = () => handlePlaceSelection(item.id, item);
        listContainer.appendChild(div);
    });
}

/**
 * Handles the selection of a place, updating map, list, and drawing route.
 */
async function handlePlaceSelection(id, itemData) {
    if (!userLocation) return;

    currentActiveId = id;

    // 1. Sync Map Markers
    markerMap.forEach((marker, markerId) => {
        const iconElement = marker.getElement().firstChild;
        if (iconElement) {
            iconElement.classList.remove('active');
        }
        if (markerId === id && iconElement) {
            iconElement.classList.add('active');
            marker.openPopup();
            map.panTo(marker.getLatLng()); // Center map on marker
        }
    });
    
    // 2. Sync List Key
    document.querySelectorAll('.result-item').forEach(el => {
        el.classList.remove('border-blue-500', 'bg-gray-700');
        el.classList.add('bg-gray-800');
        
        if (el.dataset.id === id) {
            el.classList.add('border-blue-500', 'bg-gray-700');
            el.classList.remove('bg-gray-800');
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });

    // 3. Draw Route and Feature Highlight
    clearRoute();
    const e = itemData.element;

    if (e.geometry && e.geometry.length && e.geometry[0].lat) { 
        const coords = e.geometry.map(p => [p.lat, p.lon]);
        const l = L.polyline(coords, { color: '#00ccff', weight: 6, opacity: 0.8 }).addTo(map);
        highlightGroup.push(l);
    }

    try {
        const line = await getRoute(userLocation.lat, userLocation.lon, itemData.destLat, itemData.destLon);
        routeLine = L.polyline(line, { color: '#2ecc71', weight: 5, opacity: 0.8, dashArray: '10, 10' }).addTo(map);
        
        const bounds = routeLine.getBounds();
        bounds.extend(userMarker.getLatLng());
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 17 });
    } catch (error) {
        console.error("Routing error:", error.message);
        markerMap.get(id).setPopupContent(`<b>${itemData.name}</b><br>üö´ Route Error: ${error.message}`).openPopup();
    }
}


/**
 * Main function to get user location and search for nearby places.
 */
async function locate() {
  document.getElementById('places-list').innerHTML = '<p class="text-center text-blue-400 animate-pulse p-4">üõ∞Ô∏è Getting your location...</p>';
  document.getElementById('category-tabs').innerHTML = '';
  document.querySelector('#marker-filters .flex').innerHTML = ''; 
  toggleKeyBtn.disabled = true;

  clearRoute(); 
  markerGroup.clearLayers();
  currentActiveId = null;

  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude: lat, longitude: lon } = pos.coords;
    userLocation = { lat, lon };
    map.setView([lat, lon], 15);

    // Update user marker (SIMPLIFIED)
    if (userMarker) map.removeLayer(userMarker);
    const userIcon = L.divIcon({
        className: 'user-marker-icon',
        html: '<div class="w-4 h-4 bg-yellow-400 rounded-full border-2 border-white shadow-xl"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });
    userMarker = L.marker([lat, lon], {icon: userIcon}).addTo(map).bindPopup("Your Current Location").openPopup();

    const cats = ['highway', 'amenity', 'shop', 'leisure']; 
    const dist = document.getElementById('radius').value;
    
    document.getElementById('places-list').innerHTML = '<p class="text-center text-blue-400 animate-pulse p-4">üîç Searching for map pins...</p>';

    const els = await fetch("https://overpass-api.de/api/interpreter?data="+encodeURIComponent(`[out:json][timeout:25];(${cats.map(c=>`node["${c}"](around:${dist},${lat},${lon});way["${c}"](around:${dist},${lat},${lon});`).join('')}node["name"](around:${dist},${lat},${lon});way["name"](around:${dist},${lat},${lon}););out tags center geom;`)).then(r => r.json()).then(d => d.elements.filter(e => e.tags && e.tags.name)).catch(err => {
        document.getElementById('places-list').innerHTML = `<p class="text-red-400 text-center p-4">Network Error: ${err.message}</p>`;
        return [];
    });
    
    categorizedPlaces = processElements(lat, lon, els);
    const allUniquePlaces = Object.values(categorizedPlaces).flat();

    if (allUniquePlaces.length === 0) {
        document.getElementById('places-list').innerHTML = `<p class="text-center text-gray-500 p-4">üö´ No places found. Try increasing the search radius.</p>`;
        toggleKeyBtn.disabled = true;
    } else {
        renderMarkers(allUniquePlaces);
        renderFilterCheckboxes(categorizedPlaces);
        renderTabs(categorizedPlaces);
        toggleKeyBtn.classList.remove('hidden');
        toggleKeyBtn.disabled = false;
        keyPanel.classList.add('open');
    }

  }, err => {
    let message = 'An unknown error occurred.';
    if (err.code === err.PERMISSION_DENIED) { message = 'Location access was denied.'; } 
    else if (err.code === err.POSITION_UNAVAILABLE) { message = 'Location information is unavailable.'; }
    document.getElementById('places-list').innerHTML = `<p class="text-red-400 text-center p-4">üö´ Location Error: ${message}</p>`;
  }, { enableHighAccuracy: true });
}

// Initial Map Load
map.setView([20, 0], 2);
document.getElementById('btn').onclick = locate;
</script>
</body>
</html>

