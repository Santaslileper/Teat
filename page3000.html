<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a1a">
    <title>Pub Seeker Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{overscroll-behavior:none;touch-action:none;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#1a1a1a;color:#e5e5e5;overflow:hidden;}
        .compass-dial{transition:transform .1s cubic-bezier(.4,2.08,.55,.44);will-change:transform;box-shadow:inset 0 0 20px rgba(0,0,0,.5),0 0 10px rgba(0,0,0,.3);}
        .tick{position:absolute;left:50%;top:0;width:2px;height:100%;transform-origin:center}
        .tick::before{content:'';position:absolute;top:10px;left:-1px;width:2px;height:10px;background-color:#4b5563}
        .tick.major::before{height:15px;width:3px;left:-1.5px;background-color:#9ca3af}
        .center-point{box-shadow:0 0 15px rgba(239,68,68,.5)}
        .fade-enter{opacity:0;pointer-events:none;transition:opacity .3s ease}
        .pub-arrow{position:absolute;top:50%;left:50%;transform-origin:center;transition:transform .2s ease-out;z-index:30}
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-start relative bg-neutral-900 p-6">

    <div id="permission-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-neutral-900/95 backdrop-blur-sm p-6 text-center">
        <div class="mb-6 text-neutral-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.727A8 8 0 016.343 5.273M17.657 16.727L12 22 6.343 16.727M12 10a2 2 0 100 4 2 2 0 000-4z" />
            </svg>
            <h2 class="text-2xl font-bold text-white mb-2">Pub Seeker Access</h2>
            <p class="text-sm">We need location and sensor access to find and guide you to the nearest pub.</p>
        </div>
        <button id="start-btn" class="bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-4 px-8 rounded-full shadow-lg transition-transform active:scale-95 text-lg w-full max-w-xs">
            Start Pub Seeker
        </button>
    </div>

    <div class="relative w-full max-w-md flex flex-col items-center justify-start h-full pt-4">
        
        <div class="flex flex-col items-center z-10">
            <div class="text-neutral-500 text-xs font-medium tracking-widest uppercase">Your Heading</div>
            <div class="flex items-baseline">
                <span id="heading-display" class="text-4xl font-bold text-white tabular-nums">0</span>
                <span class="text-lg text-red-500 ml-1">¬∞</span>
            </div>
            <div id="direction-display" class="text-base font-bold text-red-500 tracking-widest">N</div>
        </div>

        <div class="relative w-72 h-72 md:w-80 md:h-80 flex items-center justify-center mb-8">
            
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 z-20">
                <div class="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[20px] border-b-red-600 filter drop-shadow-lg"></div>
            </div>

            <div id="compass-wheel" class="compass-dial w-full h-full rounded-full border-4 border-neutral-800 bg-neutral-900 relative">
                
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="absolute top-8 left-1/2 -translate-x-1/2 text-2xl font-black text-red-500">N</span>
                    <span class="absolute bottom-8 left-1/2 -translate-x-1/2 text-2xl font-bold text-white">S</span>
                    <span class="absolute right-8 top-1/2 -translate-y-1/2 text-2xl font-bold text-white">E</span>
                    <span class="absolute left-8 top-1/2 -translate-y-1/2 text-2xl font-bold text-white">W</span>
                </div>

                <div id="ticks-container" class="absolute inset-0"></div>
                <div class="absolute inset-0 m-auto w-48 h-48 rounded-full border border-neutral-800/50"></div>
            </div>

            <div id="pub-arrow-container" class="pub-arrow w-8 h-8 -mt-4" style="transform: translate(-50%, -50%) rotate(0deg);">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 0 L70 25 L50 40 L30 25 Z" fill="#FFC107"/>
                    <rect x="45" y="40" width="10" height="60" fill="#FFC107"/>
                </svg>
            </div>

            <div class="absolute inset-0 m-auto w-3 h-3 bg-red-600 rounded-full center-point z-20"></div>
        </div>
        
        <div class="w-full flex flex-col items-center p-4 bg-neutral-800 rounded-xl shadow-2xl border border-neutral-700">
            <h2 class="text-xl font-semibold text-neutral-300 mb-2">Target Pub üç∫</h2>
            
            <div id="pub-info-container" class="text-center w-full mb-4">
                <p id="pub-name" class="text-2xl font-bold text-white mb-1 leading-snug h-16 flex items-center justify-center overflow-hidden">Searching...</p>
                <p class="text-lg text-neutral-400">
                    <span id="pub-distance" class="text-yellow-400 font-extrabold">--</span> 
                    <span class="text-neutral-500"> | Bearing: </span>
                    <span id="pub-bearing-display" class="text-yellow-400 font-extrabold">--¬∞</span>
                </p>
                <p id="pub-index-display" class="text-sm text-neutral-500 mt-1 invisible">(1 of 10)</p>
            </div>

            <div class="flex space-x-6">
                 <button id="prev-pub-btn" class="bg-neutral-700 hover:bg-neutral-600 active:bg-neutral-700 text-white p-3 rounded-full disabled:opacity-30 disabled:pointer-events-none transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                    </svg>
                </button>
                <button id="next-pub-btn" class="bg-neutral-700 hover:bg-neutral-600 active:bg-neutral-700 text-white p-3 rounded-full disabled:opacity-30 disabled:pointer-events-none transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 9l3 3m0 0l-3 3m3-3H5m11 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="w-full mt-4 p-3 bg-neutral-800/70 rounded-lg text-center shadow-inner">
            <p id="status-message" class="text-sm text-neutral-400">Tap "Start Pub Seeker" to begin.</p>
        </div>
        
    </div>

    <div id="error-toast" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-900/90 text-red-100 px-4 py-2 rounded-lg text-sm hidden max-w-[90%] text-center">
        Error message
    </div>

    <script>
        // Aliases and short names for DOM elements
        const cw=document.getElementById('compass-wheel'),hd=document.getElementById('heading-display'),dd=document.getElementById('direction-display'),po=document.getElementById('permission-overlay'),sb=document.getElementById('start-btn'),et=document.getElementById('error-toast'),tc=document.getElementById('ticks-container'),sm=document.getElementById('status-message'),pn=document.getElementById('pub-name'),pd=document.getElementById('pub-distance'),pb=document.getElementById('pub-bearing-display'),pa=document.getElementById('pub-arrow-container'),pbv=document.getElementById('prev-pub-btn'),nb=document.getElementById('next-pub-btn'),pi=document.getElementById('pub-index-display');
        // State variables
        let ifn=false,ul=null,uo=null,ps=[],ci=0,ga=0;
        const MG=3,r=32187; // MG: Max Geo attempts, r: Radius in meters (20 miles)
        // Function aliases
        const tr=d=>d*Math.PI/180;
        const cd=(l1,n1,l2,n2)=>{
            const R=6371e3,f1=tr(l1),f2=tr(l2),df=tr(l2-l1),dl=tr(n2-n1);
            const a=Math.sin(df/2)*Math.sin(df/2)+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)*Math.sin(dl/2);
            const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
            return R*c;
        };
        const cb=(l1,n1,l2,n2)=>{
            const f1=tr(l1),f2=tr(l2),L1=tr(n1),L2=tr(n2);
            const y=Math.sin(L2-L1)*Math.cos(f2);
            const x=Math.cos(f1)*Math.sin(f2)-Math.sin(f1)*Math.cos(f2)*Math.cos(L2-L1);
            let b=Math.atan2(y,x)*180/Math.PI;
            return(b+360)%360;
        };
        const se=m=>{et.textContent=m;et.classList.remove('hidden');setTimeout(()=>et.classList.add('hidden'),5000);console.error(m);};
        const ss=m=>{sm.textContent=m;};
        const fd=m=>m<1000?`${Math.round(m)} m`:`${(m/1000).toFixed(1)} km`;
        const gcd=h=>{
            const d=['N','NE','E','SE','S','SW','W','NW'];
            const i=Math.round(((h%=360)<0?h+360:h)/45)%8;
            return d[i];
        };
        const gt=()=>{
            for(let i=0;i<360;i+=2){
                const t=document.createElement('div');
                let c=i%30===0?'tick major':i%10===0?'tick':'';
                if(c){
                    t.className=c;
                    t.style.transform=`rotate(${i}deg)`;
                    if(i%30===0 && (i%90!==0)){
                        const l=document.createElement('span');
                        l.textContent=i;
                        l.style.cssText=`font-size:10px;color:#9ca3af;position:absolute;top:20px;left:50%;transform:translateX(-50%) rotate(${-i}deg);`;
                        t.appendChild(l);
                    }
                    tc.appendChild(t);
                }
            }
        };
        gt();
        const hh=h=>{
            const iN=h>357||h<3;
            if(iN&&!ifn){
                if(navigator.vibrate){navigator.vibrate(50);}
                document.querySelector('.center-point').style.boxShadow='0 0 25px rgba(239,68,68,.9)';
                ifn=true;
            }else if(!iN&&ifn){
                document.querySelector('.center-point').style.boxShadow='0 0 15px rgba(239,68,68,.5)';
                ifn=false;
            }
        };
        const ui=()=>{
            if(ps.length===0){
                pn.textContent="No Pubs Found üòî";pd.textContent="--";pb.textContent="--¬∞";pi.classList.add('invisible');pa.style.opacity=0;pbv.disabled=true;nb.disabled=true;return;
            }
            const cP=ps[ci];
            const n=cP.tags.name||'Unnamed Pub/Bar';
            const d=cd(ul,uo,cP.lat,cP.lon);
            const b=cb(ul,uo,cP.lat,cP.lon);
            pn.textContent=n;pd.textContent=fd(d);pb.textContent=`${Math.round(b)}¬∞ ${gcd(b)}`;
            pi.textContent=`(${ci+1} of ${ps.length})`;pi.classList.remove('invisible');pa.style.opacity=1;
            const mP=ps.length>1;
            pbv.disabled=!mP||ci===0;
            nb.disabled=!mP||ci===ps.length-1;
            const cH=parseFloat(hd.textContent)||0; 
            uu(cH,0);
        };
        const cp=d=>{
            const nI=ci+d;
            if(nI>=0&&nI<ps.length){
                ci=nI;
                ui();
                ss(`Switched to: ${ps[ci].tags.name||'Unnamed Pub'}`);
            }
        };
        pbv.addEventListener('click',()=>cp(-1));
        nb.addEventListener('click',()=>cp(1));
        const uu=(h,t=0)=>{
            cw.style.transform=`rotate(${-h}deg)`;
            const rH=Math.round(h);
            hd.textContent=rH;
            dd.textContent=gcd(rH);
            if(ps.length>0){
                const tP=ps[ci];
                const pB=cb(ul,uo,tP.lat,tP.lon);
                let rB=pB-h;
                if(rB>180)rB-=360;
                if(rB<-180)rB+=360;
                pa.style.transform=`translate(-50%, -50%) rotate(${rB}deg)`;
            }
            hh(h);
        };
        const ho=e=>{
            let h=e.webkitCompassHeading||(e.alpha!==null?360-e.alpha:null);
            if(h===null)return;
            h=(h%360+360)%360;
            requestAnimationFrame(()=>uu(h,e.gamma||0));
        };
        const sc=()=>{
            if(typeof DeviceOrientationEvent!=='undefined'){
                const eA='ondeviceorientationabsolute' in window?'deviceorientationabsolute':'ondeviceorientation' in window?'deviceorientation':null;
                if(eA){window.addEventListener(eA,ho,true);}else{console.log('Compass sensors not available.');}
            }else{console.log('Device orientation events not supported.');}
        };
        const sf=()=>{
            if(ul===null||uo===null){se("Location not available for search.");return;}
            ss(`Searching for pubs within ${Math.round(r/1609.34)} miles...`);
            const q=`[out:json][timeout:15];(node["amenity"~"pub|bar"](around:${r},${ul},${uo}););out center 25;`;
            const u=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(q)}`;
            fetch(u).then(res=>{if(!res.ok)throw new Error('API error');return res.json();})
                .then(d=>{
                    if(!d.elements||d.elements.length===0){
                        ps=[];ci=0;ui();ss('No pubs found nearby! Try moving to a new area.');return;
                    }
                    d.elements.forEach(e=>{if(e.type==='node'){e.distance=cd(ul,uo,e.lat,e.lon);}});
                    ps=d.elements.filter(e=>e.type==='node').sort((a,b)=>a.distance-b.distance);
                    ci=0;
                    ui();
                    ss(`Found ${ps.length} pubs! Now guiding you to the closest one.`);
                })
                .catch(e=>{
                    console.error('Error fetching pubs:',e);
                    ss('Failed to load local pub data. (API Error)');
                    ps=[];ci=0;ui();
                });
        };
        const hgs=p=>{
            ga=0;
            ul=p.coords.latitude;
            uo=p.coords.longitude;
            ss(`Location found. Now searching for pubs...`);
            sf();
        };
        const hge=e=>{
            let m='';
            switch(e.code){
                case e.PERMISSION_DENIED:m="Location permission denied. Cannot find pubs.";se(m);ss('Location access denied. Please refresh and try again.');return;
                case e.POSITION_UNAVAILABLE:m="Location information unavailable.";break;
                case e.TIMEOUT:m="Location request timed out.";break;
                default:m="Unknown location error occurred.";
            }
            ga++;
            ss(`Location error. Retrying... (${ga}/${MG})`);
            if(ga<MG){setTimeout(()=>gg(),2000);}else{se(`Failed to get location. Check device settings.`);ss('Could not get location. Check device settings.');}
        };
        const gg=()=>{
            if(ga===0){ss('Waiting for location data...');}
            if(!navigator.geolocation){se('Geolocation is not supported');ss('Geolocation not available');return;}
            navigator.geolocation.getCurrentPosition(hgs,hge,{enableHighAccuracy:true,timeout:15000,maximumAge:0});
        };
        const rp=()=>{
            po.classList.add('fade-enter');
            ss('Requesting sensor and location permissions...');
            const p=()=>{sc();ga=0;gg();};
            if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
                DeviceOrientationEvent.requestPermission().then(r=>{
                    if(r==='denied'){se('Sensor permission denied. Compass will not function.');}
                    p();
                }).catch(e=>{console.error("Permission failed:",e);se('Error requesting sensor access. Proceeding with location.');p();});
            }else{p();}
        };
        sb.addEventListener('click',rp);
    </script>
</body>
</html>

