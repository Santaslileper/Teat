<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a1a">
    <title>Pub Seeker Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Styles */
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            overflow: hidden; /* Lock the viewport */
        }

        /* Compass Dial Styling (for North.html visual style) */
        .compass-dial {
            transition: transform 0.1s cubic-bezier(0.4, 2.08, 0.55, 0.44);
            will-change: transform;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.5),
                0 0 10px rgba(0,0,0,0.3);
        }

        /* Tick Marks */
        .tick {
            position: absolute;
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            transform-origin: center;
        }
        .tick::before {
            content: '';
            position: absolute;
            top: 10px;
            left: -1px;
            width: 2px;
            height: 10px;
            background-color: #4b5563;
        }
        .tick.major::before {
            height: 15px;
            width: 3px;
            left: -1.5px;
            background-color: #9ca3af;
        }

        .center-point {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        
        .fade-enter {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        /* Pub Arrow styling for better visibility on the dial */
        .pub-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center;
            transition: transform 0.2s ease-out; /* Smooth rotation */
            z-index: 30;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-start relative bg-neutral-900 p-6">

    <div id="permission-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-neutral-900/95 backdrop-blur-sm p-6 text-center">
        <div class="mb-6 text-neutral-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.727A8 8 0 016.343 5.273M17.657 16.727L12 22 6.343 16.727M12 10a2 2 0 100 4 2 2 0 000-4z" />
            </svg>
            <h2 class="text-2xl font-bold text-white mb-2">Pub Seeker Access</h2>
            <p class="text-sm">We need location and sensor access to find and guide you to the nearest pub.</p>
        </div>
        <button id="start-btn" class="bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-semibold py-4 px-8 rounded-full shadow-lg transition-transform active:scale-95 text-lg w-full max-w-xs">
            Start Pub Seeker
        </button>
    </div>

    <div class="relative w-full max-w-md flex flex-col items-center justify-start h-full pt-4">
        
        <div class="flex flex-col items-center z-10 mb-4">
            <div class="text-neutral-500 text-sm font-medium tracking-widest uppercase mb-1">Your Heading</div>
            <div class="flex items-baseline">
                <span id="heading-display" class="text-6xl font-bold text-white tabular-nums">0</span>
                <span class="text-2xl text-red-500 ml-1">掳</span>
            </div>
            <div id="direction-display" class="text-xl font-bold text-red-500 mt-1 tracking-widest">N</div>
        </div>

        <div class="relative w-72 h-72 md:w-80 md:h-80 flex items-center justify-center mb-8">
            
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 z-20">
                <div class="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[20px] border-b-red-600 filter drop-shadow-lg"></div>
            </div>

            <div id="compass-wheel" class="compass-dial w-full h-full rounded-full border-4 border-neutral-800 bg-neutral-900 relative">
                
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="absolute top-8 left-1/2 -translate-x-1/2 text-2xl font-black text-red-500">N</span>
                    <span class="absolute bottom-8 left-1/2 -translate-x-1/2 text-2xl font-bold text-white">S</span>
                    <span class="absolute right-8 top-1/2 -translate-y-1/2 text-2xl font-bold text-white">E</span>
                    <span class="absolute left-8 top-1/2 -translate-y-1/2 text-2xl font-bold text-white">W</span>
                </div>

                <div id="ticks-container" class="absolute inset-0"></div>

                <div class="absolute inset-0 m-auto w-48 h-48 rounded-full border border-neutral-800/50"></div>
            </div>

            <div id="pub-arrow-container" class="pub-arrow w-8 h-8 -mt-4" style="transform: translate(-50%, -50%) rotate(0deg);">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 0 L70 25 L50 40 L30 25 Z" fill="#FFC107"/>
                    <rect x="45" y="40" width="10" height="60" fill="#FFC107"/>
                </svg>
            </div>


            <div class="absolute inset-0 m-auto w-3 h-3 bg-red-600 rounded-full center-point z-20"></div>
        </div>
        
        <div class="w-full flex flex-col items-center p-4 bg-neutral-800 rounded-xl shadow-2xl border border-neutral-700">
            <h2 class="text-xl font-semibold text-neutral-300 mb-2">Target Pub </h2>
            
            <div id="pub-info-container" class="text-center w-full mb-4">
                <p id="pub-name" class="text-2xl font-bold text-white mb-1 leading-snug h-16 flex items-center justify-center overflow-hidden">Searching...</p>
                <p class="text-lg text-neutral-400">
                    <span id="pub-distance" class="text-yellow-400 font-extrabold">--</span> 
                    <span class="text-neutral-500"> | Bearing: </span>
                    <span id="pub-bearing-display" class="text-yellow-400 font-extrabold">--掳</span>
                </p>
                <p id="pub-index-display" class="text-sm text-neutral-500 mt-1 invisible">(1 of 10)</p>
            </div>

            <div class="flex space-x-6">
                 <button id="prev-pub-btn" class="bg-neutral-700 hover:bg-neutral-600 active:bg-neutral-700 text-white p-3 rounded-full disabled:opacity-30 disabled:pointer-events-none transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                    </svg>
                </button>
                <button id="next-pub-btn" class="bg-neutral-700 hover:bg-neutral-600 active:bg-neutral-700 text-white p-3 rounded-full disabled:opacity-30 disabled:pointer-events-none transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 9l3 3m0 0l-3 3m3-3H5m11 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="w-full mt-4 p-3 bg-neutral-800/70 rounded-lg text-center shadow-inner">
            <p id="status-message" class="text-sm text-neutral-400">Tap "Start Pub Seeker" to begin.</p>
        </div>
        
    </div>

    <div id="error-toast" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-900/90 text-red-100 px-4 py-2 rounded-lg text-sm hidden max-w-[90%] text-center">
        Error message
    </div>

    <script>
        // --- DOM Elements & Constants ---
        const compassWheel = document.getElementById('compass-wheel');
        const headingDisplay = document.getElementById('heading-display');
        const directionDisplay = document.getElementById('direction-display');
        const permissionOverlay = document.getElementById('permission-overlay');
        const startBtn = document.getElementById('start-btn');
        const errorToast = document.getElementById('error-toast');
        const ticksContainer = document.getElementById('ticks-container');
        const statusMessage = document.getElementById('status-message');
        
        const pubNameDisplay = document.getElementById('pub-name');
        const pubDistanceDisplay = document.getElementById('pub-distance');
        const pubBearingDisplay = document.getElementById('pub-bearing-display');
        const pubArrowContainer = document.getElementById('pub-arrow-container');
        const prevPubBtn = document.getElementById('prev-pub-btn');
        const nextPubBtn = document.getElementById('next-pub-btn');
        const pubIndexDisplay = document.getElementById('pub-index-display');


        // --- State Variables ---
        let isFacingNorth = false;
        let userLat = null;
        let userLon = null;
        let allNearbyPubs = []; // Array to hold all found pubs
        let currentPubIndex = 0;
        let geolocationAttempts = 0;
        const MAX_GEOLOCATION_ATTEMPTS = 3;
        // Search radius: 20 miles = 32,187 meters (Confirmed as per request)
        const PUB_SEARCH_RADIUS = 32187; 


        // --- Utility Functions (Geospatial) ---

        function toRad(degrees) { return degrees * Math.PI / 180; }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const 1 = toRad(lat1);
            const 2 = toRad(lat2);
            const  = toRad(lat2 - lat1);
            const 位 = toRad(lon2 - lon1);

            const a = Math.sin( / 2) * Math.sin( / 2) +
                      Math.cos(1) * Math.cos(2) *
                      Math.sin(位 / 2) * Math.sin(位 / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; 
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const 1 = toRad(lat1);
            const 2 = toRad(lat2);
            const 位1 = toRad(lon1);
            const 位2 = toRad(lon2);

            const y = Math.sin(位2 - 位1) * Math.cos(2);
            const x = Math.cos(1) * Math.sin(2) -
                      Math.sin(1) * Math.cos(2) * Math.cos(位2 - 位1);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            
            return (bearing + 360) % 360; 
        }

        // --- Utility Functions (UI/Status) ---

        function showError(msg) {
            errorToast.textContent = msg;
            errorToast.classList.remove('hidden');
            setTimeout(() => errorToast.classList.add('hidden'), 5000); 
            console.error(msg);
        }

        function showStatus(msg) {
            statusMessage.textContent = msg;
        }

        function formatDistance(meters) {
            if (meters < 1000) {
                return `${Math.round(meters)} m`;
            } else {
                return `${(meters / 1000).toFixed(1)} km`;
            }
        }

        function getCardinalDirection(heading) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(((heading %= 360) < 0 ? heading + 360 : heading) / 45) % 8;
            return directions[index];
        }

        // Generate ticks dynamically
        function generateTicks() {
            for (let i = 0; i < 360; i += 2) {
                if (i % 30 === 0) { 
                    const tick = document.createElement('div');
                    tick.className = `tick major`;
                    tick.style.transform = `rotate(${i}deg)`;
                    ticksContainer.appendChild(tick);
                } else if (i % 10 === 0) { 
                    const tick = document.createElement('div');
                    tick.className = 'tick';
                    tick.style.transform = `rotate(${i}deg)`;
                    ticksContainer.appendChild(tick);
                }
            }
        }
        generateTicks();

        // Haptic Feedback Logic
        function handleHaptics(heading) {
            const isNorth = heading > 357 || heading < 3;
            if (isNorth && !isFacingNorth) {
                if (navigator.vibrate) {
                    navigator.vibrate(50); 
                }
                document.querySelector('.center-point').style.boxShadow = '0 0 25px rgba(239, 68, 68, 0.9)';
                isFacingNorth = true;
            } else if (!isNorth && isFacingNorth) {
                document.querySelector('.center-point').style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.5)';
                isFacingNorth = false;
            }
        }

        // --- Pub Navigation Logic ---
        
        function updatePubUI() {
            if (allNearbyPubs.length === 0) {
                pubNameDisplay.textContent = "No Pubs Found ";
                pubDistanceDisplay.textContent = "--";
                pubBearingDisplay.textContent = "--掳";
                pubIndexDisplay.classList.add('invisible');
                pubArrowContainer.style.opacity = 0;
                prevPubBtn.disabled = true;
                nextPubBtn.disabled = true;
                return;
            }

            const currentPub = allNearbyPubs[currentPubIndex];
            const name = currentPub.tags.name || 'Unnamed Pub/Bar';
            const distance = calculateDistance(userLat, userLon, currentPub.lat, currentPub.lon);
            const bearing = calculateBearing(userLat, userLon, currentPub.lat, currentPub.lon);
            
            pubNameDisplay.textContent = name;
            pubDistanceDisplay.textContent = formatDistance(distance);
            pubBearingDisplay.textContent = `${Math.round(bearing)}掳 ${getCardinalDirection(bearing)}`;
            pubIndexDisplay.textContent = `(${currentPubIndex + 1} of ${allNearbyPubs.length})`;
            pubIndexDisplay.classList.remove('invisible');
            pubArrowContainer.style.opacity = 1;

            // Update button states: Enable if more than one pub exists, disable if at the start/end
            const multiplePubs = allNearbyPubs.length > 1;
            prevPubBtn.disabled = !multiplePubs || currentPubIndex === 0;
            nextPubBtn.disabled = !multiplePubs || currentPubIndex === allNearbyPubs.length - 1;
            
            // Force compass arrow to update
            const currentHeading = parseFloat(headingDisplay.textContent) || 0; 
            updateUI(currentHeading, 0); 
        }

        function cyclePub(direction) {
            const newIndex = currentPubIndex + direction;
            if (newIndex >= 0 && newIndex < allNearbyPubs.length) {
                currentPubIndex = newIndex;
                updatePubUI();
                showStatus(`Switched to: ${allNearbyPubs[currentPubIndex].tags.name || 'Unnamed Pub'}`);
            }
        }

        prevPubBtn.addEventListener('click', () => cyclePub(-1));
        nextPubBtn.addEventListener('click', () => cyclePub(1));


        // --- Main Compass UI Update (Merged) ---

        function updateUI(heading, tiltX = 0) {
            // 1. Update the Main Compass Dial 
            compassWheel.style.transform = `rotate(${-heading}deg)`;
            
            // 2. Update Text Readouts
            const roundedHeading = Math.round(heading);
            headingDisplay.textContent = roundedHeading;
            directionDisplay.textContent = getCardinalDirection(roundedHeading);

            // 3. Update Pub Direction Arrow
            if (allNearbyPubs.length > 0) {
                const targetPub = allNearbyPubs[currentPubIndex];
                const pubBearing = calculateBearing(userLat, userLon, targetPub.lat, targetPub.lon);

                let relativeBearing = pubBearing - heading;
                
                // Normalize relative bearing to -180 to 180 
                if (relativeBearing > 180) relativeBearing -= 360;
                if (relativeBearing < -180) relativeBearing += 360;

                pubArrowContainer.style.transform = `translate(-50%, -50%) rotate(${relativeBearing}deg)`;
            }

            // 4. Haptic Feedback for North
            handleHaptics(heading);
        }

        // --- Sensor Handlers ---

        function handleOrientation(event) {
            let heading = 0;

            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } 
            else if (event.alpha !== null) {
                heading = 360 - event.alpha;
            } else {
                return; 
            }

            heading = (heading % 360 + 360) % 360;

            const tilt = event.gamma || 0; 

            requestAnimationFrame(() => updateUI(heading, tilt));
        }

        function startCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined') {
                if ('ondeviceorientationabsolute' in window) {
                    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                } else if ('ondeviceorientation' in window) {
                    window.addEventListener('deviceorientation', handleOrientation, true);
                } else {
                    console.log('Compass sensors are not available on this device.');
                }
            } else {
                 console.log('Device orientation events not supported.');
            }
        }
        
        // --- Pub Search Logic ---

        function searchForPubs() {
            if (userLat === null || userLon === null) {
                showError("User location not available for pub search.");
                return;
            }

            showStatus(`Searching for pubs within ${Math.round(PUB_SEARCH_RADIUS/1609.34)} miles...`);
            
            // Query for up to 25 pubs/bars within the radius
            const query = `
                [out:json][timeout:15];
                (
                  node["amenity"~"pub|bar"](around:${PUB_SEARCH_RADIUS},${userLat},${userLon});
                );
                out center 25;
            `;

            const overpassUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            fetch(overpassUrl)
                .then(response => {
                    if (!response.ok) throw new Error('Overpass API network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (!data.elements || data.elements.length === 0) {
                        allNearbyPubs = [];
                        currentPubIndex = 0;
                        updatePubUI();
                        showStatus('No pubs found nearby! Try moving to a new area.');
                        return;
                    }

                    // 1. Calculate distance for all found elements
                    data.elements.forEach(element => {
                        if (element.type === 'node') {
                            element.distance = calculateDistance(userLat, userLon, element.lat, element.lon);
                        }
                    });

                    // 2. Filter out non-nodes and SORT by DISTANCE (Closest First)
                    allNearbyPubs = data.elements
                        .filter(e => e.type === 'node')
                        .sort((a, b) => a.distance - b.distance);
                    
                    currentPubIndex = 0; // Always start at the closest pub
                    updatePubUI();
                    showStatus(`Found ${allNearbyPubs.length} pubs! Now guiding you to the closest one.`);
                })
                .catch(error => {
                    console.error('Error fetching pubs:', error);
                    showStatus('Failed to load local pub data. (API Error)');
                    allNearbyPubs = [];
                    currentPubIndex = 0;
                    updatePubUI();
                });
        }


        // --- Geolocation Logic ---

        function handleGeolocationSuccess(position) {
            geolocationAttempts = 0; 
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            showStatus(`Location found. Now searching for pubs...`);
            searchForPubs(); 
        }

        function handleGeolocationError(error) {
            let errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = "Location permission denied. Cannot find pubs.";
                    showError(errorMsg);
                    showStatus('Location access denied. Please refresh and try again.');
                    return; 
                case error.POSITION_UNAVAILABLE:
                    errorMsg = "Location information unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMsg = "Location request timed out.";
                    break;
                default:
                    errorMsg = "Unknown location error occurred.";
            }
            
            geolocationAttempts++;
            showStatus(`Location error. Retrying... (${geolocationAttempts}/${MAX_GEOLOCATION_ATTEMPTS})`);

            if (geolocationAttempts < MAX_GEOLOCATION_ATTEMPTS) {
                setTimeout(() => getGeolocation(), 2000); 
            } else {
                showError(`Failed to get location. Check device settings.`);
                showStatus('Could not get location. Check device settings.');
            }
        }
        
        function getGeolocation() {
            if (geolocationAttempts === 0) {
                showStatus('Waiting for location data...');
            }
            
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser');
                showStatus('Geolocation not available');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                handleGeolocationSuccess, 
                handleGeolocationError, 
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 } 
            );
        }

        // --- Core Startup Logic ---

        function requestPermissions() {
            // Fades out the overlay and removes pointer events
            permissionOverlay.classList.add('fade-enter'); 
            showStatus('Requesting sensor and location permissions...');


            const proceed = () => {
                startCompass();
                geolocationAttempts = 0; 
                getGeolocation(); 
            };

            // Handle explicit Compass Permission request (iOS 13+ requirement)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'denied') {
                            showError('Sensor permission denied. Compass heading will not function.');
                        }
                        proceed();
                    })
                    .catch(e => {
                        console.error("Permission request failed:", e);
                        showError('Error requesting sensor access. Proceeding with location.');
                        proceed();
                    });
            } else {
                // Fallback for Android/older devices
                proceed();
            }
        }

        // Init
        startBtn.addEventListener('click', requestPermissions);
    </script>
</body>
</html>
