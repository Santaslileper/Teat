<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>P2P Chat â€“ Scan to Connect</title>
<style>
  :root{
    --bg:#0a0e1a;
    --surface:#111827;
    --surface-hover:#1f2937;
    --border:#374151;
    --text:#f9fafb;
    --text-muted:#9ca3af;
    --accent:#06b6d4;
    --accent-hover:#0891b2;
    --success:#10b981;
    --warning:#f59e0b;
  }

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(â€“bg);color:var(â€“text);font-family:-apple-system,BlinkMacSystemFont,â€˜Segoe UIâ€™,Roboto,sans-serif;overflow:hidden}

.app{height:100dvh;display:flex;flex-direction:column;max-width:600px;margin:0 auto;padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom);gap:12px}

header{text-align:center;padding:16px 0}
h1{font-size:1.5rem;margin:0;font-weight:700;background:linear-gradient(135deg,#06b6d4,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.status{font-size:0.875rem;color:var(â€“text-muted);margin-top:4px;display:flex;align-items:center;justify-content:center;gap:6px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(â€“text-muted);animation:pulse 2s ease-in-out infinite}
.status-dot.connected{background:var(â€“success);animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

.qr-section{background:var(â€“surface);border-radius:16px;padding:20px;text-align:center;border:1px solid var(â€“border)}
.qr-section.hidden{display:none}
#qrCanvas{margin:16px auto;background:#fff;padding:16px;border-radius:12px;display:inline-block}

.action-buttons{display:flex;gap:8px;margin-top:12px}
.action-buttons button{flex:1}

button{
background:var(â€“surface);
border:1px solid var(â€“border);
color:var(â€“text);
padding:12px 20px;
border-radius:12px;
font-size:0.9375rem;
font-weight:500;
cursor:pointer;
transition:all 0.2s;
min-height:48px;
display:flex;
align-items:center;
justify-content:center;
gap:8px
}
button:hover{background:var(â€“surface-hover);transform:translateY(-1px)}
button:active{transform:translateY(0)}
button.primary{background:var(â€“accent);border-color:var(â€“accent);color:#fff}
button.primary:hover{background:var(â€“accent-hover)}
button:disabled{opacity:0.5;cursor:not-allowed;transform:none}

.messages{
flex:1;
background:var(â€“surface);
border-radius:16px;
border:1px solid var(â€“border);
overflow-y:auto;
padding:16px;
display:flex;
flex-direction:column;
gap:12px;
-webkit-overflow-scrolling:touch
}

.message{
max-width:80%;
padding:10px 14px;
border-radius:12px;
font-size:0.9375rem;
line-height:1.5;
word-wrap:break-word
}
.message.system{
background:rgba(156,163,175,0.1);
color:var(â€“text-muted);
align-self:center;
max-width:90%;
text-align:center;
font-size:0.875rem;
padding:8px 12px
}
.message.sent{
background:var(â€“accent);
color:#fff;
align-self:flex-end;
border-bottom-right-radius:4px
}
.message.received{
background:var(â€“surface-hover);
align-self:flex-start;
border-bottom-left-radius:4px
}

.input-area{
display:flex;
gap:8px;
padding:12px;
background:var(â€“surface);
border-radius:16px;
border:1px solid var(â€“border)
}
input{
flex:1;
background:transparent;
border:none;
outline:none;
color:var(â€“text);
font-size:1rem;
padding:8px
}
input::placeholder{color:var(â€“text-muted)}

.instructions{
background:rgba(6,182,212,0.1);
border:1px solid rgba(6,182,212,0.2);
border-radius:12px;
padding:12px 16px;
font-size:0.875rem;
color:var(â€“text-muted);
line-height:1.5
}

.link{
color:var(â€“accent);
word-break:break-all;
text-decoration:none;
font-size:0.75rem;
display:block;
margin-top:8px
}
</style>

</head>
<body>
<div class="app">
  <header>
    <h1>ðŸ”’ P2P Secure Chat</h1>
    <div class="status">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Disconnected</span>
    </div>
  </header>

  <div class="qr-section hidden" id="qrSection">
    <div id="qrCanvas"></div>
    <div class="action-buttons">
      <button id="copyBtn">ðŸ“‹ Copy Link</button>
      <button id="hideQrBtn">âœ• Hide</button>
    </div>
    <a class="link" id="joinLink" href="#" target="_blank"></a>
  </div>

  <button class="primary" id="startBtn">
    ðŸš€ Start New Chat Room
  </button>

  <div class="instructions" id="instructions">
    **Step 1:** Click "Start New Chat Room" to create a room. **Step 2:** Share the first QR code with a peer. **Step 3:** The peer will generate a second QR code. Scan that to connect!
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="msgInput" placeholder="Type your message..." disabled />
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// ==========================================================
// RTC SIGNALING UTILITIES
// ==========================================================
const encodeSDP = sdp => encodeURIComponent(btoa(unescape(encodeURIComponent(sdp))));
const decodeSDP = str => {
  try { return decodeURIComponent(escape(atob(decodeURIComponent(str)))); }
  catch(e){ return null; }
};

// ==========================================================
// DOM ELEMENTS & STATE
// ==========================================================
const els = {
  statusDot: document.getElementById('statusDot'),
  statusText: document.getElementById('statusText'),
  qrSection: document.getElementById('qrSection'),
  qrCanvas: document.getElementById('qrCanvas'),
  copyBtn: document.getElementById('copyBtn'),
  hideQrBtn: document.getElementById('hideQrBtn'),
  joinLink: document.getElementById('joinLink'),
  startBtn: document.getElementById('startBtn'),
  instructions: document.getElementById('instructions'),
  messages: document.getElementById('messages'),
  msgInput: document.getElementById('msgInput'),
  sendBtn: document.getElementById('sendBtn')
};

let pc = null;
let dataChannel = null;

// ==========================================================
// **MAXIMUM STUN SERVER CONFIGURATION**
// This list is designed to maximize connection success rates.
// ==========================================================
const MAX_ICE_SERVERS = [
    // --- STUN Servers from User List ---
    { urls: 'stun:iphone-stun.strato-iphone.de:3478' },
    { urls: 'stun:numb.viagenie.ca:3478' },
    { urls: 'stun:s1.taraba.net:3478' },
    { urls: 'stun:s2.taraba.net:3478' },
    { urls: 'stun:stun.12connect.com:3478' },
    { urls: 'stun:stun.12voip.com:3478' },
    { urls: 'stun:stun.1und1.de:3478' },
    { urls: 'stun:stun.2talk.co.nz:3478' },
    { urls: 'stun:stun.2talk.com:3478' },
    { urls: 'stun:stun.3clogic.com:3478' },
    { urls: 'stun:stun.3cx.com:3478' },
    { urls: 'stun:stun.a-mm.tv:3478' },
    { urls: 'stun:stun.aa.net.uk:3478' },
    { urls: 'stun:stun.acrobits.cz:3478' },
    { urls: 'stun:stun.actionvoip.com:3478' },
    { urls: 'stun:stun.advfn.com:3478' },
    { urls: 'stun:stun.aeta-audio.com:3478' },
    { urls: 'stun:stun.aeta.com:3478' },
    { urls: 'stun:stun.alltel.com.au:3478' },
    { urls: 'stun:stun.altar.com.pl:3478' },
    { urls: 'stun:stun.annatel.net:3478' },
    { urls: 'stun:stun.antisip.com:3478' },
    { urls: 'stun:stun.arbuz.ru:3478' },
    { urls: 'stun:stun.avigora.com:3478' },
    { urls: 'stun:stun.avigora.fr:3478' },
    { urls: 'stun:stun.awa-shima.com:3478' },
    { urls: 'stun:stun.awt.be:3478' },
    { urls: 'stun:stun.b2b2c.ca:3478' },
    { urls: 'stun:stun.bahnhof.net:3478' },
    { urls: 'stun:stun.barracuda.com:3478' },
    { urls: 'stun:stun.bluesip.net:3478' },
    { urls: 'stun:stun.bmwgs.cz:3478' },
    { urls: 'stun:stun.botonakis.com:3478' },
    { urls: 'stun:stun.budgetphone.nl:3478' },
    { urls: 'stun:stun.budgetsip.com:3478' },
    { urls: 'stun:stun.cablenet-as.net:3478' },
    { urls: 'stun:stun.callromania.ro:3478' },
    { urls: 'stun:stun.callwithus.com:3478' },
    { urls: 'stun:stun.cbsys.net:3478' },
    { urls: 'stun:stun.chathelp.ru:3478' },
    { urls: 'stun:stun.cheapvoip.com:3478' },
    { urls: 'stun:stun.ciktel.com:3478' },
    { urls: 'stun:stun.cloopen.com:3478' },
    { urls: 'stun:stun.colouredlines.com.au:3478' },
    { urls: 'stun:stun.comfi.com:3478' },
    { urls: 'stun:stun.commpeak.com:3478' },
    { urls: 'stun:stun.comtube.com:3478' },
    { urls: 'stun:stun.comtube.ru:3478' },
    { urls: 'stun:stun.cope.es:3478' },
    { urls: 'stun:stun.counterpath.com:3478' },
    { urls: 'stun:stun.counterpath.net:3478' },
    { urls: 'stun:stun.cryptonit.net:3478' },
    { urls: 'stun:stun.darioflaccovio.it:3478' },
    { urls: 'stun:stun.datamanagement.it:3478' },
    { urls: 'stun:stun.dcalling.de:3478' },
    { urls: 'stun:stun.decanet.fr:3478' },
    { urls: 'stun:stun.demos.ru:3478' },
    { urls: 'stun:stun.develz.org:3478' },
    { urls: 'stun:stun.dingaling.ca:3478' },
    { urls: 'stun:stun.doublerobotics.com:3478' },
    { urls: 'stun:stun.drogon.net:3478' },
    { urls: 'stun:stun.duocom.es:3478' },
    { urls: 'stun:stun.dus.net:3478' },
    { urls: 'stun:stun.e-fon.ch:3478' },
    { urls: 'stun:stun.easybell.de:3478' },
    { urls: 'stun:stun.easycall.pl:3478' },
    { urls: 'stun:stun.easyvoip.com:3478' },
    { urls: 'stun:stun.efficace-factory.com:3478' },
    { urls: 'stun:stun.einsundeins.com:3478' },
    { urls: 'stun:stun.einsundeins.de:3478' },
    { urls: 'stun:stun.ekiga.net:3478' },
    { urls: 'stun:stun.epygi.com:3478' },
    { urls: 'stun:stun.etoilediese.fr:3478' },
    { urls: 'stun:stun.eyeball.com:3478' },
    { urls: 'stun:stun.faktortel.com.au:3478' },
    { urls: 'stun:stun.freecall.com:3478' },
    { urls: 'stun:stun.freeswitch.org:3478' },
    { urls: 'stun:stun.freevoipdeal.com:3478' },
    { urls: 'stun:stun.fuzemeeting.com:3478' },
    { urls: 'stun:stun.gmx.de:3478' },
    { urls: 'stun:stun.gmx.net:3478' },
    { urls: 'stun:stun.gradwell.com:3478' },
    { urls: 'stun:stun.halonet.pl:3478' },
    { urls: 'stun:stun.hellonanu.com:3478' },
    { urls: 'stun:stun.hoiio.com:3478' },
    { urls: 'stun:stun.hosteurope.de:3478' },
    { urls: 'stun:stun.ideasip.com:3478' },
    { urls: 'stun:stun.imesh.com:3478' },
    { urls: 'stun:stun.infra.net:3478' },
    { urls: 'stun:stun.internetcalls.com:3478' },
    { urls: 'stun:stun.intervoip.com:3478' },
    { urls: 'stun:stun.ipcomms.net:3478' },
    { urls: 'stun:stun.ipfire.org:3478' },
    { urls: 'stun:stun.ippi.fr:3478' },
    { urls: 'stun:stun.ipshka.com:3478' },
    { urls: 'stun:stun.iptel.org:3478' },
    { urls: 'stun:stun.irian.at:3478' },
    { urls: 'stun:stun.it1.hr:3478' },
    { urls: 'stun:stun.ivao.aero:3478' },
    { urls: 'stun:stun.jappix.com:3478' },
    { urls: 'stun:stun.jumblo.com:3478' },
    { urls: 'stun:stun.justvoip.com:3478' },
    { urls: 'stun:stun.kanet.ru:3478' },
    { urls: 'stun:stun.kiwilink.co.nz:3478' },
    { urls: 'stun:stun.kundenserver.de:3478' },
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun.linea7.net:3478' },
    { urls: 'stun:stun.linphone.org:3478' },
    { urls: 'stun:stun.liveo.fr:3478' },
    { urls: 'stun:stun.lowratevoip.com:3478' },
    { urls: 'stun:stun.lugosoft.com:3478' },
    { urls: 'stun:stun.lundimatin.fr:3478' },
    { urls: 'stun:stun.magnet.ie:3478' },
    { urls: 'stun:stun.manle.com:3478' },
    { urls: 'stun:stun.mgn.ru:3478' },
    { urls: 'stun:stun.mit.de:3478' },
    { urls: 'stun:stun.mitake.com.tw:3478' },
    { urls: 'stun:stun.miwifi.com:3478' },
    { urls: 'stun:stun.modulus.gr:3478' },
    { urls: 'stun:stun.mozcom.com:3478' },
    { urls: 'stun:stun.myvoiptraffic.com:3478' },
    { urls: 'stun:stun.mywatson.it:3478' },
    { urls: 'stun:stun.nas.net:3478' },
    { urls: 'stun:stun.neotel.co.za:3478' },
    { urls: 'stun:stun.netappel.com:3478' },
    { urls: 'stun:stun.netappel.fr:3478' },
    { urls: 'stun:stun.netgsm.com.tr:3478' },
    { urls: 'stun:stun.nfon.net:3478' },
    { urls: 'stun:stun.noblogs.org:3478' },
    { urls: 'stun:stun.noc.ams-ix.net:3478' },
    { urls: 'stun:stun.node4.co.uk:3478' },
    { urls: 'stun:stun.nonoh.net:3478' },
    { urls: 'stun:stun.nottingham.ac.uk:3478' },
    { urls: 'stun:stun.nova.is:3478' },
    { urls: 'stun:stun.nventure.com:3478' },
    { urls: 'stun:stun.on.net.mk:3478' },
    { urls: 'stun:stun.ooma.com:3478' },
    { urls: 'stun:stun.ooonet.ru:3478' },
    { urls: 'stun:stun.oriontelekom.rs:3478' },
    { urls: 'stun:stun.outland-net.de:3478' },
    { urls: 'stun:stun.ozekiphone.com:3478' },
    { urls: 'stun:stun.patlive.com:3478' },
    { urls: 'stun:stun.personal-voip.de:3478' },
    { urls: 'stun:stun.petcube.com:3478' },
    { urls: 'stun:stun.phone.com:3478' },
    { urls: 'stun:stun.phoneserve.com:3478' },
    { urls: 'stun:stun.pjsip.org:3478' },
    { urls: 'stun:stun.poivy.com:3478' },
    { urls: 'stun:stun.powerpbx.org:3478' },
    { urls: 'stun:stun.powervoip.com:3478' },
    { urls: 'stun:stun.ppdi.com:3478' },
    { urls: 'stun:stun.prizee.com:3478' },
    { urls: 'stun:stun.qq.com:3478' },
    { urls: 'stun:stun.qvod.com:3478' },
    { urls: 'stun:stun.rackco.com:3478' },
    { urls: 'stun:stun.rapidnet.de:3478' },
    { urls: 'stun:stun.rb-net.com:3478' },
    { urls: 'stun:stun.refint.net:3478' },
    { urls: 'stun:stun.remote-learner.net:3478' },
    { urls: 'stun:stun.rixtelecom.se:3478' },
    { urls: 'stun:stun.rockenstein.de:3478' },
    { urls: 'stun:stun.rolmail.net:3478' },
    { urls: 'stun:stun.rounds.com:3478' },
    { urls: 'stun:stun.rynga.com:3478' },
    { urls: 'stun:stun.samsungsmartcam.com:3478' },
    { urls: 'stun:stun.schlund.de:3478' },
    { urls: 'stun:stun.services.mozilla.com:3478' },
    { urls: 'stun:stun.sigmavoip.com:3478' },
    { urls: 'stun:stun.sip.us:3478' },
    { urls: 'stun:stun.sipdiscount.com:3478' },
    { urls: 'stun:stun.siplogin.de:3478' },
    { urls: 'stun:stun.sipnet.net:3478' },
    { urls: 'stun:stun.sipnet.ru:3478' },
    { urls: 'stun:stun.siportal.it:3478' },
    { urls: 'stun:stun.sippeer.dk:3478' },
    { urls: 'stun:stun.siptraffic.com:3478' },
    { urls: 'stun:stun.skylink.ru:3478' },
    { urls: 'stun:stun.sma.de:3478' },
    { urls: 'stun:stun.smartvoip.com:3478' },
    { urls: 'stun:stun.smsdiscount.com:3478' },
    { urls: 'stun:stun.snafu.de:3478' },
    { urls: 'stun:stun.softjoys.com:3478' },
    { urls: 'stun:stun.solcon.nl:3478' },
    { urls: 'stun:stun.solnet.ch:3478' },
    { urls: 'stun:stun.sonetel.com:3478' },
    { urls: 'stun:stun.sonetel.net:3478' },
    { urls: 'stun:stun.sovtest.ru:3478' },
    { urls: 'stun:stun.speedy.com.ar:3478' },
    { urls: 'stun:stun.spokn.com:3478' },
    { urls: 'stun:stun.srce.hr:3478' },
    { urls: 'stun:stun.ssl7.net:3478' },
    { urls: 'stun:stun.stunprotocol.org:3478' },
    { urls: 'stun:stun.symform.com:3478' },
    { urls: 'stun:stun.symplicity.com:3478' },
    { urls: 'stun:stun.sysadminman.net:3478' },
    { urls: 'stun:stun.t-online.de:3478' },
    { urls: 'stun:stun.tagan.ru:3478' },
    { urls: 'stun:stun.tatneft.ru:3478' },
    { urls: 'stun:stun.teachercreated.com:3478' },
    { urls: 'stun:stun.tel.lu:3478' },
    { urls: 'stun:stun.telbo.com:3478' },
    { urls: 'stun:stun.telefacil.com:3478' },
    { urls: 'stun:stun.tis-dialog.ru:3478' },
    { urls: 'stun:stun.tng.de:3478' },
    { urls: 'stun:stun.twt.it:3478' },
    { urls: 'stun:stun.u-blox.com:3478' },
    { urls: 'stun:stun.ucallweconn.net:3478' },
    { urls: 'stun:stun.ucsb.edu:3478' },
    { urls: 'stun:stun.ucw.cz:3478' },
    { urls: 'stun:stun.uls.co.za:3478' },
    { urls: 'stun:stun.unseen.is:3478' },
    { urls: 'stun:stun.usfamily.net:3478' },
    { urls: 'stun:stun.veoh.com:3478' },
    { urls: 'stun:stun.vidyo.com:3478' },
    { urls: 'stun:stun.vipgroup.net:3478' },
    { urls: 'stun:stun.virtual-call.com:3478' },
    { urls: 'stun:stun.viva.gr:3478' },
    { urls: 'stun:stun.vivox.com:3478' },
    { urls: 'stun:stun.vline.com:3478' },
    { urls: 'stun:stun.vo.lu:3478' },
    { urls: 'stun:stun.vodafone.ro:3478' },
    { urls: 'stun:stun.voicetrading.com:3478' },
    { urls: 'stun:stun.voip.aebc.com:3478' },
    { urls: 'stun:stun.voip.blackberry.com:3478' },
    { urls: 'stun:stun.voip.eutelia.it:3478' },
    { urls: 'stun:stun.voiparound.com:3478' },
    { urls: 'stun:stun.voipblast.com:3478' },
    { urls: 'stun:stun.voipbuster.com:3478' },
    { urls: 'stun:stun.voipbusterpro.com:3478' },
    { urls: 'stun:stun.voipcheap.co.uk:3478' },
    { urls: 'stun:stun.voipcheap.com:3478' },
    { urls: 'stun:stun.voipfibre.com:3478' },
    { urls: 'stun:stun.voipgain.com:3478' },
    { urls: 'stun:stun.voipgate.com:3478' },
    { urls: 'stun:stun.voipinfocenter.com:3478' },
    { urls: 'stun:stun.voipplanet.nl:3478' },
    { urls: 'stun:stun.voippro.com:3478' },
    { urls: 'stun:stun.voipraider.com:3478' },
    { urls: 'stun:stun.voipstunt.com:3478' },
    { urls: 'stun:stun.voipwise.com:3478' },
    { urls: 'stun:stun.voipzoom.com:3478' },
    { urls: 'stun:stun.vopium.com:3478' },
    { urls: 'stun:stun.voxgratia.org:3478' },
    { urls: 'stun:stun.voxox.com:3478' },
    { urls: 'stun:stun.voys.nl:3478' },
    { urls: 'stun:stun.voztele.com:3478' },
    { urls: 'stun:stun.vyke.com:3478' },
    { urls: 'stun:stun.webcalldirect.com:3478' },
    { urls: 'stun:stun.whoi.edu:3478' },
    { urls: 'stun:stun.wifirst.net:3478' },
    { urls: 'stun:stun.wwdl.net:3478' },
    { urls: 'stun:stun.xs4all.nl:3478' },
    { urls: 'stun:stun.xtratelecom.es:3478' },
    { urls: 'stun:stun.yesss.at:3478' },
    { urls: 'stun:stun.zadarma.com:3478' },
    { urls: 'stun:stun.zadv.com:3478' },
    { urls: 'stun:stun.zoiper.com:3478' },
    { urls: 'stun:stun1.faktortel.com.au:3478' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun1.voiceeclipse.net:3478' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun3.l.google.com:19302' },
    { urls: 'stun:stun4.l.google.com:19302' },
    { urls: 'stun:stunserver.org:3478' },
    { urls: 'stun:stun.nextcloud.com:443' },
    { urls: 'stun:stun.flashdance.cx:3478' }
];

// ==========================================================
// UI HELPERS
// (Functions remain the same)
// ==========================================================
function addMessage(text, type = 'system'){
  const msg = document.createElement('div');
  msg.className = `message ${type}`;
  msg.textContent = text;
  els.messages.appendChild(msg);
  els.messages.scrollTop = els.messages.scrollHeight;
}

function setStatus(text, connected = false){
  els.statusText.textContent = text;
  if(connected){
    els.statusDot.classList.add('connected');
    els.msgInput.disabled = false;
    els.sendBtn.disabled = false;
    els.instructions.style.display = 'none';
  } else {
    els.statusDot.classList.remove('connected');
    els.msgInput.disabled = true;
    els.sendBtn.disabled = true;
  }
}

function showQR(url){
  els.qrCanvas.innerHTML = '';
  els.qrSection.classList.remove('hidden');
  els.startBtn.style.display = 'none';
  
  try {
    new QRCode(els.qrCanvas, {
      text: url,
      width: 240,
      height: 240,
      correctLevel: QRCode.CorrectLevel.M
    });
  } catch(e){
    els.qrCanvas.innerHTML = `<p style="color:#ef4444">QR generation failed</p>`;
  }
  
  els.joinLink.href = url;
  els.joinLink.textContent = url;
}

function hideQR(){
  els.qrSection.classList.add('hidden');
  if(!pc || pc.connectionState === 'closed' || pc.connectionState === 'failed' || pc.connectionState === 'disconnected'){
    els.startBtn.style.display = 'flex';
    els.instructions.style.display = 'block';
  }
}

// ==========================================================
// WEBRTC LOGIC
// ==========================================================
function setupDataChannel(channel){
  dataChannel = channel;
  channel.onopen = () => {
    addMessage('âœ… Connected! Chat is now encrypted and peer-to-peer.', 'system');
    setStatus('Connected', true);
    hideQR();
  };
  
  channel.onclose = () => {
    addMessage('âŒ Connection closed. Refresh to restart.', 'system');
    setStatus('Disconnected');
  };
  
  channel.onmessage = e => addMessage(e.data, 'received');
}

// 1. Create offer (Host/Initiator)
async function createOffer(){
  // Cleanup any old connection
  if (pc) pc.close();
  
  els.startBtn.disabled = true;
  addMessage('Creating secure connection offer...', 'system');
  setStatus('Waiting for peer...');
  
  // *** Use MAX_ICE_SERVERS for robust connection attempts ***
  pc = new RTCPeerConnection({
    iceServers: MAX_ICE_SERVERS
  });
  
  // Host creates the data channel
  const dc = pc.createDataChannel('chat');
  setupDataChannel(dc);
  
  pc.onconnectionstatechange = () => {
    if(['failed', 'disconnected', 'closed'].includes(pc.connectionState)){
      addMessage('Connection failed or lost. Try again.', 'system');
      setStatus('Disconnected');
    }
  };
  
  // Create and set local SDP (the Offer)
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  
  // Wait a moment for ICE candidates to gather (improves connection reliability)
  await new Promise(r => setTimeout(r, 1000)); 
  
  // Generate the first link (Offer)
  const offerUrl = `${location.origin}${location.pathname}?offer=${encodeSDP(pc.localDescription.sdp)}`;
  showQR(offerUrl);
  addMessage('**Step 1: First QR Code.** Show this QR code to your peer (Visitor) to generate the Answer.', 'system');
}

// 2. Process incoming offer (Visitor/Receiver)
async function processOffer(encoded){
  els.startBtn.style.display = 'none';
  els.startBtn.disabled = true;
  addMessage('Received connection offer. Creating Answer...', 'system');
  setStatus('Connecting...');
  
  const sdp = decodeSDP(encoded);
  if(!sdp){ addMessage('âŒ Invalid connection code', 'system'); return; }
  
  // *** Use MAX_ICE_SERVERS for robust connection attempts ***
  pc = new RTCPeerConnection({
    iceServers: MAX_ICE_SERVERS
  });
  
  // Visitor listens for the incoming data channel
  pc.ondatachannel = e => setupDataChannel(e.channel);
  
  // Set remote SDP (the Offer)
  await pc.setRemoteDescription({ type: 'offer', sdp });
  
  // Create and set local SDP (the Answer)
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  
  // Wait a moment for ICE candidates to gather
  await new Promise(r => setTimeout(r, 1000));
  
  // Generate the second link (Answer)
  const answerUrl = `${location.origin}${location.pathname}?answer=${encodeSDP(pc.localDescription.sdp)}`;
  showQR(answerUrl);
  addMessage('**Step 2: Second QR Code.** Show this QR code to the Host to finalize the connection.', 'system');
}

// 3. Process incoming answer (Host receives)
async function processAnswer(encoded){
  const sdp = decodeSDP(encoded);
  if(!sdp || !pc){ addMessage('âŒ Invalid response or missing offer setup.', 'system'); return; }
  
  await pc.setRemoteDescription({ type: 'answer', sdp });
  addMessage('Finalizing connection via Answer...', 'system');
  // Connection should now finalize automatically via ICE/STUN
}

// ==========================================================
// MESSAGING & EVENT LISTENERS
// (Functions remain the same)
// ==========================================================
function sendMessage(){
  const text = els.msgInput.value.trim();
  if(!text || !dataChannel || dataChannel.readyState !== 'open') return;
  
  dataChannel.send(text);
  addMessage(text, 'sent');
  els.msgInput.value = '';
}

els.startBtn.addEventListener('click', createOffer);
els.hideQrBtn.addEventListener('click', hideQR);
els.copyBtn.addEventListener('click', () => {
  navigator.clipboard?.writeText(els.joinLink.href)
    .then(() => addMessage('Link copied to clipboard', 'system'))
    .catch(() => addMessage('Copy failed. Please copy manually.', 'system'));
});
els.sendBtn.addEventListener('click', sendMessage);
els.msgInput.addEventListener('keypress', e => {
  if(e.key === 'Enter') sendMessage();
});

// ==========================================================
// INIT - URL PARAMETER HANDLER
// (Function remains the same)
// ==========================================================
(async function init(){
  const params = new URLSearchParams(location.search);
  
  if(params.has('offer')){
    // Visitor: Remove URL parameter and start the process
    history.replaceState(null, '', location.pathname); 
    await processOffer(params.get('offer'));
  } else if(params.has('answer')){
    // Host: Remove URL parameter and start the process
    history.replaceState(null, '', location.pathname); 
    els.startBtn.style.display = 'none'; 
    await processAnswer(params.get('answer'));
  }
})();
</script>

</body>
</html>
