<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>P2P Chat â€“ Scan to Connect (Max Reliability)</title>
<style>
  :root{
    --bg:#0a0e1a;
    --surface:#111827;
    --surface-hover:#1f2937;
    --border:#374151;
    --text:#f9fafb;
    --text-muted:#9ca3af;
    --accent:#06b6d4;
    --accent-hover:#0891b2;
    --success:#10b981;
    --warning:#f59e0b;
  }

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(â€“bg);color:var(â€“text);font-family:-apple-system,BlinkMacSystemFont,â€˜Segoe UIâ€™,Roboto,sans-serif;overflow:hidden}

.app{height:100dvh;display:flex;flex-direction:column;max-width:600px;margin:0 auto;padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom);gap:12px}

header{text-align:center;padding:16px 0}
h1{font-size:1.5rem;margin:0;font-weight:700;background:linear-gradient(135deg,#06b6d4,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.status{font-size:0.875rem;color:var(â€“text-muted);margin-top:4px;display:flex;align-items:center;justify-content:center;gap:6px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(â€“text-muted);animation:pulse 2s ease-in-out infinite}
.status-dot.connected{background:var(â€“success);animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

.qr-section{background:var(â€“surface);border-radius:16px;padding:20px;text-align:center;border:1px solid var(â€“border)}
.qr-section.hidden{display:none}
#qrCanvas{margin:16px auto;background:#fff;padding:16px;border-radius:12px;display:inline-block}

.action-buttons{display:flex;gap:8px;margin-top:12px}
.action-buttons button{flex:1}

button{
background:var(â€“surface);
border:1px solid var(â€“border);
color:var(â€“text);
padding:12px 20px;
border-radius:12px;
font-size:0.9375rem;
font-weight:500;
cursor:pointer;
transition:all 0.2s;
min-height:48px;
display:flex;
align-items:center;
justify-content:center;
gap:8px
}
button:hover{background:var(â€“surface-hover);transform:translateY(-1px)}
button:active{transform:translateY(0)}
button.primary{background:var(â€“accent);border-color:var(â€“accent);color:#fff}
button.primary:hover{background:var(â€“accent-hover)}
button:disabled{opacity:0.5;cursor:not-allowed;transform:none}

.messages{
flex:1;
background:var(â€“surface);
border-radius:16px;
border:1px solid var(â€“border);
overflow-y:auto;
padding:16px;
display:flex;
flex-direction:column;
gap:12px;
-webkit-overflow-scrolling:touch
}

.message{
max-width:80%;
padding:10px 14px;
border-radius:12px;
font-size:0.9375rem;
line-height:1.5;
word-wrap:break-word
}
.message.system{
background:rgba(156,163,175,0.1);
color:var(â€“text-muted);
align-self:center;
max-width:90%;
text-align:center;
font-size:0.875rem;
padding:8px 12px
}
.message.sent{
background:var(â€“accent);
color:#fff;
align-self:flex-end;
border-bottom-right-radius:4px
}
.message.received{
background:var(â€“surface-hover);
align-self:flex-start;
border-bottom-left-radius:4px
}

.input-area{
display:flex;
gap:8px;
padding:12px;
background:var(â€“surface);
border-radius:16px;
border:1px solid var(â€“border)
}
input{
flex:1;
background:transparent;
border:none;
outline:none;
color:var(â€“text);
font-size:1rem;
padding:8px
}
input::placeholder{color:var(â€“text-muted)}

.instructions{
background:rgba(6,182,212,0.1);
border:1px solid rgba(6,182,212,0.2);
border-radius:12px;
padding:12px 16px;
font-size:0.875rem;
color:var(â€“text-muted);
line-height:1.5
}

.link{
color:var(â€“accent);
word-break:break-all;
text-decoration:none;
font-size:0.75rem;
display:block;
margin-top:8px
}
</style>

</head>
<body>
<div class="app">
  <header>
    <h1>ðŸ”’ P2P Secure Chat</h1>
    <div class="status">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Disconnected</span>
    </div>
  </header>

  <div class="qr-section hidden" id="qrSection">
    <div id="qrCanvas"></div>
    <div class="action-buttons">
      <button id="copyBtn">ðŸ“‹ Copy Link</button>
      <button id="hideQrBtn">âœ• Hide</button>
    </div>
    <a class="link" id="joinLink" href="#" target="_blank"></a>
  </div>

  <button class="primary" id="startBtn">
    ðŸš€ Start New Chat Room
  </button>

  <div class="instructions" id="instructions">
    **Step 1:** Click "Start New Chat Room". Wait for the **"Ready to Share"** status. **Step 2:** Share the QR code. **Step 3:** Scan the peer's QR code.
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="msgInput" placeholder="Type your message..." disabled />
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// ==========================================================
// RTC SIGNALING UTILITIES
// ==========================================================
const encodeSDP = sdp => encodeURIComponent(btoa(unescape(encodeURIComponent(sdp))));
const decodeSDP = str => {
  try { return decodeURIComponent(escape(atob(decodeURIComponent(str)))); }
  catch(e){ return null; }
};

// ==========================================================
// DOM ELEMENTS & STATE
// ==========================================================
const els = {
  statusDot: document.getElementById('statusDot'),
  statusText: document.getElementById('statusText'),
  qrSection: document.getElementById('qrSection'),
  qrCanvas: document.getElementById('qrCanvas'),
  copyBtn: document.getElementById('copyBtn'),
  hideQrBtn: document.getElementById('hideQrBtn'),
  joinLink: document.getElementById('joinLink'),
  startBtn: document.getElementById('startBtn'),
  instructions: document.getElementById('instructions'),
  messages: document.getElementById('messages'),
  msgInput: document.getElementById('msgInput'),
  sendBtn: document.getElementById('sendBtn')
};

let pc = null;
let dataChannel = null;

// ==========================================================
// **MAXIMUM STUN SERVER CONFIGURATION**
// (Uses the large list for max reliability)
// ==========================================================
const MAX_ICE_SERVERS = [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:numb.viagenie.ca:3478' },
    { urls: 'stun:stun.nextcloud.com:443' },
    { urls: 'stun:stun.voipbuster.com:3478' },
    { urls: 'stun:stun.ekiga.net:3478' },
    { urls: 'stun:iphone-stun.strato-iphone.de:3478' },
    { urls: 'stun:s1.taraba.net:3478' },
    { urls: 'stun:stun.12connect.com:3478' },
    { urls: 'stun:stun.3cx.com:3478' },
    { urls: 'stun:stun.aeta.com:3478' },
    { urls: 'stun:stun.annatel.net:3478' },
    { urls: 'stun:stun.avigora.com:3478' },
    { urls: 'stun:stun.bahnhof.net:3478' },
    { urls: 'stun:stun.bluesip.net:3478' },
    { urls: 'stun:stun.budgetphone.nl:3478' },
    { urls: 'stun:stun.callwithus.com:3478' },
    { urls: 'stun:stun.commpeak.com:3478' },
    { urls: 'stun:stun.counterpath.com:3478' },
    { urls: 'stun:stun.dcalling.de:3478' },
    { urls: 'stun:stun.dingaling.ca:3478' },
    { urls: 'stun:stun.duocom.es:3478' },
    { urls: 'stun:stun.e-fon.ch:3478' },
    { urls: 'stun:stun.einsundeins.de:3478' },
    { urls: 'stun:stun.fuzemeeting.com:3478' },
    { urls: 'stun:stun.gmx.net:3478' },
    { urls: 'stun:stun.gradwell.com:3478' },
    { urls: 'stun:stun.hoiio.com:3478' },
    { urls: 'stun:stun.ideasip.com:3478' },
    { urls: 'stun:stun.ipfire.org:3478' },
    { urls: 'stun:stun.iptel.org:3478' },
    { urls: 'stun:stun.jappix.com:3478' },
    { urls: 'stun:stun.justvoip.com:3478' },
    { urls: 'stun:stun.linphone.org:3478' },
    { urls: 'stun:stun.lowratevoip.com:3478' },
    { urls: 'stun:stun.magnet.ie:3478' },
    { urls: 'stun:stun.mit.de:3478' },
    { urls: 'stun:stun.nfon.net:3478' },
    { urls: 'stun:stun.noc.ams-ix.net:3478' },
    { urls: 'stun:stun.ooma.com:3478' },
    { urls: 'stun:stun.pjsip.org:3478' },
    { urls: 'stun:stun.powervoip.com:3478' },
    { urls: 'stun:stun.qq.com:3478' },
    { urls: 'stun:stun.rixtelecom.se:3478' },
    { urls: 'stun:stun.rounds.com:3478' },
    { urls: 'stun:stun.schlund.de:3478' },
    { urls: 'stun:stun.services.mozilla.com:3478' },
    { urls: 'stun:stun.sipnet.net:3478' },
    { urls: 'stun:stun.siportal.it:3478' },
    { urls: 'stun:stun.solnet.ch:3478' },
    { urls: 'stun:stun.sonetel.com:3478' },
    { urls: 'stun:stun.t-online.de:3478' },
    { urls: 'stun:stun.telbo.com:3478' },
    { urls: 'stun:stun.tng.de:3478' },
    { urls: 'stun:stun.unseen.is:3478' },
    { urls: 'stun:stun.vivox.com:3478' },
    { urls: 'stun:stun.voipbuster.com:3478' },
    { urls: 'stun:stun.voipwise.com:3478' },
    { urls: 'stun:stun.voxgratia.org:3478' },
    { urls: 'stun:stun.voys.nl:3478' },
    { urls: 'stun:stun.webcalldirect.com:3478' },
    { urls: 'stun:stun.zadarma.com:3478' },
    // A consolidated selection for brevity while retaining diversity.
];

// ==========================================================
// UI HELPERS (Functions remain the same)
// ==========================================================
function addMessage(text, type = 'system'){
  const msg = document.createElement('div');
  msg.className = `message ${type}`;
  msg.textContent = text;
  els.messages.appendChild(msg);
  els.messages.scrollTop = els.messages.scrollHeight;
}

function setStatus(text, connected = false){
  els.statusText.textContent = text;
  if(connected){
    els.statusDot.classList.add('connected');
    els.msgInput.disabled = false;
    els.sendBtn.disabled = false;
    els.instructions.style.display = 'none';
  } else {
    els.statusDot.classList.remove('connected');
    els.msgInput.disabled = true;
    els.sendBtn.disabled = true;
  }
}

function showQR(url){
  els.qrCanvas.innerHTML = '';
  els.qrSection.classList.remove('hidden');
  els.startBtn.style.display = 'none';
  
  try {
    new QRCode(els.qrCanvas, {
      text: url,
      width: 240,
      height: 240,
      correctLevel: QRCode.CorrectLevel.M
    });
  } catch(e){
    els.qrCanvas.innerHTML = `<p style="color:#ef4444">QR generation failed</p>`;
  }
  
  els.joinLink.href = url;
  els.joinLink.textContent = url;
}

function hideQR(){
  els.qrSection.classList.add('hidden');
  if(!pc || pc.connectionState === 'closed' || pc.connectionState === 'failed' || pc.connectionState === 'disconnected'){
    els.startBtn.style.display = 'flex';
    els.instructions.style.display = 'block';
  }
}

// ==========================================================
// WEBRTC LOGIC & ICE GATHERING REFACTOR
// ==========================================================
function setupDataChannel(channel){
  dataChannel = channel;
  channel.onopen = () => {
    addMessage('âœ… Connected! Chat is now encrypted and peer-to-peer.', 'system');
    setStatus('Connected', true);
    hideQR();
  };
  
  channel.onclose = () => {
    addMessage('âŒ Connection closed. Refresh to restart.', 'system');
    setStatus('Disconnected');
  };
  
  channel.onmessage = e => addMessage(e.data, 'received');
}

/**
 * Ensures ICE gathering completes or times out before generating the link.
 * This is the core reliability improvement.
 */
function gatherIceCandidates(pc, isOffer){
    return new Promise(resolve => {
        let timeout = setTimeout(() => {
            console.log("ICE gathering timeout reached.");
            resolve();
        }, 3000); // 3-second timeout is a good balance of speed and reliability

        pc.onicecandidate = event => {
            if (!event.candidate) {
                clearTimeout(timeout);
                console.log("ICE gathering complete.");
                resolve();
            } else {
                // Update status while candidates are being found
                setStatus(`Gathering network info (${pc.localDescription.sdp.split('a=candidate').length - 1} candidates)...`);
            }
        };

        // If candidates are already gathered or gathering is done, resolve immediately (for Answer)
        if (pc.iceGatheringState === 'complete' || pc.iceGatheringState === 'closed') {
            clearTimeout(timeout);
            resolve();
        }
    });
}


// 1. Create offer (Host/Initiator)
async function createOffer(){
  if (pc) pc.close();
  
  els.startBtn.disabled = true;
  addMessage('Starting connection setup. Gathering network candidates...', 'system');
  setStatus('Gathering network info (0 candidates)...');
  
  pc = new RTCPeerConnection({
    iceServers: MAX_ICE_SERVERS
  });
  
  const dc = pc.createDataChannel('chat');
  setupDataChannel(dc);
  
  pc.onconnectionstatechange = () => {
    if(['failed', 'disconnected', 'closed'].includes(pc.connectionState)){
      addMessage('Connection failed or lost. Try again.', 'system');
      setStatus('Disconnected');
    }
  };
  
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  
  // *** WAIT FOR ICE GATHERING TO FINISH ***
  await gatherIceCandidates(pc, true); 
  
  // Generate the first link (Offer)
  const offerUrl = `${location.origin}${location.pathname}?offer=${encodeSDP(pc.localDescription.sdp)}`;
  showQR(offerUrl);
  setStatus('Ready to Share: Offer Link Generated!', false);
  els.instructions.innerHTML = '**Step 1: Offer Ready.** Share this QR code/Link with your peer. It contains all the required connection info.';
}

// 2. Process incoming offer (Visitor/Receiver)
async function processOffer(encoded){
  els.startBtn.style.display = 'none';
  els.startBtn.disabled = true;
  addMessage('Received Offer. Processing and generating Answer...', 'system');
  setStatus('Processing Offer...');
  
  const sdp = decodeSDP(encoded);
  if(!sdp){ addMessage('âŒ Invalid connection code', 'system'); return; }
  
  pc = new RTCPeerConnection({
    iceServers: MAX_ICE_SERVERS
  });
  
  pc.ondatachannel = e => setupDataChannel(e.channel);
  
  await pc.setRemoteDescription({ type: 'offer', sdp });
  
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  
  // *** WAIT FOR ICE GATHERING TO FINISH ***
  await gatherIceCandidates(pc, false);
  
  // Generate the second link (Answer)
  const answerUrl = `${location.origin}${location.pathname}?answer=${encodeSDP(pc.localDescription.sdp)}`;
  showQR(answerUrl);
  setStatus('Ready to Share: Answer Link Generated!', false);
  els.instructions.innerHTML = '**Step 2: Answer Ready.** Share this QR code/Link with the **original Host** to complete the connection.';
}

// 3. Process incoming answer (Host receives)
async function processAnswer(encoded){
  addMessage('Received Answer. Finalizing connection...', 'system');
  setStatus('Finalizing connection...');

  const sdp = decodeSDP(encoded);
  if(!sdp || !pc || pc.localDescription.type !== 'offer'){ 
     addMessage('âŒ Invalid response or missing initial offer setup. Please restart the chat.', 'system'); 
     setStatus('Disconnected');
     return; 
  }
  
  // *** Connection is finalized by setting the remote Answer ***
  await pc.setRemoteDescription({ type: 'answer', sdp });
  // The DataChannel.onopen event handler will take over from here.
}

// ==========================================================
// MESSAGING & EVENT LISTENERS (Functions remain the same)
// ==========================================================
function sendMessage(){
  const text = els.msgInput.value.trim();
  if(!text || !dataChannel || dataChannel.readyState !== 'open') return;
  
  dataChannel.send(text);
  addMessage(text, 'sent');
  els.msgInput.value = '';
}

els.startBtn.addEventListener('click', createOffer);
els.hideQrBtn.addEventListener('click', hideQR);
els.copyBtn.addEventListener('click', () => {
  navigator.clipboard?.writeText(els.joinLink.href)
    .then(() => addMessage('Link copied to clipboard', 'system'))
    .catch(() => addMessage('Copy failed. Please copy manually.', 'system'));
});
els.sendBtn.addEventListener('click', sendMessage);
els.msgInput.addEventListener('keypress', e => {
  if(e.key === 'Enter') sendMessage();
});

// ==========================================================
// INIT - URL PARAMETER HANDLER (Function remains the same)
// ==========================================================
(async function init(){
  const params = new URLSearchParams(location.search);
  
  if(params.has('offer')){
    history.replaceState(null, '', location.pathname); 
    await processOffer(params.get('offer'));
  } else if(params.has('answer')){
    history.replaceState(null, '', location.pathname); 
    els.startBtn.style.display = 'none'; 
    await processAnswer(params.get('answer'));
  }
})();
</script>

</body>
</html>
