<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LG webOS Remote</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    
    .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
    }
    
    .status {
        text-align: center;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 14px;
    }
    
    .status.disconnected {
        background: #fee;
        color: #c33;
    }
    
    .status.connecting {
        background: #fff3cd;
        color: #856404;
    }
    
    .status.connected {
        background: #d4edda;
        color: #155724;
    }
    
    .connection-section {
        margin-bottom: 20px;
    }
    
    input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        margin-bottom: 10px;
    }
    
    button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    button:active {
        transform: scale(0.95);
    }
    
    .connect-btn {
        background: #667eea;
        color: white;
        margin-bottom: 10px;
    }
    
    .connect-btn:hover {
        background: #5568d3;
    }
    
    .test-btn {
        background: #28a745;
        color: white;
        margin-bottom: 10px;
    }
    
    .test-btn:hover {
        background: #218838;
    }
    
    .connect-btn:disabled, .test-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .remote-section {
        display: none;
    }
    
    .remote-section.active {
        display: block;
    }
    
    .dpad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 20px 0;
    }
    
    .dpad button {
        aspect-ratio: 1;
        background: #667eea;
        color: white;
        font-size: 24px;
    }
    
    .dpad button:hover {
        background: #5568d3;
    }
    
    .dpad .up { grid-column: 2; }
    .dpad .left { grid-column: 1; grid-row: 2; }
    .dpad .ok { grid-column: 2; grid-row: 2; background: #764ba2; }
    .dpad .right { grid-column: 3; grid-row: 2; }
    .dpad .down { grid-column: 2; grid-row: 3; }
    
    .controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 20px;
    }
    
    .controls button {
        background: #764ba2;
        color: white;
    }
    
    .controls button:hover {
        background: #653a8a;
    }
    
    .volume-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
    }
    
    .info {
        margin-top: 20px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 10px;
        font-size: 12px;
        color: #666;
        line-height: 1.5;
    }

    .warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        font-size: 12px;
    }
    
    .log {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
        font-size: 11px;
        color: #666;
        max-height: 150px;
        overflow-y: auto;
        font-family: monospace;
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è LG webOS Remote</h1>

```
    <div class="status disconnected" id="status">Not Connected</div>
    
    <div class="connection-section" id="connectionSection">
        <input type="text" id="tvIp" placeholder="TV IP (e.g., 192.168.1.100)" />
        <button class="test-btn" onclick="testConnection()" id="testBtn">üîç Test Connection</button>
        <button class="connect-btn" onclick="connectToTV()" id="connectBtn">Connect to TV</button>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Common Issues:</strong><br>
            ‚Ä¢ TV must be ON (not standby)<br>
            ‚Ä¢ Must be on same WiFi network<br>
            ‚Ä¢ Some TVs need "LG Connect Apps" enabled in Settings ‚Üí Network<br>
            ‚Ä¢ Try port 3000 and 3001
        </div>

        <div class="info">
            <strong>Find TV IP:</strong><br>
            Settings ‚Üí Network ‚Üí Wi-Fi Connection ‚Üí Advanced Settings
        </div>
        <div class="log" id="log"></div>
    </div>
    
    <div class="remote-section" id="remoteSection">
        <div class="dpad">
            <button class="up" onclick="pressButton('UP')">‚ñ≤</button>
            <button class="left" onclick="pressButton('LEFT')">‚óÑ</button>
            <button class="ok" onclick="pressButton('ENTER')">OK</button>
            <button class="right" onclick="pressButton('RIGHT')">‚ñ∫</button>
            <button class="down" onclick="pressButton('DOWN')">‚ñº</button>
        </div>
        
        <div class="controls">
            <button onclick="pressButton('BACK')">‚Üê Back</button>
            <button onclick="pressButton('HOME')">üè† Home</button>
        </div>
        
        <div class="volume-controls">
            <button onclick="pressButton('VOLUMEUP')">Vol +</button>
            <button onclick="pressButton('MUTE')">üîá Mute</button>
            <button onclick="pressButton('VOLUMEDOWN')">Vol -</button>
        </div>
        
        <button class="connect-btn" onclick="disconnectFromTV()" style="margin-top: 20px; background: #dc3545;">Disconnect</button>
    </div>
</div>

<script>
    let socket = null;
    let isConnected = false;
    let clientKey = null;
    let messageId = 0;
    let currentPort = 3000;
    let connectionAttempts = 0;
    let maxAttempts = 5;
    let retryTimeout = null;

    function log(msg) {
        const logEl = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML = `[${time}] ${msg}<br>` + logEl.innerHTML;
        console.log(msg);
    }

    function updateStatus(status, message) {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status ' + status;
        statusEl.textContent = message;
    }

    function showRemote(show) {
        document.getElementById('connectionSection').style.display = show ? 'none' : 'block';
        document.getElementById('remoteSection').classList.toggle('active', show);
    }

    async function testConnection() {
        const ip = document.getElementById('tvIp').value.trim();
        if (!ip) {
            alert('Please enter TV IP address');
            return;
        }

        const testBtn = document.getElementById('testBtn');
        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';

        log('Testing connection to ' + ip);

        // Test ping via image load
        const img = new Image();
        const timeout = setTimeout(() => {
            log('‚ùå Timeout - TV not responding');
            log('Make sure TV is ON and on same network');
            testBtn.disabled = false;
            testBtn.textContent = 'üîç Test Connection';
        }, 5000);

        img.onload = img.onerror = function() {
            clearTimeout(timeout);
            log('‚úÖ TV is reachable at ' + ip);
            log('Checking WebSocket ports...');
            
            // Try WebSocket on port 3000
            tryWebSocket(ip, 3000, function(success) {
                if (success) {
                    log('‚úÖ Port 3000 is open - Ready to connect!');
                    currentPort = 3000;
                } else {
                    log('‚ùå Port 3000 failed, trying 3001...');
                    tryWebSocket(ip, 3001, function(success2) {
                        if (success2) {
                            log('‚úÖ Port 3001 is open - Ready to connect!');
                            currentPort = 3001;
                        } else {
                            log('‚ùå WebSocket ports blocked');
                            log('Check TV Settings ‚Üí Network ‚Üí LG Connect Apps');
                        }
                        testBtn.disabled = false;
                        testBtn.textContent = 'üîç Test Connection';
                    });
                }
            });
        };

        img.src = 'http://' + ip + ':3000/favicon.ico?' + Date.now();
    }

    function tryWebSocket(ip, port, callback) {
        try {
            const testSocket = new WebSocket('ws://' + ip + ':' + port);
            
            const timeout = setTimeout(() => {
                testSocket.close();
                callback(false);
            }, 3000);

            testSocket.onopen = function() {
                clearTimeout(timeout);
                testSocket.close();
                callback(true);
            };

            testSocket.onerror = function() {
                clearTimeout(timeout);
                callback(false);
            };
        } catch(e) {
            callback(false);
        }
    }

    function connectToTV() {
        const ip = document.getElementById('tvIp').value.trim();
        if (!ip) {
            alert('Please enter TV IP address');
            return;
        }

        // Reset connection state
        connectionAttempts = 0;
        if (retryTimeout) clearTimeout(retryTimeout);
        
        attemptConnection(ip);
    }

    function attemptConnection(ip) {
        connectionAttempts++;
        
        const btn = document.getElementById('connectBtn');
        btn.disabled = true;
        btn.textContent = `Connecting... (${connectionAttempts}/${maxAttempts})`;

        localStorage.setItem('webos_tv_ip', ip);
        clientKey = localStorage.getItem('webos_client_key');

        // Try both ports in sequence
        const ports = [3000, 3001];
        const portIndex = (connectionAttempts - 1) % ports.length;
        currentPort = ports[portIndex];

        updateStatus('connecting', `Attempt ${connectionAttempts}/${maxAttempts} - Port ${currentPort}`);
        log(`[Attempt ${connectionAttempts}] Trying ${ip}:${currentPort}`);

        try {
            // Close existing socket if any
            if (socket) {
                socket.onclose = null;
                socket.onerror = null;
                socket.close();
            }

            socket = new WebSocket(`ws://${ip}:${currentPort}`);
            
            const connectionTimeout = setTimeout(() => {
                if (!isConnected) {
                    log(`[Attempt ${connectionAttempts}] Timeout on port ${currentPort}`);
                    
                    if (connectionAttempts < maxAttempts) {
                        // Retry with exponential backoff
                        const delay = Math.min(1000 * Math.pow(2, connectionAttempts - 1), 5000);
                        log(`Retrying in ${delay}ms...`);
                        
                        retryTimeout = setTimeout(() => {
                            attemptConnection(ip);
                        }, delay);
                    } else {
                        log('‚ùå All connection attempts failed');
                        updateStatus('disconnected', 'Failed - Check TV settings');
                        btn.disabled = false;
                        btn.textContent = 'Connect to TV';
                        showFailureHelp();
                    }
                }
            }, 5000);

            socket.onopen = function() {
                clearTimeout(connectionTimeout);
                log(`‚úÖ [Attempt ${connectionAttempts}] WebSocket opened on port ${currentPort}`);
                sendRegistration();
            };

            socket.onmessage = function(event) {
                try {
                    const msg = JSON.parse(event.data);
                    log(`‚Üê ${msg.type}`);
                    handleMessage(msg);
                } catch(e) {
                    log(`Parse error: ${e.message}`);
                }
            };

            socket.onerror = function(error) {
                clearTimeout(connectionTimeout);
                log(`‚ùå [Attempt ${connectionAttempts}] WebSocket error on port ${currentPort}`);
                
                if (!isConnected && connectionAttempts < maxAttempts) {
                    const delay = Math.min(1000 * connectionAttempts, 3000);
                    log(`Retrying in ${delay}ms...`);
                    
                    retryTimeout = setTimeout(() => {
                        attemptConnection(ip);
                    }, delay);
                } else if (connectionAttempts >= maxAttempts) {
                    updateStatus('disconnected', 'Connection failed');
                    btn.disabled = false;
                    btn.textContent = 'Connect to TV';
                    showFailureHelp();
                }
            };

            socket.onclose = function() {
                clearTimeout(connectionTimeout);
                
                if (isConnected) {
                    log('Connection closed by TV');
                    isConnected = false;
                    updateStatus('disconnected', 'Disconnected');
                    showRemote(false);
                    btn.disabled = false;
                    btn.textContent = 'Connect to TV';
                }
            };
        } catch(e) {
            log(`Exception: ${e.message}`);
            
            if (connectionAttempts < maxAttempts) {
                const delay = 2000;
                log(`Retrying in ${delay}ms...`);
                
                retryTimeout = setTimeout(() => {
                    attemptConnection(ip);
                }, delay);
            } else {
                updateStatus('disconnected', 'Failed');
                btn.disabled = false;
                btn.textContent = 'Connect to TV';
                showFailureHelp();
            }
        }
    }

    function showFailureHelp() {
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        log('TROUBLESHOOTING STEPS:');
        log('1. TV must be fully ON (not standby)');
        log('2. Enable: Settings ‚Üí Network ‚Üí LG Connect Apps');
        log('3. Same WiFi network required');
        log('4. Restart TV after enabling LG Connect Apps');
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    }

    function sendRegistration() {
        const handshake = {
            type: "register",
            id: "register_0",
            payload: {
                forcePairing: false,
                pairingType: "PROMPT",
                manifest: {
                    manifestVersion: 1,
                    appVersion: "1.1",
                    signed: {
                        created: "20140509",
                        appId: "com.lge.test",
                        vendorId: "com.lge",
                        localizedAppNames: {
                            "": "Web Remote",
                            "en-US": "Web Remote"
                        },
                        localizedVendorNames: {
                            "": "LG"
                        },
                        permissions: [
                            "TEST_SECURE",
                            "CONTROL_INPUT_TV",
                            "CONTROL_POWER",
                            "READ_INSTALLED_APPS",
                            "CONTROL_DISPLAY",
                            "CONTROL_INPUT_JOYSTICK",
                            "CONTROL_INPUT_MEDIA_RECORDING",
                            "CONTROL_INPUT_MEDIA_PLAYBACK",
                            "READ_INPUT_DEVICE_LIST",
                            "READ_NETWORK_STATE",
                            "READ_RUNNING_APPS",
                            "WRITE_SETTINGS",
                            "WRITE_NOTIFICATION_TOAST"
                        ],
                        serial: "2f930e2d2cfe083771f68e4fe7bb07"
                    },
                    permissions: [
                        "LAUNCH",
                        "LAUNCH_WEBAPP",
                        "APP_TO_APP",
                        "CLOSE",
                        "TEST_OPEN",
                        "TEST_PROTECTED",
                        "CONTROL_AUDIO",
                        "CONTROL_DISPLAY",
                        "CONTROL_INPUT_JOYSTICK",
                        "CONTROL_INPUT_MEDIA_RECORDING",
                        "CONTROL_INPUT_MEDIA_PLAYBACK",
                        "CONTROL_INPUT_TV",
                        "CONTROL_POWER",
                        "READ_APP_STATUS",
                        "READ_CURRENT_CHANNEL",
                        "READ_INPUT_DEVICE_LIST",
                        "READ_NETWORK_STATE",
                        "READ_RUNNING_APPS",
                        "WRITE_NOTIFICATION_ALERT",
                        "WRITE_NOTIFICATION_TOAST",
                        "WRITE_SETTINGS"
                    ]
                }
            }
        };

        if (clientKey) {
            handshake.payload["client-key"] = clientKey;
            log('Using saved key');
        }

        log('‚Üí Sending registration...');
        socket.send(JSON.stringify(handshake));
    }

    function handleMessage(msg) {
        if (msg.type === "registered") {
            log('‚úÖ Registration successful!');
            isConnected = true;
            connectionAttempts = 0; // Reset on success
            
            if (msg.payload && msg.payload["client-key"]) {
                clientKey = msg.payload["client-key"];
                localStorage.setItem('webos_client_key', clientKey);
                log('Client key saved');
            }
            
            const btn = document.getElementById('connectBtn');
            btn.disabled = false;
            
            updateStatus('connected', '‚úÖ Connected! Accept pairing on TV');
            showRemote(true);
        } else if (msg.type === "response") {
            if (msg.payload && msg.payload.returnValue === false) {
                log('Command failed');
            }
        } else if (msg.type === "error") {
            log('Error: ' + (msg.error || 'unknown'));
        }
    }

    function pressButton(button) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            alert('Not connected');
            return;
        }

        log('‚Üí ' + button);

        let request = {
            type: "request",
            id: "btn_" + (++messageId),
            uri: "ssap://com.webos.service.ime/sendEnterKey"
        };

        switch(button) {
            case 'HOME':
                request.uri = "ssap://system.launcher/open";
                request.payload = { id: "com.webos.app.livetv" };
                break;
            case 'VOLUMEUP':
                request.uri = "ssap://audio/volumeUp";
                break;
            case 'VOLUMEDOWN':
                request.uri = "ssap://audio/volumeDown";
                break;
            case 'MUTE':
                request.uri = "ssap://audio/setMute";
                request.payload = { mute: true };
                break;
        }

        socket.send(JSON.stringify(request));
    }

    function disconnectFromTV() {
        if (retryTimeout) {
            clearTimeout(retryTimeout);
            retryTimeout = null;
        }
        
        connectionAttempts = 0;
        
        if (socket) {
            socket.onclose = null;
            socket.onerror = null;
            socket.close();
            socket = null;
        }
        
        isConnected = false;
        updateStatus('disconnected', 'Disconnected');
        showRemote(false);
        
        const btn = document.getElementById('connectBtn');
        btn.disabled = false;
        btn.textContent = 'Connect to TV';
    }

    window.addEventListener('DOMContentLoaded', function() {
        const savedIp = localStorage.getItem('webos_tv_ip');
        if (savedIp) {
            document.getElementById('tvIp').value = savedIp;
        }
    });
</script>
```

</body>
</html>