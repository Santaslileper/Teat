<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1,minimum-scale=1,viewport-fit=cover">
<title>Santaslileper OS v10</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<style>
/* --- CORE OS STYLES --- */
*{margin:0;padding:0;box-sizing:border-box}
body,html{touch-action:none;overscroll-behavior:none;height:100%;height:100dvh;width:100%;overflow:hidden;background:#000}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;user-select:none;-webkit-user-select:none;color:#fff}

/* WALLPAPER CONTAINER */
.p{position:relative;background-color:#000;overflow:hidden;display:flex;flex-direction:column;background-position:center;background-size:cover;width:100%;height:100%}
@media (min-width:768px){.p{width:auto!important;height:95vh!important;aspect-ratio:9/19.5!important;margin:0 auto!important;position:absolute!important;top:50%!important;left:50%!important;transform:translate(-50%,-50%)!important;border-radius:40px!important;box-shadow:0 0 0 10px #2c2c2e;border:2px solid #333}}

/* SAFE AREA VARS */
:root { --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }

/* LOCK SCREEN */
#lock-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);z-index:10000;display:flex;flex-direction:column;align-items:center;transition:transform .4s;padding-top: calc(100px + var(--safe-top));}
#ls-clock{font-size:80px;font-weight:200;} .swipe-hint{position:absolute;bottom:30px;animation:pulse 2s infinite;opacity:0.7}
@keyframes pulse{0%,100%{opacity:.4;transform:translateY(0)}50%{opacity:1;transform:translateY(-5px)}}

/* HOME SCREEN GRID */
.h{position:absolute;top:0;left:0;right:0;bottom:0;padding-top:calc(20px + var(--safe-top));overflow-y:auto;overflow-x:hidden;display:block;transition:0.3s}
.h.zo{transform:scale(0.9);filter:brightness(0.5) blur(4px);pointer-events:none}
#ag{position:relative;width:100%;min-height:100vh;padding-bottom:200px}

/* GRID ITEMS (Apps & Widgets) */
.grid-item{position:absolute;transition:left .3s, top .3s; touch-action:none;z-index:10}
.grid-item.resizing{transition:none;z-index:100;background:rgba(50,50,50,0.8);border:1px solid #007aff;border-radius:20px}
.edit-mode .grid-item:not(.resizing):not(.dragging){animation:jiggle .3s infinite linear}
@keyframes jiggle{0%{transform:rotate(-1.5deg)}50%{transform:rotate(1.5deg)}100%{transform:rotate(-1.5deg)}}

/* APP ICONS */
.aiw{width:80px;height:95px;display:flex;flex-direction:column;align-items:center}
.ai{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;background:#333;box-shadow:0 4px 10px rgba(0,0,0,0.3)}
.al{font-size:11px;margin-top:5px;text-align:center;text-shadow:0 1px 2px rgba(0,0,0,0.8);width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* WIDGETS (General) */
.widget{border-radius:20px;overflow:hidden;color:#fff;display:flex;flex-direction:column}
.edit-mode .widget{background:rgba(40,40,40,0.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
.widget-content{
    flex:1; width:100%; height:100%; padding:8px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center; overflow:hidden;
}

/* WIDGET CONTENT FIT FIXES */
.widget-content img { max-width: 100%; max-height: 100%; object-fit: contain; }
.widget-content input { max-width: 100%; }

/* EDIT CONTROLS */
.del-btn{position:absolute;top:-8px;left:-8px;width:24px;height:24px;background:#ff3b30;border-radius:50%;z-index:20;color:#fff;font-weight:bold;display:none;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.5)}
.del-btn::after{content:'√ó'}
.resize-handle{position:absolute;bottom:0;right:0;width:30px;height:30px;z-index:30;display:none}
.resize-handle::after{content:'';position:absolute;bottom:6px;right:6px;width:10px;height:10px;border-bottom:3px solid #fff;border-right:3px solid #fff;border-radius:2px}
.edit-mode .del-btn, .edit-mode .resize-handle{display:flex}

/* APP WINDOW */
.aw{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;transform:translate3d(100%,0,0);transition:transform .4s cubic-bezier(.2,1,.2,1);z-index:50;display:flex;flex-direction:column}
.aw.ac{transform:translate3d(0,0,0)}
.app-header{height:calc(44px + var(--safe-top));padding-top:var(--safe-top);display:flex;align-items:center;justify-content:space-between;padding-left:15px;padding-right:15px;background:rgba(20,20,20,0.95);backdrop-filter:blur(10px);border-bottom:1px solid #333}
.awc{flex:1;background:#fff;position:relative;}
.awc.r90{overflow:hidden!important}
iframe.aif{width:100%;height:100%;border:none}

/* ADD WIDGET MENU (SCROLLABLE FIX) */
#add-panel {
    position: fixed; bottom: -600px; left: 0; width: 100%;
    max-height: 70vh; /* Limits height */
    overflow-y: auto; /* Enables Scrolling */
    background: #1c1c1e; border-radius: 20px 20px 0 0;
    z-index: 300; padding: 20px; transition: bottom 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex; flex-direction: column; gap: 10px;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
}
#add-panel.open { bottom: 0; }
.add-opt {
    padding: 16px; background: #2c2c2e; color: #fff;
    border-radius: 14px; font-size: 16px; font-weight: 500;
    display: flex; align-items: center; gap: 12px;
    flex-shrink: 0; /* Prevents squishing */
}
.add-opt:active { background: #3a3a3c; }

/* EDIT UI (BUTTONS) - HIDDEN BY DEFAULT */
#edit-ui {
    position: fixed; bottom: 30px; left: 0; width: 100%;
    display: flex; justify-content: center; gap: 15px;
    z-index: 200; pointer-events: none; opacity: 0;
    transition: opacity 0.3s;
}
.edit-mode #edit-ui { opacity: 1; pointer-events: auto; } /* Only shows in Jiggle Mode */
.ui-btn {
    padding: 12px 24px; background: rgba(50,50,50,0.8); backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2); border-radius: 30px;
    color: #fff; font-weight: 600; font-size: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

/* UTILS */
.store-app{height:100%;overflow-y:auto}.store-grid{display:grid;grid-template-columns:1fr;gap:10px;padding:15px}
.store-item{background:#2c2c2e;padding:15px;border-radius:12px;display:flex;align-items:center;gap:15px}
</style>
</head>
<body>

<div class="p" id="phone">
    <div id="lock-screen">
        <div style="font-size:40px;margin-bottom:10px">üîì</div>
        <div id="ls-clock">12:00</div>
        <div class="swipe-hint">Swipe up</div>
    </div>

    <div class="h" id="h"><div id="ag"></div></div>

    <div class="aw" id="app-window">
        <div class="app-header">
            <span id="aw-title" style="font-weight:600">App</span>
            <span onclick="closeApp()" style="font-size:24px;cursor:pointer">‚úï</span>
        </div>
        <div class="awc" id="awc"></div>
    </div>

    <div id="edit-ui">
        <button class="ui-btn" onclick="openAddPanel()">+ Add Widget</button>
        <button class="ui-btn" style="background:#007aff" onclick="toggleEdit(false)">Done</button>
    </div>
</div>

<div id="add-panel">
    <h3 style="text-align:center;margin-bottom:10px;color:#888">Widgets</h3>
    <div class="add-opt" onclick="addWidget('clock')">‚è∞ Clock</div>
    <div class="add-opt" onclick="addWidget('weather')">‚òÅÔ∏è Real Weather</div>
    <div class="add-opt" onclick="addWidget('qrcode')">üèÅ QR Generator</div>
    <div class="add-opt" onclick="addWidget('search')">üîç Google Bar</div>
    <div class="add-opt" onclick="addWidget('calendar')">üìÖ Calendar</div>
    <div class="add-opt" onclick="addWidget('photo')">üñºÔ∏è Photo Frame</div>
    <div class="add-opt" onclick="addWidget('note')">üìù Sticky Note</div>
    <div class="add-opt" style="justify-content:center;background:#000" onclick="closeAddPanel()">Close</div>
</div>

<script>
/* --- CONFIG --- */
const COL_COUNT=4, ROW_HEIGHT=100;
let SCREEN_W = document.getElementById("ag").clientWidth || window.innerWidth;
let COL_WIDTH = SCREEN_W / COL_COUNT;
let items = [], runningApps = [], currentApp = null, isEditMode = false;
const STORAGE_KEY = 'santas_os_v10';

/* --- INIT --- */
function init() {
    updateClock(); setInterval(updateClock, 1000);
    checkPlatform(); checkSafeAreas(); setupGestures();
    
    // Load Layout
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) {
        try { JSON.parse(saved).forEach(d => createItem(d.type, d.x, d.y, d.cols, d.rows, d)); } 
        catch(e) { loadDefaults(); }
    } else { loadDefaults(); }
    
    // Fetch Weather for any existing widgets
    fetchWeather();
}

function loadDefaults() {
    createItem('widget', 0, 0, 2, 2, {subtype:'clock'});
    createItem('widget', 2*COL_WIDTH, 0, 2, 2, {subtype:'weather'});
    
    const defApps = [
        {title:"App Store",icon:"üÖ∞Ô∏è",path:"store",class:"store"},
        {title:"Settings",icon:"‚öôÔ∏è",path:"settings",class:"settings"},
        {title:"Grapple",icon:"ü™ù",path:"page3.html",class:"motion"},
        {title:"Bing",icon:"üîç",path:"https://www.bing.com",class:"touch"}
    ];
    defApps.forEach((a, i) => {
        createItem('app', (i%4)*COL_WIDTH, (2+Math.floor(i/4))*ROW_HEIGHT, 1, 1, a);
    });
    saveLayout();
}

/* --- WIDGET GENERATION (Fixes "Widgets don't work") --- */
function createItem(type, x, y, cw, ch, data) {
    const el = document.createElement("div");
    el.className = "grid-item";
    
    // Calculate size
    const w = cw * COL_WIDTH - (type === "app" ? 0 : 15);
    const h = ch * ROW_HEIGHT - (type === "app" ? 10 : 15);
    if(data.w) el.style.width = data.w+"px"; else el.style.width = w+"px";
    if(data.h) el.style.height = data.h+"px"; else el.style.height = h+"px";

    // Generate Unique ID for this specific widget instance
    const uid = 'w-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

    if (type === "app") {
        el.classList.add("aiw");
        el.innerHTML = `<div class="del-btn"></div><div class="ai ${data.class||'touch'}">${data.icon}</div><div class="al">${data.title}</div>`;
        el.onclick = () => { if(!isEditMode) launchApp(data); };
    } else {
        el.classList.add("widget");
        el.innerHTML = `
            <div class="del-btn"></div>
            <div class="resize-handle"></div>
            <div class="widget-content" id="${uid}">
                ${getWidgetHTML(data.subtype, uid)}
            </div>`;
    }

    // Bind Delete
    el.querySelector(".del-btn").onclick = (e) => { e.stopPropagation(); deleteItem(el); };
    
    document.getElementById("ag").appendChild(el);
    
    const item = { el, type, subtype: data.subtype, x, y, w: parseFloat(el.style.width), h: parseFloat(el.style.height), cols: cw, rows: ch, uid, ...data };
    
    items.push(item);
    updateVisuals(item);
    if(type === 'widget') setupResize(item);
    setupDrag(item);
    updateContainer();
    return item;
}

/* --- REAL WIDGET CONTENT --- */
function getWidgetHTML(type, uid) {
    if(type === 'clock') return `<h1 style="font-size:32px;margin:0" id="clock-${uid}">--:--</h1><span style="font-size:10px;opacity:0.6">LOCAL TIME</span>`;
    
    if(type === 'weather') return `
        <div class="w-icon" style="font-size:35px">‚è≥</div>
        <div class="w-temp" style="font-size:24px;font-weight:bold">--¬∞</div>
        <div style="font-size:9px;opacity:0.6">Local Weather</div>`;
        
    if(type === 'qrcode') return `
        <img id="img-${uid}" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SantasOS" style="height:60%;aspect-ratio:1/1;background:#fff;border-radius:5px;margin-bottom:5px">
        <div style="display:flex;width:100%;gap:5px">
            <input type="text" id="in-${uid}" placeholder="Text..." style="flex:1;font-size:10px;border:none;border-radius:4px;padding:2px;color:#000">
            <button onclick="updateQR('${uid}')" style="font-size:10px;border:none;background:#007aff;color:#fff;border-radius:4px;padding:0 5px" onmousedown="event.stopPropagation()">Go</button>
        </div>`;
        
    if(type === 'search') return `<div style="width:90%;height:35px;background:#fff;border-radius:20px;display:flex;align-items:center;padding:0 10px;color:#000"><span style="margin-right:5px">üîç</span><input type="text" placeholder="Google..." style="border:none;outline:none;background:transparent;width:100%" onkeydown="if(event.key==='Enter') runSearch(this.value)" onmousedown="event.stopPropagation()"></div>`;
    
    if(type === 'calendar') return `<div style="color:#ff3b30;font-weight:bold">OCT</div><div style="font-size:40px">10</div>`;
    if(type === 'note') return `<textarea style="width:100%;height:100%;background:transparent;border:none;color:#fff;font-family:inherit;resize:none;font-size:14px" placeholder="Type note..." onmousedown="event.stopPropagation()"></textarea>`;
    
    return "Widget";
}

/* --- FUNCTIONALITY --- */
function updateQR(uid) {
    const txt = document.getElementById(`in-${uid}`).value;
    if(txt) document.getElementById(`img-${uid}`).src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txt)}`;
}

function fetchWeather() {
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(p => {
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
        .then(r=>r.json()).then(d=>{
            document.querySelectorAll('.w-temp').forEach(e => e.innerText = Math.round(d.current_weather.temperature)+"¬∞C");
            const c = d.current_weather.weathercode;
            let i = "‚òÄÔ∏è";
            if(c>3)i="‚òÅÔ∏è"; if(c>45)i="üåßÔ∏è"; if(c>70)i="‚ùÑÔ∏è"; if(c>95)i="‚õàÔ∏è";
            document.querySelectorAll('.w-icon').forEach(e => e.innerText = i);
        });
    });
}

function updateClock() {
    const t = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById("ls-clock").innerText = t;
    // Update all clock widgets specifically
    items.filter(i => i.subtype === 'clock').forEach(i => {
        const el = document.getElementById(`clock-${i.uid}`);
        if(el) el.innerText = t;
    });
}

/* --- GESTURES & EDIT MODE --- */
function setupGestures() {
    const grid = document.getElementById("ag");
    let timer;
    
    // Long Press to Edit
    grid.addEventListener("touchstart", (e) => {
        if(e.target === grid || e.target.closest('.grid-item')) {
            timer = setTimeout(() => {
                if(navigator.vibrate) navigator.vibrate(50);
                toggleEdit(true);
            }, 600);
        }
    });
    grid.addEventListener("touchend", () => clearTimeout(timer));
    grid.addEventListener("touchmove", () => clearTimeout(timer));
    
    // Swipe Up to Unlock
    const ls = document.getElementById("lock-screen");
    let sy = 0;
    ls.addEventListener("touchstart", e => sy = e.touches[0].clientY);
    ls.addEventListener("touchend", e => {
        if(e.changedTouches[0].clientY - sy < -100) {
            ls.style.transform = "translateY(-100%)";
        }
    });
}

function toggleEdit(val) {
    isEditMode = val;
    document.body.classList.toggle("edit-mode", val);
    if(!val) { closeAddPanel(); saveLayout(); }
}

function openAddPanel() { document.getElementById("add-panel").classList.add("open"); }
function closeAddPanel() { document.getElementById("add-panel").classList.remove("open"); }
function addWidget(type) {
    closeAddPanel();
    const spot = findNextEmptySpot(2, 2);
    createItem('widget', spot.x, spot.y, 2, 2, {subtype: type});
    saveLayout();
}

function deleteItem(el) {
    const idx = items.findIndex(i => i.el === el);
    if(idx > -1) { items.splice(idx, 1); el.remove(); saveLayout(); }
}

/* --- GRID LOGIC --- */
function findNextEmptySpot(w, h) {
    let o = 0;
    for(;;) {
        for(let i=0; i<COL_COUNT; i++) {
            if(i+w > COL_COUNT) continue;
            const x = i*COL_WIDTH, y = o*ROW_HEIGHT;
            const hit = items.some(n => x < n.x + n.w && x + w*COL_WIDTH > n.x && y < n.y + n.h && y + h*ROW_HEIGHT > n.y);
            if(!hit) return {x, y};
        }
        o++; if(o>100) return {x:0, y:o*ROW_HEIGHT};
    }
}

function setupDrag(item) {
    let sx, sy, sl, st;
    const move = e => {
        const cx = e.touches?e.touches[0].clientX:e.clientX;
        const cy = e.touches?e.touches[0].clientY:e.clientY;
        item.el.style.left = (sl+cx-sx)+"px";
        item.el.style.top = (st+cy-sy)+"px";
        e.preventDefault();
    };
    const end = () => {
        document.removeEventListener("touchmove", move); document.removeEventListener("touchend", end);
        document.removeEventListener("mousemove", move); document.removeEventListener("mouseup", end);
        item.el.classList.remove("dragging");
        
        // Snap
        let nx = Math.round(parseFloat(item.el.style.left) / COL_WIDTH) * COL_WIDTH;
        let ny = Math.round(parseFloat(item.el.style.top) / ROW_HEIGHT) * ROW_HEIGHT;
        if(nx < 0) nx = 0; if(nx > SCREEN_W - item.w) nx = SCREEN_W - item.cols * COL_WIDTH;
        if(ny < 0) ny = 0;
        
        item.x = nx; item.y = ny;
        
        // Bump others
        items.filter(i => i !== item).forEach(other => {
            if (nx < other.x + other.w && nx + item.w > other.x && ny < other.y + other.h && ny + item.h > other.y) {
                const free = findNextEmptySpot(other.cols, other.rows);
                other.x = free.x; other.y = free.y;
                updateVisuals(other);
            }
        });
        
        updateVisuals(item); updateContainer(); saveLayout();
    };
    const start = e => {
        if(isEditMode && !e.target.className.includes("resize") && !e.target.className.includes("del")) {
            item.el.classList.add("dragging");
            sx = e.touches?e.touches[0].clientX:e.clientX;
            sy = e.touches?e.touches[0].clientY:e.clientY;
            sl = parseFloat(item.el.style.left); st = parseFloat(item.el.style.top);
            document.addEventListener("touchmove", move, {passive:false}); document.addEventListener("touchend", end);
            document.addEventListener("mousemove", move); document.addEventListener("mouseup", end);
        }
    };
    item.el.addEventListener("touchstart", start, {passive:false});
    item.el.addEventListener("mousedown", start);
}

function setupResize(item) {
    const h = item.el.querySelector(".resize-handle");
    let sx, sy, sw, sh;
    const move = e => {
        const cx = e.touches?e.touches[0].clientX:e.clientX;
        const cy = e.touches?e.touches[0].clientY:e.clientY;
        item.el.style.width = (sw + (cx-sx)) + "px";
        item.el.style.height = (sh + (cy-sy)) + "px";
        e.stopPropagation(); e.preventDefault();
    };
    const end = () => {
        document.removeEventListener("touchmove", move); document.removeEventListener("touchend", end);
        item.el.classList.remove("resizing");
        const nw = parseFloat(item.el.style.width), nh = parseFloat(item.el.style.height);
        item.cols = Math.max(1, Math.round(nw/COL_WIDTH));
        item.rows = Math.max(1, Math.round(nh/ROW_HEIGHT));
        item.w = item.cols * COL_WIDTH - 15;
        item.h = item.rows * ROW_HEIGHT - 15;
        // Re-render content to fit new size
        item.el.querySelector(".widget-content").innerHTML = getWidgetHTML(item.subtype, item.uid);
        updateVisuals(item); saveLayout();
    };
    h.addEventListener("touchstart", e => {
        e.stopPropagation(); item.el.classList.add("resizing");
        sx = e.touches[0].clientX; sy = e.touches[0].clientY;
        sw = item.w; sh = item.h;
        document.addEventListener("touchmove", move, {passive:false}); document.addEventListener("touchend", end);
    });
}

function updateVisuals(i){ i.el.style.left=i.x+"px"; i.el.style.top=i.y+"px"; i.el.style.width=i.w+"px"; i.el.style.height=i.h+"px"; }
function updateContainer(){ let max=0; items.forEach(i=>max=Math.max(max, i.y+i.h)); document.getElementById("ag").style.minHeight=(max+300)+"px"; }
function saveLayout(){ const data=items.map(i=>({type:i.type,subtype:i.subtype,x:i.x,y:i.y,cols:i.cols,rows:i.rows,w:i.w,h:i.h,title:i.title,icon:i.icon,path:i.path,class:i.class})); localStorage.setItem(STORAGE_KEY,JSON.stringify(data)); }

/* --- APP LAUNCHER --- */
function launchApp(data) {
    if(data.path === 'store') { /* Simplified Store Logic */ alert("Store Placeholder"); return; }
    if(data.path.startsWith("http")) {
        document.getElementById("awc").innerHTML = `<iframe class="aif" src="${data.path}"></iframe>`;
    } else {
        document.getElementById("awc").innerHTML = `<div style="padding:20px;color:#000"><h1>${data.title}</h1><p>Internal App</p></div>`;
    }
    document.getElementById("app-window").classList.add("ac");
}
function closeApp() { document.getElementById("app-window").classList.remove("ac"); document.getElementById("awc").innerHTML = ""; }
function runSearch(q){ if(q) launchApp({title:"Google",path:"https://www.google.com/search?igu=1&q="+encodeURIComponent(q)}); }
function checkPlatform() { if(!/Mobi/i.test(navigator.userAgent) && window.innerWidth > 768) window.location.href="indexpc.html"; }
function checkSafeAreas() { if(/iPhone/.test(navigator.userAgent) && window.navigator.standalone) document.body.classList.add("force-notch"); }

init();
</script>
</body>
</html>