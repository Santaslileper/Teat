<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Santaslileper OS</title>
  <style>
    /* --- CORE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
        background: #000; display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
        user-select: none; -webkit-user-select: none; cursor: default;
        overflow: hidden;
    }

    /* --- THEME --- */
    .phone { 
        position: relative; width: 100%; height: 100%; max-width: 375px; max-height: 812px;
        background-color: #050505; /* Deep Black */
        background-image: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        overflow: hidden; 
        display: flex; flex-direction: column;
        border: 1px solid #333;
    }
    
    /* Desktop Styling */
    @media (min-width: 768px) {
        .phone { height: 812px; border-radius: 50px; box-shadow: 0 0 0 12px #2c2c2e, 0 20px 60px rgba(0,0,0,0.8); }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 180px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 100; }
    }
    
    .screen { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 2; }
    .status-bar { 
        height: 44px; padding: 0 20px; display: flex; align-items: flex-end; justify-content: space-between; 
        padding-bottom: 8px; color: #fff; font-size: 15px; font-weight: 600; 
        z-index: 100; pointer-events: none; position: absolute; width: 100%; top: 0;
    }

    /* --- HOME SCREEN --- */
    .home-screen { 
        padding: 60px 20px 80px 20px; height: 100%; overflow-y: auto;
        transition: transform 0.4s cubic-bezier(0.32, 0, 0.67, 0), filter 0.4s linear;
        will-change: transform, filter;
    }
    .home-screen.zoomed-out {
        transform: scale(0.85);
        filter: brightness(0.6) blur(5px);
        pointer-events: none;
    }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    /* Icons */
    .app-icon-wrapper { 
        display: flex; flex-direction: column; align-items: center; 
        transition: transform 0.2s ease; touch-action: none; 
    }
    .app-icon { 
        width: 60px; height: 60px; border-radius: 14px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 30px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #333, #555);
    }
    .app-icon.info { background: linear-gradient(135deg, #3498db, #2980b9); } /* Tutorial App Color */
    .app-icon:active { filter: brightness(0.8); transform: scale(0.95); }
    .app-label { color: #fff; font-size: 11px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

    /* --- RUNNING APPS & WINDOWS --- */
    .app-display { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 50; pointer-events: none;
    }
    .app-window {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff;
        transform: translate3d(100%, 0, 0); 
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        pointer-events: auto; overflow: hidden;
    }
    .app-window.active { transform: translate3d(0, 0, 0); }
    .app-iframe { width: 100%; height: 100%; border: none; display: block; }

    /* --- TUTORIAL APP STYLES --- */
    .tutorial-content {
        width: 100%; height: 100%; background: #111; color: white;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 40px; text-align: center;
    }
    .tutorial-icon { font-size: 60px; margin-bottom: 20px; animation: bounce 2s infinite; }
    .tutorial-title { font-size: 28px; font-weight: bold; margin-bottom: 20px; }
    .tutorial-step { margin-bottom: 15px; font-size: 18px; color: #ccc; opacity: 0; transform: translateY(20px); animation: fadeUp 0.5s forwards; }
    .tutorial-step:nth-child(2) { animation-delay: 0.2s; }
    .tutorial-step:nth-child(3) { animation-delay: 0.4s; }
    .tutorial-step:nth-child(4) { animation-delay: 0.6s; }
    
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

    /* --- APP SWITCHER (RECENTS) --- */
    .app-switcher {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: transparent; z-index: 40; display: none; 
        overflow-x: auto; overflow-y: hidden;
        white-space: nowrap; scroll-snap-type: x mandatory;
        padding: 0 40px; pointer-events: auto;
    }
    
    .switcher-container { display: inline-flex; height: 100%; align-items: center; gap: 20px; padding-right: 40px; }

    .switcher-card {
        position: relative; width: 75vw; max-width: 300px; height: 70vh;
        background: #222; border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        scroll-snap-align: center; flex-shrink: 0;
        transform-origin: center; transition: transform 0.2s;
        overflow: hidden;
    }
    
    .card-header {
        position: absolute; top: 0; left: 0; width: 100%; height: 40px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        z-index: 20; pointer-events: none;
    }
    
    /* Overlay to capture hold events over the iframe */
    .card-touch-layer {
        position: absolute; top: 40px; left: 0; width: 100%; height: calc(100% - 40px);
        z-index: 15; /* Above iframe, below header */
        /* We rely on JS to toggle pointer-events for this layer */
    }

    /* Small X button for Recents Menu */
    .recents-close-x {
        position: absolute; top: 50px; right: 20px;
        width: 30px; height: 30px; background: rgba(60,60,60,0.8);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: white; font-weight: bold; font-size: 16px; cursor: pointer;
        z-index: 200; backdrop-filter: blur(5px);
        display: none; /* Hidden by default */
    }

    .empty-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #fff; font-size: 16px; pointer-events: none;
    }

    /* --- GESTURE BAR --- */
    .home-indicator { 
        position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; 
        display: flex; justify-content: center; align-items: center; z-index: 999; 
        touch-action: none;
    }
    .home-indicator::before { 
        content: ''; display: block; width: 140px; height: 5px; 
        background: rgba(255,255,255,0.7); border-radius: 3px; 
    }
  </style>
</head>
<body>

<div class="phone">
    <div class="notch"></div>

    <div class="screen">
        <div class="status-bar"><span id="clock">12:00</span><span>5G 100%</span></div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid"></div>
        </div>

        <div class="app-display" id="appDisplay">
            <div id="appWindowContainer"></div>
        </div>

        <div class="app-switcher" id="appSwitcher">
            <div class="switcher-container" id="switcherContainer"></div>
        </div>
        
        <div id="recentsCloseBtn" class="recents-close-x">✕</div>

        <div id="emptyRecents" class="empty-msg" style="display: none;">No Recent Apps</div>
        <div class="home-indicator" id="homeIndicator"></div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'appLauncherOrder_v3';
    const appGrid = document.getElementById('appGrid');
    const appWindowContainer = document.getElementById('appWindowContainer');
    const appSwitcher = document.getElementById('appSwitcher');
    const switcherContainer = document.getElementById('switcherContainer');
    const homeScreen = document.getElementById('homeScreen');
    const emptyRecents = document.getElementById('emptyRecents');
    const recentsCloseBtn = document.getElementById('recentsCloseBtn');
    
    // Core State
    let runningApps = []; 
    let currentAppPath = null;
    let isSwitcherMode = false;

    // --- TUTORIAL APP DEFINITION ---
    const TUTORIAL_APP = {
        id: 999,
        title: "Info",
        icon: "ℹ️",
        path: "system:tutorial",
        class: "info"
    };

    async function init() {
        updateClock(); setInterval(updateClock, 1000);
        await loadApps();
        
        // Home Gesture
        const indicator = document.getElementById('homeIndicator');
        let startY = 0;
        indicator.addEventListener('touchstart', e => { startY = e.touches[0].clientY; e.preventDefault(); });
        indicator.addEventListener('touchend', e => {
            if (e.changedTouches[0].clientY - startY < -40) handleHomeGesture();
        });
        
        // Recents Close Button
        recentsCloseBtn.addEventListener('click', closeSwitcher);

        // Switcher Scroll Active Detection
        appSwitcher.addEventListener('scroll', handleSwitcherScroll);
    }

    async function loadApps() {
        // Render Tutorial Icon First
        renderIcon(TUTORIAL_APP);

        try {
            const res = await fetch('apps.json');
            if (res.ok) {
                let apps = await res.json();
                apps.forEach(renderIcon);
            }
        } catch (e) { console.log("No external apps loaded"); }
    }

    function renderIcon(app) {
        const el = document.createElement('div');
        el.className = 'app-icon-wrapper';
        el.innerHTML = `<div class="app-icon ${app.class || ''}">${app.icon}</div><div class="app-label">${app.title}</div>`;
        
        el.addEventListener('click', () => launchApp(app));
        appGrid.appendChild(el);
    }

    // --- NAVIGATION ---
    function handleHomeGesture() {
        if (currentAppPath) { minimizeApp(); openSwitcher(); }
        else if (isSwitcherMode) closeSwitcher();
        else if (runningApps.length > 0) openSwitcher();
    }

    // --- APP LIFECYCLE ---
    function launchApp(appData) {
        let app = runningApps.find(a => a.path === appData.path);
        
        if (!app) {
            app = createAppInstance(appData);
            runningApps.push(app);
        } else {
            runningApps = runningApps.filter(a => a.path !== appData.path);
            runningApps.push(app);
        }

        closeSwitcher();
        // Restore iframe to window container
        if (app.cardEl) restoreIframeToWindow(app);

        requestAnimationFrame(() => {
            app.windowEl.classList.add('active');
            runningApps.forEach(a => a.windowEl.style.zIndex = 10);
            app.windowEl.style.zIndex = 20;
            homeScreen.classList.add('zoomed-out');
            currentAppPath = app.path;
        });
    }

    function createAppInstance(data) {
        const win = document.createElement('div');
        win.className = 'app-window';
        
        // Special Handling for Tutorial App
        if (data.path === "system:tutorial") {
            win.innerHTML = `
            <div class="tutorial-content">
                <div class="tutorial-icon">ℹ️</div>
                <div class="tutorial-title">Welcome to OS</div>
                <div class="tutorial-step">1. Swipe up from bottom bar to go Home.</div>
                <div class="tutorial-step">2. Hold & Swipe up again for Recents.</div>
                <div class="tutorial-step">3. In Recents: Tap card to Open.</div>
                <div class="tutorial-step">4. In Recents: <b>Hold Card</b> then Swipe Up to Close.</div>
            </div>`;
        } else {
            // Standard App
            const iframe = document.createElement('iframe');
            iframe.className = 'app-iframe';
            iframe.src = data.path;
            // Allow forms/scripts but restrict top nav
            iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups allow-modals');
            win.appendChild(iframe);
        }
        
        appWindowContainer.appendChild(win);
        return { ...data, windowEl: win, cardEl: null };
    }

    function minimizeApp() {
        if (!currentAppPath) return;
        const app = runningApps.find(a => a.path === currentAppPath);
        if (app) app.windowEl.classList.remove('active');
        homeScreen.classList.remove('zoomed-out');
        currentAppPath = null;
    }

    function closeApp(path) {
        const idx = runningApps.findIndex(a => a.path === path);
        if (idx === -1) return;
        const app = runningApps[idx];

        app.windowEl.remove();
        if (app.cardEl) app.cardEl.remove();
        runningApps.splice(idx, 1);

        if (runningApps.length === 0) emptyRecents.style.display = 'block';
        if (currentAppPath === path) currentAppPath = null;
    }

    // --- APP SWITCHER LOGIC ---
    function openSwitcher() {
        isSwitcherMode = true;
        homeScreen.classList.add('zoomed-out');
        appSwitcher.style.display = 'flex';
        recentsCloseBtn.style.display = 'flex';
        emptyRecents.style.display = runningApps.length === 0 ? 'block' : 'none';

        renderSwitcherCards();
        setTimeout(() => {
            if (switcherContainer.lastElementChild) {
                appSwitcher.scrollLeft = switcherContainer.lastElementChild.offsetLeft;
            }
            handleSwitcherScroll();
        }, 10);
    }

    function closeSwitcher() {
        isSwitcherMode = false;
        appSwitcher.style.display = 'none';
        recentsCloseBtn.style.display = 'none';
        homeScreen.classList.remove('zoomed-out');
        emptyRecents.style.display = 'none';
        runningApps.forEach(restoreIframeToWindow);
    }

    function renderSwitcherCards() {
        switcherContainer.innerHTML = '';
        const reversedApps = [...runningApps].reverse();

        reversedApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'switcher-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<span style="color:white; font-size:12px; font-weight:bold;">${app.title}</span>`;
            card.appendChild(header);

            // Touch Layer (The Grip Surface)
            const touchLayer = document.createElement('div');
            touchLayer.className = 'card-touch-layer';
            card.appendChild(touchLayer);

            // Content Area
            const content = document.createElement('div');
            content.style.cssText = "width:100%; height:100%; pointer-events:none;"; 
            // Move content from window to card
            while(app.windowEl.firstChild) { content.appendChild(app.windowEl.firstChild); }
            card.appendChild(content);
            
            // --- GESTURE LOGIC ---
            // 1. Tap to Open
            // 2. Hold to Grip -> Swipe Up to Close
            
            let holdTimer = null;
            let isGripped = false;
            let startY = 0;

            // Touch Start on the Overlay
            touchLayer.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                // Start Hold Timer
                holdTimer = setTimeout(() => {
                    // USER IS HOLDING
                    isGripped = true;
                    // Visual feedback: Shrink card
                    card.style.transform = 'scale(0.95)';
                    if(navigator.vibrate) navigator.vibrate(20);
                }, 300); // 300ms hold time
            });

            touchLayer.addEventListener('touchmove', (e) => {
                if (!isGripped) {
                    // If moving before grip time, cancel grip (it's a scroll or tap attempt)
                    clearTimeout(holdTimer);
                    return;
                }
                
                // If Gripped, allow dragging card
                e.preventDefault(); // Stop scrolling the list
                const dy = e.touches[0].clientY - startY;
                
                if (dy < 0) { // Dragging Up
                    card.style.transition = 'none';
                    card.style.transform = `scale(0.95) translateY(${dy}px)`;
                }
            });

            touchLayer.addEventListener('touchend', (e) => {
                clearTimeout(holdTimer); // Cancel hold if quick tap
                
                if (isGripped) {
                    // Release Logic
                    const dy = e.changedTouches[0].clientY - startY;
                    if (dy < -100) {
                        // Swipe Up Successful -> Close
                        card.style.transition = 'transform 0.3s ease-out';
                        card.style.transform = 'translateY(-100vh)';
                        setTimeout(() => closeApp(app.path), 300);
                    } else {
                        // Snap Back
                        card.style.transition = 'transform 0.2s ease';
                        card.style.transform = 'scale(1)';
                    }
                    isGripped = false;
                } else {
                    // It was a Tap -> Launch
                    launchApp(app);
                }
            });

            switcherContainer.appendChild(card);
            app.cardEl = card;
        });
    }

    function restoreIframeToWindow(app) {
        if (!app.cardEl) return;
        // Move children back to windowEl
        // Specifically look inside the content div we created
        const contentDiv = app.cardEl.children[2]; // 0=Header, 1=TouchLayer, 2=Content
        if(contentDiv) {
             while(contentDiv.firstChild) { app.windowEl.appendChild(contentDiv.firstChild); }
        }
        app.cardEl = null;
    }

    function handleSwitcherScroll() {
        if (!isSwitcherMode) return;
        const centerLine = appSwitcher.scrollLeft + (appSwitcher.clientWidth / 2);
        
        runningApps.forEach(app => {
            if (!app.cardEl) return;
            const card = app.cardEl;
            const touchLayer = card.querySelector('.card-touch-layer');
            const center = card.offsetLeft + (card.offsetWidth/2);
            const dist = Math.abs(center - centerLine);

            if (dist < 50) {
                // Active Card:
                // We keep pointer-events on the touchLayer enabled so we can grab it.
                // We set opacity to full.
                card.style.opacity = 1;
                // NOTE: If you want to interact with the app *inside* the switcher,
                // you would set touchLayer.style.pointerEvents = 'none' here.
                // BUT, your request was "Hold to swipe up". 
                // To support both, we keep the layer but pass clicks through if no hold occurred.
                // Current implementation: Tap layer -> Launch. Hold layer -> Drag. 
                // This mimics iOS "screenshot" state in recents.
            } else {
                card.style.opacity = 0.5;
            }
        });
    }
    
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
    }

    init();
</script>
</body>
</html>
