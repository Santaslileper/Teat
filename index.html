<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Santaslileper OS</title>
  <style>
    /* --- CORE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
        background: #000; display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
        user-select: none; -webkit-user-select: none; cursor: default;
        overflow: hidden;
    }

    /* --- THEME --- */
    .phone { 
        position: relative; width: 100%; height: 100%; max-width: 375px; max-height: 812px;
        background-color: #050505; 
        background-image: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        overflow: hidden; 
        display: flex; flex-direction: column;
        border: 1px solid #333;
    }
    
    /* Desktop Styling */
    @media (min-width: 768px) {
        .phone { height: 812px; border-radius: 50px; box-shadow: 0 0 0 12px #2c2c2e, 0 20px 60px rgba(0,0,0,0.8); }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 180px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 100; }
    }
    
    .screen { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 2; }
    .status-bar { 
        height: 44px; padding: 0 20px; display: flex; align-items: flex-end; justify-content: space-between; 
        padding-bottom: 8px; color: #fff; font-size: 15px; font-weight: 600; 
        z-index: 100; pointer-events: none; position: absolute; width: 100%; top: 0;
    }

    /* --- HOME SCREEN --- */
    .home-screen { 
        padding: 60px 20px 80px 20px; height: 100%; overflow-y: auto;
        transition: transform 0.4s cubic-bezier(0.32, 0, 0.67, 0), filter 0.4s linear;
        will-change: transform, filter;
    }
    .home-screen.zoomed-out {
        transform: scale(0.85);
        filter: brightness(0.6) blur(5px);
        pointer-events: none;
    }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    .app-icon-wrapper { 
        display: flex; flex-direction: column; align-items: center; 
        transition: transform 0.2s ease, box-shadow 0.2s; /* Added transition for smooth return */
        touch-action: none; 
        position: relative; /* Needed for z-index stacking */
    }
    .app-icon-wrapper.dragging-effect {
        box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 5px rgba(255,255,255,0.2);
        cursor: grabbing;
    }
    .app-icon { 
        width: 60px; height: 60px; border-radius: 14px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 30px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #333, #555);
    }
    .app-icon.info { background: linear-gradient(135deg, #3498db, #2980b9); }
    .app-icon:active { filter: brightness(0.8); transform: scale(0.95); }
    .app-label { color: #fff; font-size: 11px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

    /* --- APP WINDOWS --- */
    .app-display { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 50; pointer-events: none;
    }
    .app-window {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff;
        transform: translate3d(100%, 0, 0); 
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        pointer-events: auto; overflow: hidden;
    }
    .app-window.active { transform: translate3d(0, 0, 0); }
    .app-iframe { width: 100%; height: 100%; border: none; display: block; }
    
    /* Grab handle for full-screen apps */
    .app-drag-handle {
        position: absolute; top: 0; left: 0; width: 100%; height: 44px; 
        z-index: 90;
        cursor: grab;
        touch-action: none; 
        background: transparent;
    }

    /* --- APP SWITCHER --- */
    .app-switcher {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: transparent; z-index: 40; 
        display: none; 
        flex-direction: row;
        align-items: center;
        overflow-x: auto; 
        overflow-y: hidden;
        white-space: nowrap; 
        scroll-snap-type: x mandatory;
        padding-left: 20px;
        padding-right: 20px;
        pointer-events: auto;
    }
    
    .switcher-container { 
        display: flex; 
        height: 100%; 
        align-items: center; 
        gap: 20px; 
        min-width: min-content; 
    }

    .switcher-card {
        position: relative; width: 75vw; max-width: 300px; height: 70vh;
        background: #222; border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        scroll-snap-align: center; 
        flex-shrink: 0;
        transform-origin: center; transition: transform 0.2s;
        overflow: hidden;
        touch-action: none;
    }
    
    .card-header {
        position: absolute; top: 0; left: 0; width: 100%; height: 40px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        z-index: 20; pointer-events: none;
    }

    /* Small X button for Recents Menu */
    .recents-close-x {
        position: absolute; top: 50px; right: 20px;
        width: 30px; height: 30px; background: rgba(60,60,60,0.8);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: white; font-weight: bold; font-size: 16px; cursor: pointer;
        z-index: 200; backdrop-filter: blur(5px);
        display: none;
    }

    .empty-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #fff; font-size: 16px; pointer-events: none;
    }

    /* --- TUTORIAL --- */
    .tutorial-content {
        width: 100%; height: 100%; background: #111; color: white;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 40px; text-align: center;
    }
    .tutorial-step { margin-bottom: 15px; font-size: 18px; color: #ccc; }

    /* --- GESTURE BAR --- */
    .home-indicator { 
        position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; 
        display: flex; justify-content: center; align-items: center; z-index: 999; 
        touch-action: none;
    }
    .home-indicator::before { 
        content: ''; display: block; width: 140px; height: 5px; 
        background: rgba(255,255,255,0.7); border-radius: 3px; 
    }
  </style>
</head>
<body>

<div class="phone">
    <div class="notch"></div>
    <div class="screen">
        <div class="status-bar"><span id="clock">12:00</span><span>5G 100%</span></div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid"></div>
        </div>

        <div class="app-display" id="appDisplay">
            <div id="appWindowContainer"></div>
        </div>

        <div class="app-switcher" id="appSwitcher">
            <div class="switcher-container" id="switcherContainer"></div>
        </div>
        
        <div id="recentsCloseBtn" class="recents-close-x">✕</div>
        <div id="emptyRecents" class="empty-msg" style="display: none;">No Recent Apps</div>
        <div class="home-indicator" id="homeIndicator"></div>
    </div>
</div>

<script>
    const appGrid = document.getElementById('appGrid');
    const appWindowContainer = document.getElementById('appWindowContainer');
    const appSwitcher = document.getElementById('appSwitcher');
    const switcherContainer = document.getElementById('switcherContainer');
    const homeScreen = document.getElementById('homeScreen');
    const emptyRecents = document.getElementById('emptyRecents');
    const recentsCloseBtn = document.getElementById('recentsCloseBtn');
    
    // Core State
    let runningApps = []; 
    let currentAppPath = null;
    let isSwitcherMode = false;

    // Icon Drag State
    let draggingIcon = null;
    let initialX, initialY;
    let dragTimeout = null;
    let isDragging = false;
    const DRAG_DELAY = 400; // ms for long press to start drag

    // Hardcoded Tutorial
    const TUTORIAL_APP = { id: 999, title: "Info", icon: "ℹ️", path: "system:tutorial", class: "info" };

    async function init() {
        updateClock(); setInterval(updateClock, 1000);
        await loadApps();
        
        // Home Indicator Swipe Up
        const indicator = document.getElementById('homeIndicator');
        let startY = 0;
        indicator.addEventListener('touchstart', e => { startY = e.touches[0].clientY; e.preventDefault(); });
        indicator.addEventListener('touchend', e => {
            if (e.changedTouches[0].clientY - startY < -40) handleHomeGesture();
        });
        
        recentsCloseBtn.addEventListener('click', closeSwitcher);
        appSwitcher.addEventListener('scroll', handleSwitcherScroll);
    }

    async function loadApps() {
        renderIcon(TUTORIAL_APP);
        try {
            const res = await fetch('apps.json');
            if (res.ok) {
                let apps = await res.json();
                apps.forEach(renderIcon);
            }
        } catch (e) { console.log("No apps.json"); }
    }

    function renderIcon(app) {
        const el = document.createElement('div');
        el.className = 'app-icon-wrapper';
        el.innerHTML = `<div class="app-icon ${app.class || ''}">${app.icon}</div><div class="app-label">${app.title}</div>`;
        
        // App Launch on Click/Tap
        el.addEventListener('click', (e) => {
            if (!isDragging) {
                launchApp(app);
            }
            // isDragging flag is reset in touchend
        });
        
        setupIconDrag(el);
        appGrid.appendChild(el);
    }
    
    // --- ICON DRAG LOGIC (Re-enabled) ---
    function setupIconDrag(iconWrapper) {
        iconWrapper.addEventListener('touchstart', (e) => {
            isDragging = false; 
            iconWrapper.style.transition = 'transform 0.2s ease, box-shadow 0.2s';
            
            initialX = e.touches[0].clientX;
            initialY = e.touches[0].clientY;

            // Start long press timer
            dragTimeout = setTimeout(() => {
                isDragging = true;
                draggingIcon = iconWrapper;
                draggingIcon.style.transition = 'none'; // Disable transition while actively dragging
                draggingIcon.style.zIndex = 100;
                draggingIcon.classList.add('dragging-effect');
                if(navigator.vibrate) navigator.vibrate(50);
            }, DRAG_DELAY);
        }, { passive: true }); // passive: true to allow smooth touchstart

        iconWrapper.addEventListener('touchmove', (e) => {
            const currentClientX = e.touches[0].clientX;
            const currentClientY = e.touches[0].clientY;
            
            // Check for premature movement (treat as scroll/tap, not drag)
            if (!isDragging) {
                if (Math.abs(currentClientX - initialX) > 10 || Math.abs(currentClientY - initialY) > 10) {
                    clearTimeout(dragTimeout);
                    return;
                }
            }
            
            if (isDragging) {
                // Prevent scrolling the home screen while dragging an icon
                e.preventDefault(); 
                const dragX = currentClientX - initialX;
                const dragY = currentClientY - initialY;
                
                draggingIcon.style.transform = `translate(${dragX}px, ${dragY}px) scale(1.1)`;

                // Check for swap target
                checkSwapTarget(currentClientX, currentClientY);
            }
        }, { passive: false }); // passive: false to allow e.preventDefault() on touchmove

        iconWrapper.addEventListener('touchend', (e) => {
            clearTimeout(dragTimeout);
            
            if (draggingIcon) {
                // End drag state
                draggingIcon.style.transition = 'transform 0.3s ease-out, box-shadow 0.3s';
                draggingIcon.style.transform = 'translate(0, 0)'; // Snap back to grid
                draggingIcon.style.zIndex = 1;
                draggingIcon.classList.remove('dragging-effect');
                draggingIcon = null;
            }
            // Reset isDragging after touchend to allow click logic to run next time
            // if it was a quick tap. We wait a moment just in case a final click fires.
            setTimeout(() => { isDragging = false; }, 50); 
        });
    }

    function checkSwapTarget(x, y) {
        if (!draggingIcon) return;

        const appIcons = Array.from(appGrid.children);
        let target = null;

        for (const icon of appIcons) {
            if (icon === draggingIcon) continue;
            const rect = icon.getBoundingClientRect();
            
            // Simple center-point overlap detection
            if (x > rect.left && x < rect.right && y > rect.top && y < rect.bottom) {
                target = icon;
                break;
            }
        }

        if (target) {
            swapIcons(draggingIcon, target);
        }
    }

    function swapIcons(icon1, icon2) {
        const parent = appGrid;
        const icon1Index = Array.from(parent.children).indexOf(icon1);
        const icon2Index = Array.from(parent.children).indexOf(icon2);

        // Get the current translation and scale before swapping DOM
        const currentTransform = icon1.style.transform;
        
        if (icon1Index < icon2Index) {
            parent.insertBefore(icon2, icon1);
        } else {
            parent.insertBefore(icon1, icon2);
        }
        
        // Restore the live transform state on the dragged icon
        icon1.style.transform = currentTransform;
    }


    // --- NAVIGATION ---
    function handleHomeGesture() {
        if (currentAppPath) { minimizeApp(); openSwitcher(); }
        else if (isSwitcherMode) closeSwitcher();
        else if (runningApps.length > 0) openSwitcher();
    }

    // --- APP LIFECYCLE ---
    function launchApp(appData) {
        let existing = runningApps.find(a => a.path === appData.path);
        if (existing) {
            runningApps = runningApps.filter(a => a.path !== appData.path);
            runningApps.push(existing);
        } else {
            let newApp = createAppInstance(appData);
            runningApps.push(newApp);
        }

        closeSwitcher();
        let activeApp = runningApps[runningApps.length - 1];

        if (activeApp.cardEl) restoreIframeToWindow(activeApp);

        requestAnimationFrame(() => {
            activeApp.windowEl.classList.add('active');
            runningApps.forEach(a => a.windowEl.style.zIndex = 10);
            activeApp.windowEl.style.zIndex = 20; 
            homeScreen.classList.add('zoomed-out');
            currentAppPath = activeApp.path;
        });
    }

    function createAppInstance(data) {
        const win = document.createElement('div');
        win.className = 'app-window';
        
        // --- Fullscreen Grab Handle ---
        const dragHandle = document.createElement('div');
        dragHandle.className = 'app-drag-handle';
        win.appendChild(dragHandle);
        setupFullscreenDrag(dragHandle, win);

        if (data.path === "system:tutorial") {
            const content = document.createElement('div');
            content.className = 'tutorial-content';
            content.innerHTML = `
                <div style="font-size:60px; margin-bottom:20px;">ℹ️</div>
                <h2>How to Use</h2><br>
                <div class="tutorial-step">1. Swipe Up bar to go Home.</div>
                <div class="tutorial-step">2. Hold & Swipe Up bar for Recents.</div>
                <div class="tutorial-step">3. Home Screen: <b>Long Press</b> icon to drag and rearrange.</div>
                <div class="tutorial-step">4. Recents: <b>Tap Card</b> to launch.</div>
                <div class="tutorial-step">5. Recents: <b>Hold Card</b> & Swipe Up to Close it.</div>
                <div class="tutorial-step">6. Fullscreen App: Grab <b>top bar</b> and swipe down to minimize.</div>
            `;
            win.appendChild(content);
        } else {
            const iframe = document.createElement('iframe');
            iframe.className = 'app-iframe';
            iframe.src = data.path;
            iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups allow-modals');
            win.appendChild(iframe);
        }
        
        appWindowContainer.appendChild(win);
        return { ...data, windowEl: win, cardEl: null };
    }

    function minimizeApp() {
        if (!currentAppPath) return;
        const app = runningApps.find(a => a.path === currentAppPath);
        if (app) app.windowEl.classList.remove('active');
        homeScreen.classList.remove('zoomed-out');
        currentAppPath = null;
    }

    function closeApp(path) {
        const idx = runningApps.findIndex(a => a.path === path);
        if (idx === -1) return;
        const app = runningApps[idx];

        app.windowEl.remove();
        if (app.cardEl) app.cardEl.remove();
        runningApps.splice(idx, 1);

        if (runningApps.length === 0) emptyRecents.style.display = 'block';
        if (currentAppPath === path) currentAppPath = null;
    }

    // --- FULLSCREEN DRAG LOGIC ---
    function setupFullscreenDrag(handleEl, windowEl) {
        let startY = 0;
        let isDragging = false;

        handleEl.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
            windowEl.style.transition = 'none'; // Disable transition during drag
        });

        handleEl.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const dy = e.touches[0].clientY - startY;
            
            if (dy > 0) { // Only allow downward drag
                e.preventDefault();
                windowEl.style.transform = `translateY(${dy}px)`;
            } else if (dy < 0) {
                windowEl.style.transform = `translateY(0)`;
            }
        });

        handleEl.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            windowEl.style.transition = 'transform 0.2s cubic-bezier(0.19, 1, 0.22, 1)';
            
            const dy = e.changedTouches[0].clientY - startY;

            if (dy > 100) { 
                windowEl.style.transform = `translateY(${windowEl.offsetHeight}px)`;
                setTimeout(() => {
                    windowEl.style.transition = 'none';
                    windowEl.style.transform = 'translate3d(100%, 0, 0)';
                    minimizeApp(); 
                    openSwitcher();
                }, 200);

            } else {
                // Snap back to fullscreen
                windowEl.style.transform = 'translateY(0)';
            }
        });
    }

    // --- SWITCHER LOGIC ---
    function openSwitcher() {
        isSwitcherMode = true;
        homeScreen.classList.add('zoomed-out');
        appSwitcher.style.display = 'flex';
        recentsCloseBtn.style.display = 'flex';
        emptyRecents.style.display = runningApps.length === 0 ? 'block' : 'none';

        renderSwitcherCards();
        
        // Scroll to the end (most recent app)
        setTimeout(() => {
            if (switcherContainer.lastElementChild) {
                const cardWidth = switcherContainer.lastElementChild.offsetWidth;
                const containerWidth = appSwitcher.offsetWidth;
                const scrollPos = switcherContainer.lastElementChild.offsetLeft - (containerWidth / 2) + (cardWidth / 2);
                appSwitcher.scrollLeft = scrollPos;
            }
            handleSwitcherScroll();
        }, 10);
    }

    function closeSwitcher() {
        isSwitcherMode = false;
        appSwitcher.style.display = 'none';
        recentsCloseBtn.style.display = 'none';
        homeScreen.classList.remove('zoomed-out');
        emptyRecents.style.display = 'none';
        runningApps.forEach(restoreIframeToWindow);
    }

    function renderSwitcherCards() {
        switcherContainer.innerHTML = '';
        
        runningApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'switcher-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<span style="color:white; font-size:12px; font-weight:bold;">${app.title}</span>`;
            card.appendChild(header);
            
            // Content
            const content = document.createElement('div');
            content.style.cssText = "width:100%; height:100%; pointer-events:none;"; 
            while(app.windowEl.firstChild) { 
                 const child = app.windowEl.firstChild;
                 // Don't move the fullscreen drag handle to the card preview
                 if (!child.classList || !child.classList.contains('app-drag-handle')) {
                    content.appendChild(child); 
                 } else {
                    app.windowEl.removeChild(child);
                 }
            }
            card.appendChild(content);
            
            // Interaction Logic (Recents Card Gestures)
            let holdTimer = null;
            let isGripped = false;
            let startX = 0;
            let startY = 0;

            card.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isGripped = false;
                
                holdTimer = setTimeout(() => {
                    isGripped = true;
                    card.style.transform = 'scale(0.95)';
                    if(navigator.vibrate) navigator.vibrate(20);
                }, 300);
            });

            card.addEventListener('touchmove', (e) => {
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;

                // If vertical movement significantly outweighs horizontal, cancel tap/scroll
                if (!isGripped && Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 5) {
                     clearTimeout(holdTimer);
                     isGripped = true;
                }

                if (isGripped) {
                    e.preventDefault();
                    if (dy < 0) {
                        card.style.transition = 'none';
                        card.style.transform = `scale(0.95) translateY(${dy}px)`;
                    }
                }
            });

            card.addEventListener('touchend', (e) => {
                clearTimeout(holdTimer);
                
                const dx = Math.abs(e.changedTouches[0].clientX - startX);
                const dyEnd = e.changedTouches[0].clientY - startY;

                if (isGripped) {
                    if (dyEnd < -100) {
                        card.style.transition = 'transform 0.3s ease-out';
                        card.style.transform = 'translateY(-100vh)';
                        setTimeout(() => closeApp(app.path), 300);
                    } else {
                        card.style.transition = 'transform 0.2s ease';
                        card.style.transform = 'scale(1)';
                    }
                    isGripped = false;
                } 
                else if (dx < 10 && Math.abs(dyEnd) < 10) { 
                    launchApp(app);
                }
            });

            switcherContainer.appendChild(card);
            app.cardEl = card;
        });
    }

    function restoreIframeToWindow(app) {
        if (!app.cardEl) return;
        // The children are: 0=Header, 1=Content (where iframe/tutorial is)
        const contentDiv = app.cardEl.children[1]; 
        
        // Move content back to app window
        if(contentDiv) {
             while(contentDiv.firstChild) { app.windowEl.appendChild(contentDiv.firstChild); }
        }
        
        // The fullscreen drag handle was detached, re-attach it to the front
        const dragHandle = app.windowEl.querySelector('.app-drag-handle');
        if (dragHandle) app.windowEl.prepend(dragHandle);

        app.cardEl.remove();
        app.cardEl = null;
    }

    function handleSwitcherScroll() {
        if (!isSwitcherMode) return;
        const centerLine = appSwitcher.scrollLeft + (appSwitcher.clientWidth / 2);
        
        runningApps.forEach(app => {
            if (!app.cardEl) return;
            const card = app.cardEl;
            const center = card.offsetLeft + (card.offsetWidth/2);
            const dist = Math.abs(center - centerLine);

            if (dist < 50) card.style.opacity = 1;
            else card.style.opacity = 0.5;
        });
    }
    
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
    }

    init();
</script>
</body>
</html>

