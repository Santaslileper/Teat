<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1,minimum-scale=1,viewport-fit=cover">
<title>Santaslileper OS v11</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<style>
/* --- CORE STYLES --- */
*{margin:0;padding:0;box-sizing:border-box}
body,html{touch-action:none;overscroll-behavior:none;height:100%;height:100dvh;width:100%;overflow:hidden;background:#000}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;user-select:none;-webkit-user-select:none;color:#fff}
.p{position:relative;background-color:#000;overflow:hidden;display:flex;flex-direction:column;background-position:center;background-size:cover;transition:background-image .3s,background-color .3s;width:100%;height:100%}
@media (min-width:768px){.p{width:auto!important;height:95vh!important;aspect-ratio:9/19.5!important;margin:0 auto!important;position:absolute!important;top:50%!important;left:50%!important;transform:translate(-50%,-50%)!important;border-radius:40px!important;box-shadow:0 0 0 10px #2c2c2e;border:2px solid #333}}

/* SAFE AREA */
:root { --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }

/* LOCK SCREEN */
#lock-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);z-index:10000;display:flex;flex-direction:column;align-items:center;transition:transform .4s cubic-bezier(.2,.8,.2,1);padding-top: calc(100px + var(--safe-top));}
#ls-clock{font-size:80px;font-weight:200;text-shadow:0 2px 10px rgba(0,0,0,.3)}
#ls-date{font-size:20px;font-weight:500;margin-top:-10px;opacity:.9}
.swipe-hint{position:absolute;bottom:30px;width:100%;text-align:center;font-size:14px;opacity:.7;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.4;transform:translateY(0)}50%{opacity:1;transform:translateY(-5px)}}

/* HOME SCREEN */
.h{position:absolute;top:0;left:0;right:0;bottom:0;padding-top: calc(20px + var(--safe-top));transition:transform .4s,filter .4s;overflow-y:auto;overflow-x:hidden;display:block}
.h.zo{transform:scale(.85);filter:brightness(.6) blur(5px);pointer-events:none}
#ag{position:relative;width:100%;min-height:100vh;padding-bottom:200px}

/* GRID ITEMS */
.grid-item{position:absolute;transition:left .3s cubic-bezier(.34,1.56,.64,1),top .3s cubic-bezier(.34,1.56,.64,1);touch-action:none;z-index:10}
.grid-item.resizing{transition:none;z-index:100;opacity:.9;background:rgba(44,44,46,.9)!important;border:1px solid #007aff!important;border-radius:20px}
.edit-mode .grid-item:not(.resizing):not(.dragging){animation:jiggle .3s infinite linear;cursor:grab}
.edit-mode .grid-item.dragging{z-index:100;animation:none;transform:scale(1.1);opacity:.8;transition:none}
@keyframes jiggle{0%{transform:rotate(-1.5deg)}50%{transform:rotate(1.5deg)}100%{transform:rotate(-1.5deg)}}

/* APP ICONS */
.aiw{width:80px;height:95px;display:flex;flex-direction:column;align-items:center}
.ai{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.3);background:linear-gradient(135deg,#333,#555)}
.al{color:#fff;font-size:11px;margin-top:5px;text-shadow:0 1px 2px rgba(0,0,0,.8);text-align:center;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ai.store{background:linear-gradient(135deg,#007aff,#00c6ff)}.ai.motion{background:linear-gradient(135deg,#5e5ce6,#3b3a99)}.ai.torch{background:linear-gradient(135deg,#ff9f0a,#d48200)}.ai.speaker{background:linear-gradient(135deg,#30d158,#1ea340)}.ai.camera{background:linear-gradient(135deg,#ff375f,#d61e42)}.ai.mic{background:linear-gradient(135deg,#0a84ff,#0056b3)}.ai.touch{background:linear-gradient(135deg,#32ade6,#007aff)}.ai.settings{background:linear-gradient(135deg,#8e8e93,#636366)}

/* WIDGETS */
.widget{background:0 0;border-radius:20px;overflow:hidden;color:#fff;display:flex;flex-direction:column}
.edit-mode .widget{background:rgba(30,41,59,.6);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.15)}
.widget-content{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:10px;text-align:center;width:100%;height:100%;overflow:hidden;text-shadow:0 2px 8px rgba(0,0,0,.6)}

/* EDIT CONTROLS */
.del-btn{position:absolute;top:-5px;left:0;width:22px;height:22px;background:rgba(255,255,255,.3);backdrop-filter:blur(5px);border-radius:50%;display:none;z-index:20;color:#fff;font-weight:700;font-size:14px;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,.3);border:1px solid rgba(0,0,0,.1)}
.del-btn::after{content:'‚úï'}
.resize-handle{position:absolute;bottom:0;right:0;width:40px;height:40px;z-index:30;display:none}
.resize-handle::after{content:'';position:absolute;bottom:8px;right:8px;width:15px;height:15px;border-bottom:3px solid #fff;border-right:3px solid #fff;border-radius:2px}
.edit-mode .del-btn,.edit-mode .resize-handle{display:flex}
.aiw .del-btn{top:-8px;left:0;background:#333;color:#fff}

/* APP WINDOW */
.aw{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;transform:translate3d(100%,0,0);transition:transform .4s cubic-bezier(.19,1,.22,1);z-index:50;display:flex;flex-direction:column}
.aw.ac{transform:translate3d(0,0,0)}
.app-header{height: calc(44px + var(--safe-top));padding-top: var(--safe-top);display:flex;align-items:center;justify-content:space-between;padding-left:15px;padding-right:15px;background:rgba(20,20,20,.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.1);z-index:60}
.ah-title{font-weight:600;font-size:15px;display:flex;align-items:center;gap:8px}.ah-btn{width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;color:#007aff;text-decoration:none;font-size:14px}
.awc{flex:1;width:100%;position:relative;background:#fff;overflow-x:hidden;overflow-y:auto;touch-action:pan-y;overscroll-behavior-x:none}.awc.r90{overflow:hidden!important}
iframe.aif{width:100%;height:100%;border:none;display:block}
.blocked-layer{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1c1c1e;color:#fff;text-align:center;padding:20px;z-index:1}

/* STORE STYLES (Restored) */
.store-app{background:#1c1c1e;color:#fff;height:100%;width:100%;display:flex;flex-direction:column;touch-action:pan-y;overscroll-behavior-x:none;overflow-x:hidden!important}
.store-header{padding:50px 20px 10px;background:rgba(28,28,30,.9);backdrop-filter:blur(10px);position:sticky;top:0;z-index:10;border-bottom:1px solid #333}
.store-title{font-size:30px;font-weight:bold;margin-bottom:10px}.store-search{width:100%;background:#2c2c2e;border:none;padding:10px 15px;border-radius:10px;color:#fff;font-size:16px;outline:none}
.store-grid{padding:20px;overflow-y:auto;overflow-x:hidden;flex:1;display:grid;grid-template-columns:1fr;gap:15px;width:100%;box-sizing:border-box}
.store-item{background:#2c2c2e;padding:15px;border-radius:16px;display:flex;align-items:center;gap:15px}
.store-icon{width:50px;height:50px;border-radius:12px;font-size:24px;display:flex;align-items:center;justify-content:center;background:#333}
.store-info{flex:1}.store-name{font-weight:600;font-size:16px;margin-bottom:4px}.store-cat{font-size:12px;color:#8e8e93}
.store-btn{background:#2c2c2e;color:#007aff;border:none;font-weight:bold;font-size:14px;padding:6px 14px;border-radius:14px;cursor:pointer;background:rgba(0,122,255,.15);transition:.2s;white-space:nowrap}
.store-btn.installed{background:#333;color:#888;pointer-events:none}

/* SWITCHER */
.as{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:40;display:none;flex-direction:row;align-items:center;overflow-x:auto;padding:0 calc(50vw - 35vw);scroll-snap-type:x mandatory}
.sc{display:flex;height:100%;align-items:center;gap:20px;padding-left:20px;padding-right:20px}
.scd{position:relative;width:70vw;max-width:300px;height:65vh;background:#222;border-radius:20px;scroll-snap-align:center;flex-shrink:0;overflow:hidden;transform:scale(1);box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;flex-direction:column}
.scd iframe,.scd .blocked-layer,.scd .store-app,.scd .tc{pointer-events:none}
.ch{height:40px;display:flex;align-items:center;justify-content:center;background:#333;color:#fff;font-size:12px;font-weight:bold;flex-shrink:0}
.em{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;font-size:18px;display:none;text-align:center;pointer-events:none}

/* ADD MENU (Fixed Scroll) */
#add-panel{position:fixed;bottom:-600px;left:0;width:100%;max-height:70vh;overflow-y:auto;background:#1c1c1e;border-radius:20px 20px 0 0;z-index:300;padding:20px;transition:bottom .3s;display:flex;flex-direction:column;gap:10px}
#add-panel.open{bottom:0}
.add-opt{padding:15px;background:#2c2c2e;color:#fff;border-radius:12px;display:flex;align-items:center;gap:10px}

/* EDIT BUTTONS (Hidden by default) */
#edit-ui{position:fixed;bottom:40px;left:20px;right:20px;height:50px;display:flex;justify-content:center;gap:15px;z-index:200;pointer-events:none;opacity:0;transition:opacity 0.3s}
.edit-mode #edit-ui{opacity:1;pointer-events:auto}
.ui-btn{padding:10px 20px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:none;border-radius:20px;color:#fff;font-weight:600}

/* SETTINGS UI */
.tc{padding:60px 20px;color:#fff;text-align:center;background:#000;height:100%;overflow-y:auto;touch-action:pan-y;overscroll-behavior-x:none}
.sg{max-width:320px;margin:20px auto;text-align:left}.sh{font-size:13px;color:#888;margin-bottom:8px;padding-left:15px;text-transform:uppercase}
.so{background:#1c1c1e;border-radius:12px;overflow:hidden}.si{padding:12px 15px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}.si:last-child{border-bottom:none}
select,input{background:#333;color:#fff;border:none;padding:5px 10px;border-radius:6px}.sr{display:flex;align-items:center;gap:10px}.sl{font-size:16px}
.bgp{width:100px;height:60px;border-radius:6px;background-size:cover;background-position:center;border:2px solid #3a3a3c;cursor:pointer}
.fb{padding:5px 10px;background:#007aff;border-radius:5px;border:none;color:white;cursor:pointer}.db{background:#ff3b30!important}input[type="file"]{display:none}

/* FORCED NOTCH */
body.force-notch .app-header { padding-top: 47px !important; height: 91px !important; }
body.force-notch .h { padding-top: 60px !important; }
body.force-notch #lock-screen { padding-top: 140px !important; }
</style>
</head>
<body>

<div class="p" id="phone">
    <div id="lock-screen"><div style="font-size:40px;margin-bottom:10px">üîì</div><div id="ls-clock">12:00</div><div id="ls-date">Wednesday</div><div class="swipe-hint">Swipe up</div></div>
    
    <div class="h" id="h"><div id="ag"></div></div>
    
    <div class="aw" id="app-window">
        <div class="app-header">
            <div class="ah-title"><span id="aw-icon"></span><span id="aw-title">App</span><span style="font-size:10px;opacity:0.5;margin-left:5px;cursor:pointer" onclick="rotateApp()">üîÑ</span></div>
            <a href="#" target="_blank" id="aw-link" class="ah-btn">‚Üó</a>
        </div>
        <div class="awc" id="awc"></div>
    </div>
    
    <div class="as" id="switcher"><div class="sc" id="scc"></div><div class="em" id="empty-msg">No Recent Apps<br><span style="font-size:14px;opacity:0.6">Tap to close</span></div></div>
    
    <div class="hi" id="hi"></div>
    <div id="edit-ui"><button class="ui-btn" onclick="openAddPanel()">+ Widget</button><button class="ui-btn" style="background:#007aff" onclick="toggleEdit(false)">Done</button></div>
</div>

<div id="add-panel">
    <h3 style="color:#fff;margin-bottom:15px;text-align:center">Add Widget</h3>
    <div class="add-opt" onclick="addWidget('clock')">‚è∞ Clock</div>
    <div class="add-opt" onclick="addWidget('weather')">‚òÅÔ∏è Real Weather</div>
    <div class="add-opt" onclick="addWidget('qrcode')">üèÅ QR Gen</div>
    <div class="add-opt" onclick="addWidget('search')">üîç Google Bar</div>
    <div class="add-opt" onclick="addWidget('calendar')">üìÖ Calendar</div>
    <div class="add-opt" onclick="closeAddPanel()">Cancel</div>
</div>

<script>
/* --- CONFIG & DATA --- */
const COL_COUNT=4,ROW_HEIGHT=100;
let SCREEN_W=document.getElementById("ag").clientWidth||window.innerWidth;
let COL_WIDTH=SCREEN_W/COL_COUNT;
let items=[],runningApps=[],currentApp=null,isEditMode=!1,isSwitcherMode=!1;
const STORAGE_KEY='santas_os_v11_layout', PREFS={t:'os_theme',f:'os_font',bg:'os_bg'};

const STORE_APPS=[
    {id:'teat',title:"Test Page",icon:"üöß",url:"https://santaslileper.github.io/Teat/",cat:"Dev",class:"settings"},
    {id:'yt',title:"YouTube",icon:"üì∫",url:"https://www.youtube.com/embed",cat:"Video",class:"camera"},
    {id:'grapple',title:"Grapple",icon:"ü™ù",url:"page3.html",cat:"Games",class:"motion"},
    {id:'minecraft',title:"Minecraft",icon:"üß±",url:"https://classic.minecraft.net",cat:"Games",class:"touch"},
    {id:'bing',title:"Bing",icon:"üîç",url:"https://www.bing.com",cat:"Search",class:"touch"},
    {id:'files',title:"Files",icon:"üóÉÔ∏è",url:"page17.html",cat:"System",class:"camera"},
    {id:'calc',title:"Calculator",icon:"üßÆ",url:"https://www.desmos.com/scientific",cat:"Utilities",class:"torch"},
    {id:'vscode',title:"VS Code",icon:"üíª",url:"https://vscode.dev",cat:"Dev",class:"motion"},
    {id:'photopea',title:"Photopea",icon:"üé®",url:"https://www.photopea.com",cat:"Creative",class:"camera"}
];

/* --- INIT --- */
function init(){
    updateClock();setInterval(updateClock,1000);setupLockScreen();applyPreferences();setupSwitcherClick();checkSafeAreas();checkPlatform();
    
    // Load Saved Layout or Defaults
    const saved=localStorage.getItem(STORAGE_KEY);
    if(saved){try{const data=JSON.parse(saved);data.forEach(d=>createItem(d.type,d.x,d.y,d.cols,d.rows,d))}catch(e){loadDefaults()}}else{loadDefaults()}
    
    // Long Press Gesture
    const grid=document.getElementById("ag");let pressTimer;
    grid.addEventListener("touchstart",e=>{if(e.target===grid||e.target.classList.contains("aiw")){pressTimer=setTimeout(()=>{if(navigator.vibrate)navigator.vibrate(50);toggleEdit(!0)},800)}});
    grid.addEventListener("touchend",()=>clearTimeout(pressTimer));
    
    setupHomeGesture();window.addEventListener("resize",checkOrientation);
    fetchWeather(); // Get Real Weather
}

function loadDefaults(){
    createItem('widget',0,0,2,2,{subtype:'clock'});
    createItem('widget',2*COL_WIDTH,0,2,2,{subtype:'weather'});
    const defs=[
        {title:"App Store",icon:"üÖ∞Ô∏è",path:"system:store",class:"store"},
        {title:"Settings",icon:"‚öôÔ∏è",path:"system:settings",class:"settings"},
        {title:"Grapple",icon:"ü™ù",path:"page3.html",class:"motion"},
        {title:"Bing",icon:"üîç",path:"https://www.bing.com",class:"touch"}
    ];
    defs.forEach((app,i)=>{createItem('app',(i%4)*COL_WIDTH,(2+Math.floor(i/4))*ROW_HEIGHT,1,1,app)});
    saveLayout();
}

/* --- ITEM CREATION (Fixes: UIDs + Content Fit) --- */
function createItem(type,x,y,cw,ch,data){
    const el=document.createElement("div");el.className="grid-item";
    const w=cw*COL_WIDTH-(type==="app"?0:15), h=ch*ROW_HEIGHT-(type==="app"?10:15);
    if(data.w)el.style.width=data.w+"px";if(data.h)el.style.height=data.h+"px";
    
    // Unique ID for Widgets
    const uid = 'w-' + Date.now() + '-' + Math.floor(Math.random()*1000);

    let inner='';
    if(type==="app"){
        el.classList.add("aiw");
        inner=`<div class="del-btn"></div><div class="ai ${data.class||'touch'}">${data.icon}</div><div class="al">${data.title}</div>`;
        el.onclick=()=>{if(!isEditMode)launchApp(data)};
    }else{
        el.classList.add("widget");
        inner=`<div class="del-btn"></div><div class="resize-handle"></div><div class="widget-content" id="wc-${uid}">${getWidgetHTML(data.subtype, uid)}</div>`;
    }
    
    el.innerHTML=inner;
    el.querySelector(".del-btn").onclick=e=>{e.stopPropagation();deleteItem(el)};
    document.getElementById("ag").appendChild(el);
    
    const item={el,type,subtype:data.subtype,x,y,w:parseFloat(el.style.width)||w,h:parseFloat(el.style.height)||h,cols:cw,rows:ch,uid,...data};
    items.push(item);
    updateVisuals(item);
    if(type==="widget")setupResize(item);
    setupDrag(item);
    updateContainer();
    return item;
}

/* --- WIDGET HTML GENERATORS --- */
function getWidgetHTML(type, uid){
    if(type==="clock") return `<h1 style="margin:0;font-size:32px;font-weight:300" id="w-clock-${uid}">--:--</h1><div style="font-size:10px;opacity:0.7">LOCAL</div>`;
    
    if(type==="weather") return `
        <div style="font-size:32px" class="w-icon">‚è≥</div>
        <div style="font-size:22px;font-weight:bold" class="w-temp">--¬∞</div>
        <div style="font-size:9px;opacity:0.7;margin-top:2px">Tap to update</div>`;
        
    if(type==="qrcode") return `
        <div style="display:flex;flex-direction:column;align-items:center;width:100%;height:100%;gap:5px;padding:2px">
            <img id="qr-img-${uid}" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=OS" style="height:60%;aspect-ratio:1/1;background:#fff;border-radius:4px">
            <div style="display:flex;width:100%;gap:2px">
                <input id="qr-in-${uid}" type="text" placeholder="Text..." style="flex:1;font-size:10px;background:#333;color:white;border:none;border-radius:4px;padding:2px" onmousedown="event.stopPropagation()">
                <button onclick="genQR('${uid}')" style="background:#007aff;color:fff;border:none;border-radius:4px;font-size:10px;padding:0 4px" onmousedown="event.stopPropagation()">Go</button>
            </div>
        </div>`;

    if(type==="search") return `<div style="width:95%;height:35px;background:#fff;border-radius:20px;display:flex;align-items:center;padding:0 10px;box-shadow:0 2px 10px rgba(0,0,0,0.2);"><span style="font-size:16px;margin-right:5px;color:#000">üîç</span><input type="text" placeholder="Search..." style="flex:1;border:none;background:transparent;color:#000;font-size:12px;outline:none;" onkeydown="if(event.key==='Enter') runSearch(this.value)" ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()"></div>`;
    
    if(type==="calendar") return `<div style="color:#ff3b30;font-weight:bold">OCT</div><div style="font-size:36px">10</div>`;
    return "";
}

/* --- LOGIC: QR, WEATHER, SEARCH --- */
function genQR(uid){ const t=document.getElementById('qr-in-'+uid).value; if(t) document.getElementById('qr-img-'+uid).src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data="+encodeURIComponent(t); }
function runSearch(q){ if(q) launchApp({title:"Google",icon:"üîç",path:"https://www.google.com/search?igu=1&q="+encodeURIComponent(q)}); }
function fetchWeather(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(p=>{
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`)
        .then(r=>r.json()).then(d=>{
            document.querySelectorAll('.w-temp').forEach(e=>e.innerText=Math.round(d.current_weather.temperature)+"¬∞C");
            const c=d.current_weather.weathercode, icons={0:"‚òÄÔ∏è",1:"üå§Ô∏è",3:"‚òÅÔ∏è",45:"üå´Ô∏è",61:"üåßÔ∏è",71:"‚ùÑÔ∏è",95:"‚õàÔ∏è"};
            document.querySelectorAll('.w-icon').forEach(e=>e.innerText=icons[c]||"‚òÅÔ∏è");
        })
    });
}
function updateClock(){
    const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    document.getElementById("ls-clock").innerText=t;
    items.filter(i=>i.subtype==='clock').forEach(i=>{
        const el=document.getElementById(`w-clock-${i.uid}`); if(el) el.innerText=t;
    });
}

/* --- APP LAUNCHER & SYSTEM APPS --- */
function launchApp(data){
    let app=runningApps.find(a=>a.path===data.path);
    if(!app){app={...data,dom:createAppDOM(data)};runningApps.push(app)}
    const aw=document.getElementById("app-window"),awc=document.getElementById("awc"),link=document.getElementById("aw-link");
    document.getElementById("aw-title").innerHTML=`<span style="margin-right:5px">${data.icon}</span>${data.title}`;
    if(data.path.startsWith("http")){link.style.display="flex";link.href=data.path}else{link.style.display="none"}
    if(!awc.contains(app.dom)) awc.appendChild(app.dom);
    Array.from(awc.children).forEach(c=>c.style.display='none');
    app.dom.style.display='block'; currentApp=app;
    aw.classList.add("ac"); document.getElementById("h").classList.add("zo"); closeSwitcher();
}

function createAppDOM(data){
    const d=document.createElement("div");d.style.cssText="width:100%;height:100%;background:#fff;";
    if(data.path==="system:store"){renderAppStore(d)}
    else if(data.path==="system:settings"){renderSettings(d)}
    else{d.innerHTML=`<iframe src="${data.path}" class="aif" allow="autoplay;fullscreen;geolocation;microphone;camera" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-modals"></iframe>`}
    return d;
}

/* --- SETTINGS & STORE LOGIC (RESTORED) --- */
function renderSettings(c){
    c.innerHTML=`<div class="tc"><div style="font-size:60px;margin-bottom:20px;color:#000">‚öôÔ∏è</div><h2 style="margin-bottom:30px;color:#000">Settings</h2><div class="sg"><div class="sh">Appearance</div><div class="so"><div class="si"><span class="sl">Theme</span><div class="sr"><select id="tsl"><option value="dark">Dark</option><option value="light">Light</option><option value="blue">Blue</option></select></div></div><div class="si"><span class="sl">Wall</span><div class="sr"><div class="bgp" id="bgp"></div><label for="bgi" class="fb">Img</label><input type="file" id="bgi" accept="image/*"></div></div></div></div><div class="sg"><div class="sh">System</div><div class="so"><div class="si"><span class="sl">Reset OS</span><div class="sr"><button class="fb db" onclick="resetOS()">Reset</button></div></div></div></div></div>`;
    setTimeout(()=>{
        const bgp=c.querySelector('#bgp'),bgi=c.querySelector('#bgi');
        if(gv(PREFS.bg)) bgp.style.backgroundImage=`url(${gv(PREFS.bg)})`;
        bgi.onchange=e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>{sv(PREFS.bg,ev.target.result);bgp.style.backgroundImage=`url(${ev.target.result})`;applyPreferences()};r.readAsDataURL(f)}};
    },100);
}

function renderAppStore(c){
    c.innerHTML=`<div class="store-app"><div class="store-header"><div class="store-title">App Store</div><input type="text" class="store-search" placeholder="Search..." onkeyup="filterStore(this.value)"></div><div class="store-grid" id="store-grid"></div></div>`;
    const g=c.querySelector("#store-grid");
    STORE_APPS.forEach(app=>{
        const inst=items.some(i=>i.path===app.url),el=document.createElement("div");
        el.className="store-item";el.setAttribute("data-name",app.title.toLowerCase());
        el.innerHTML=`<div class="store-icon">${app.icon}</div><div class="store-info"><div class="store-name">${app.title}</div><div class="store-cat">${app.cat}</div></div><button class="store-btn ${inst?'installed':''}" onclick="installApp('${app.id}',this)">${inst?'Added':'Get'}</button>`;
        g.appendChild(el);
    });
}
function installApp(id,btn){
    const app=STORE_APPS.find(a=>a.id===id);
    if(app){const s=findNextEmptySpot(1,1);createItem('app',s.x,s.y,1,1,{title:app.title,icon:app.icon,path:app.url,class:app.class});saveLayout();btn.innerText="Added";btn.classList.add("installed");}
}
function filterStore(v){const q=v.toLowerCase();document.querySelectorAll(".store-item").forEach(e=>e.style.display=e.getAttribute("data-name").includes(q)?"flex":"none")}

/* --- SWITCHER & SYSTEM --- */
function openSwitcher(){isSwitcherMode=!0;document.getElementById("switcher").style.display="flex";document.getElementById("scc").innerHTML="";runningApps.forEach(a=>{const c=document.createElement("div");c.className="scd";c.innerHTML=`<div class="ch">${a.title}</div><div class="card-body" style="flex:1;background:#fff;overflow:hidden"></div>`;c.querySelector(".card-body").appendChild(a.dom);a.dom.style.display='block';c.onclick=e=>{e.stopPropagation();launchApp(a)};document.getElementById("scc").appendChild(c)})}
function closeSwitcher(){isSwitcherMode=!1;document.getElementById("switcher").style.display="none";document.getElementById("h").classList.remove("zo");if(currentApp)launchApp(currentApp)}
function setupSwitcherClick(){document.getElementById("switcher").onclick=e=>{if(e.target.id==="switcher")closeSwitcher()}}
function setupHomeGesture(){const h=document.getElementById("hi");let sy=0;h.addEventListener("touchstart",e=>sy=e.touches[0].clientY);h.addEventListener("touchend",e=>{if(e.changedTouches[0].clientY-sy<-30){if(currentApp){minimizeApp();openSwitcher()}else if(!isSwitcherMode&&runningApps.length)openSwitcher()}})}
function minimizeApp(){document.getElementById("app-window").classList.remove("ac");currentApp=null}
function resetOS(){if(confirm("Reset?")){localStorage.clear();location.reload()}}
function gv(k,d){return localStorage.getItem(k)||d}function sv(k,v){localStorage.setItem(k,v)}
function applyPreferences(){const b=gv(PREFS.bg,'');if(b){document.getElementById('phone').style.backgroundImage=`url(${b})`;}}
function checkPlatform(){if(!/Mobi/i.test(navigator.userAgent)&&window.innerWidth>768)window.location.href="indexpc.html"}
function checkSafeAreas(){if(/iPhone/.test(navigator.userAgent)&&window.navigator.standalone)document.body.classList.add("force-notch")}
function rotateApp(f){const c=document.getElementById("awc");const r=c.classList.contains("r90");if(f!==undefined?f:!r){c.classList.add("r90");c.style.width=document.getElementById("app-window").offsetHeight+"px";c.style.height=document.getElementById("app-window").offsetWidth+"px"}else{c.classList.remove("r90");c.style.width="";c.style.height=""}}

/* --- DRAG & DROP UTILS --- */
function findNextEmptySpot(w,h){let o=0;for(;;){for(let i=0;i<COL_COUNT;i++){if(i+w>COL_COUNT)continue;const d=i*COL_WIDTH,s=o*ROW_HEIGHT;if(!items.some(n=>d<n.x+n.w && d+w*COL_WIDTH>n.x && s<n.y+n.h && s+h*ROW_HEIGHT>n.y))return{x:d,y:s}}o++;if(o>200)return{x:0,y:o*ROW_HEIGHT}}}
function updateVisuals(i){i.el.style.left=i.x+"px";i.el.style.top=i.y+"px";i.el.style.width=i.w+"px";i.el.style.height=i.h+"px"}
function updateContainer(){let max=0;items.forEach(i=>max=Math.max(max,i.y+i.h));document.getElementById("ag").style.minHeight=(max+300)+"px"}
function saveLayout(){const d=items.map(i=>({type:i.type,subtype:i.subtype,x:i.x,y:i.y,cols:i.cols,rows:i.rows,w:i.w,h:i.h,title:i.title,icon:i.icon,path:i.path,class:i.class}));localStorage.setItem(STORAGE_KEY,JSON.stringify(d))}
function toggleEdit(v){isEditMode=v;document.body.classList.toggle("edit-mode",v);if(!v){closeAddPanel();saveLayout()}}
function openAddPanel(){document.getElementById("add-panel").classList.add("open")}
function closeAddPanel(){document.getElementById("add-panel").classList.remove("open")}
function addWidget(t){closeAddPanel();const s=findNextEmptySpot(2,2);createItem('widget',s.x,s.y,2,2,{subtype:t});saveLayout()}
function deleteItem(el){const i=items.findIndex(x=>x.el===el);if(i>-1){items.splice(i,1);el.remove();saveLayout()}}
function setupDrag(item){let sx,sy,sl,st;const move=e=>{const cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;item.el.style.left=(sl+cx-sx)+"px";item.el.style.top=(st+cy-sy)+"px";e.preventDefault()};const end=()=>{document.removeEventListener("touchmove",move);document.removeEventListener("touchend",end);item.el.classList.remove("dragging");let nx=Math.round(parseFloat(item.el.style.left)/COL_WIDTH)*COL_WIDTH,ny=Math.round(parseFloat(item.el.style.top)/ROW_HEIGHT)*ROW_HEIGHT;if(nx<0)nx=0;if(nx>SCREEN_W-item.w)nx=SCREEN_W-item.cols*COL_WIDTH;if(ny<0)ny=0;item.x=nx;item.y=ny;items.filter(i=>i!==item).forEach(o=>{if(nx<o.x+o.w&&nx+item.w>o.x&&ny<o.y+o.h&&ny+item.h>o.y){const f=findNextEmptySpot(o.cols,o.rows);o.x=f.x;o.y=f.y;updateVisuals(o)}});updateVisuals(item);updateContainer();saveLayout()};const start=e=>{if(isEditMode&&!e.target.className.includes("resize")&&!e.target.className.includes("del")){item.el.classList.add("dragging");sx=e.touches?e.touches[0].clientX:e.clientX;sy=e.touches?e.touches[0].clientY:e.clientY;sl=parseFloat(item.el.style.left);st=parseFloat(item.el.style.top);document.addEventListener("touchmove",move,{passive:!1});document.addEventListener("touchend",end)}};item.el.addEventListener("touchstart",start,{passive:!1})}
function setupResize(item){const h=item.el.querySelector(".resize-handle");let sx,sy,sw,sh;const move=e=>{const cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;item.el.style.width=(sw+(cx-sx))+"px";item.el.style.height=(sh+(cy-sy))+"px";e.stopPropagation();e.preventDefault()};const end=()=>{document.removeEventListener("touchmove",move);document.removeEventListener("touchend",end);item.el.classList.remove("resizing");const nw=parseFloat(item.el.style.width),nh=parseFloat(item.el.style.height);item.cols=Math.max(1,Math.round(nw/COL_WIDTH));item.rows=Math.max(1,Math.round(nh/ROW_HEIGHT));item.w=item.cols*COL_WIDTH-15;item.h=item.rows*ROW_HEIGHT-15;item.el.querySelector(".widget-content").innerHTML=getWidgetHTML(item.subtype,item.uid);updateVisuals(item);saveLayout()};h.addEventListener("touchstart",e=>{e.stopPropagation();item.el.classList.add("resizing");sx=e.touches[0].clientX;sy=e.touches[0].clientY;sw=item.w;sh=item.h;document.addEventListener("touchmove",move,{passive:!1});document.addEventListener("touchend",end)})}

init();
</script>
</body>
</html>
