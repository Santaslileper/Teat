<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Santaslileper OS</title>
  <style>
    /* --- CORE STYLES & RESET --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
        background: #000; display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
        user-select: none; -webkit-user-select: none; cursor: default;
        overflow: hidden;
    }

    /* --- THEME: BACKGROUND & OVERLAY --- */
    .phone { 
        position: relative; width: 100%; height: 100%; max-width: 375px; max-height: 812px;
        background-color: #111; /* Fallback Dark Slate */
        /* --- üé® OPTIONAL: ADD YOUR BACKGROUND IMAGE HERE --- */
        /* background-image: url('YOUR_IMAGE_PATH_HERE.jpg'); */
        background-size: cover;
        background-position: center;
        overflow: hidden; 
        display: flex; flex-direction: column;
    }
    /* Subtle Glow/Overlay Effect */
    .phone::after {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.2); /* Semi-opaque dark layer for soft look */
        z-index: 1; 
        pointer-events: none;
    }

    /* --- PHONE FRAME & UI --- */
    .status-bar { 
        height: 44px; padding: 0 20px; display: flex; align-items: flex-end; justify-content: space-between; 
        padding-bottom: 8px; color: #fff; font-size: 15px; font-weight: 600; 
        z-index: 100; pointer-events: none;
        position: absolute; width: 100%; top: 0; left: 0;
    }
    
    /* Home Indicator (The Gesture Target and VISUAL Bar) */
    .home-indicator { 
        position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; 
        display: flex; justify-content: center; align-items: center; z-index: 999; 
        touch-action: none;
    }
    /* The visible bar */
    .home-indicator::before { 
        content: ''; 
        display: block; 
        width: 140px; 
        height: 5px; 
        background: rgba(255,255,255,0.7); /* Brighter bar for contrast */
        border-radius: 3px; 
    }

    /* --- LAYOUT CONTAINERS --- */
    /* Desktop Phone styling */
    @media (min-width: 768px) {
        .phone { height: 812px; border-radius: 50px; box-shadow: 0 0 0 12px #2c2c2e, 0 20px 60px rgba(0,0,0,0.8); }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 180px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 100; }
    }
    
    .screen { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 2; /* Above the ::after overlay */ }

    /* --- HOME SCREEN --- */
    .home-screen { 
        padding: 60px 20px 80px 20px; height: 100%; overflow-y: auto;
        transition: transform 0.4s cubic-bezier(0.32, 0, 0.67, 0), filter 0.4s linear;
        will-change: transform, filter;
    }
    .home-screen.zoomed-out {
        transform: scale(0.85);
        filter: brightness(0.7) blur(10px); /* Slightly lighter blur */
        pointer-events: none;
    }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    /* Icons */
    .app-icon-wrapper { 
        display: flex; flex-direction: column; align-items: center; 
        transition: transform 0.2s ease;
        touch-action: none; 
    }
    .app-icon { 
        width: 60px; height: 60px; border-radius: 14px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 30px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #333, #555);
    }
    /* Icon Gradients (kept same) */
    .app-icon.camera { background: linear-gradient(135deg, #667eea, #764ba2); }
    .app-icon.mic { background: linear-gradient(135deg, #f093fb, #f5576c); }
    .app-icon.motion { background: linear-gradient(135deg, #4facfe, #00f2fe); }
    .app-icon.torch { background: linear-gradient(135deg, #ffd89b, #19547b); }
    .app-icon.touch { background: linear-gradient(135deg, #a8edea, #fed6e3); }
    .app-icon.speaker { background: linear-gradient(135deg, #ff9a9e, #fecfef); }
    
    .app-icon:active { filter: brightness(0.8); transform: scale(0.95); }
    .app-label { color: #fff; font-size: 11px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

    /* Dragging Visuals */
    .app-icon-wrapper.dragging { opacity: 0.5; z-index: 999; }
    
    /* --- APP DISPLAY (Running Apps) --- */
    .app-display { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 50; pointer-events: none;
    }
    
    .app-window {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff;
        transform: translate3d(100%, 0, 0); 
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        pointer-events: auto;
        overflow: hidden;
    }
    .app-window.active { transform: translate3d(0, 0, 0); }
    .app-iframe { width: 100%; height: 100%; border: none; display: block; }

    /* --- APP SWITCHER (Recents) --- */
    .app-switcher {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: transparent;
        z-index: 40;
        display: none; 
        overflow-x: auto; overflow-y: hidden;
        white-space: nowrap;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding: 0 40px;
        pointer-events: auto;
    }
    
    .switcher-container {
        display: inline-flex; height: 100%; align-items: center; gap: 20px;
        padding-right: 40px;
    }

    .switcher-card {
        position: relative;
        width: 75vw; max-width: 300px; height: 70vh;
        background: #222; border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        scroll-snap-align: center;
        flex-shrink: 0;
        transform-origin: center;
        transition: transform 0.2s;
        overflow: hidden;
    }
    
    .card-header {
        position: absolute; top: 0; left: 0; width: 100%; height: 40px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        z-index: 10; pointer-events: none;
    }
    .card-title { color: #fff; font-size: 14px; font-weight: 600; margin-left: 8px; }
    .card-icon-small { font-size: 16px; }

    .switcher-iframe {
        width: 100%; height: 100%; border: none; background: #fff;
        pointer-events: none;
    }

    .empty-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #fff; font-size: 16px; pointer-events: none; text-shadow: 0 1px 2px rgba(0,0,0,0.9);
    }
  </style>
</head>
<body>

<div class="phone">
    <div class="notch"></div>

    <div class="screen">
        <div class="status-bar" id="statusBar">
            <span id="clock">12:00</span>
            <span>5G 100%</span>
        </div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid"></div>
        </div>

        <div class="app-display" id="appDisplay">
            <div id="appWindowContainer"></div>
        </div>

        <div class="app-switcher" id="appSwitcher">
            <div class="switcher-container" id="switcherContainer"></div>
        </div>
        
        <div id="emptyRecents" class="empty-msg" style="display: none;">No Recent Apps. Swipe up again to go Home.</div>

        <div class="home-indicator" id="homeIndicator"></div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    const STORAGE_KEY = 'appLauncherOrder_v2';
    const appGrid = document.getElementById('appGrid');
    const appWindowContainer = document.getElementById('appWindowContainer');
    const appSwitcher = document.getElementById('appSwitcher');
    const switcherContainer = document.getElementById('switcherContainer');
    const homeScreen = document.getElementById('homeScreen');
    const homeIndicator = document.getElementById('homeIndicator');
    const emptyRecents = document.getElementById('emptyRecents');
    const statusBar = document.getElementById('statusBar');
    
    // Core State
    let runningApps = []; 
    let currentAppPath = null;
    let isSwitcherMode = false;

    // --- INITIALIZATION ---
    async function init() {
        updateClock();
        setInterval(updateClock, 1000);
        await loadApps();
        
        // Attach Global Gesture Listener to Home Indicator
        let startY = 0;
        homeIndicator.addEventListener('touchstart', e => { 
            startY = e.touches[0].clientY; 
            // Prevent initial drag from interfering with home screen
            e.preventDefault();
        });
        homeIndicator.addEventListener('touchend', e => {
            const deltaY = e.changedTouches[0].clientY - startY;
            if (deltaY < -40) { // Swiped Up
                handleHomeGesture();
            }
        });
        
        appSwitcher.addEventListener('scroll', handleSwitcherScroll);
    }

    // --- DATA LOADING & RENDERING ---
    async function loadApps() {
        try {
            const res = await fetch('apps.json');
            if (!res.ok) throw new Error("No apps.json found. Create one!");
            let apps = await res.json();
            
            // Apply saved sort order
            const savedOrder = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (savedOrder) {
                apps.sort((a, b) => {
                    const idxA = savedOrder.indexOf(a.path);
                    const idxB = savedOrder.indexOf(b.path);
                    return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                });
            }

            renderIcons(apps);
        } catch (e) {
            console.error("App loading error:", e);
            appGrid.innerHTML = `<div style="color:white; grid-column:1/-1; text-align:center; padding-top: 50px;">
                ‚ö†Ô∏è Error loading apps.json. Please ensure the file exists.
            </div>`;
        }
    }

    function renderIcons(apps) {
        appGrid.innerHTML = '';
        apps.forEach(app => {
            const el = document.createElement('div');
            el.className = 'app-icon-wrapper';
            el.draggable = true;
            el.dataset.path = app.path;
            el.innerHTML = `
                <div class="app-icon ${app.class || ''}">${app.icon}</div>
                <div class="app-label">${app.title}</div>
            `;
            
            // Launch on click
            el.addEventListener('click', (e) => {
                if(!el.classList.contains('dragging')) {
                    launchApp(app);
                }
            });

            // Drag Events
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragover', handleDragOver);
            el.addEventListener('drop', handleDrop);
            el.addEventListener('dragend', handleDragEnd); // FIX: Ensure drag state clears
            
            appGrid.appendChild(el);
        });
    }

    // --- DRAG & DROP LOGIC (FIXED) ---
    let draggedEl = null;
    function handleDragStart(e) {
        draggedEl = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        if (navigator.vibrate) navigator.vibrate(50); 
    }
    function handleDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('.app-icon-wrapper:not(.dragging)');
        if (target && target !== draggedEl) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientX - rect.left) / rect.width > 0.5;
            appGrid.insertBefore(draggedEl, next ? target.nextSibling : target);
        }
    }
    function handleDrop(e) {
        e.preventDefault();
        // draggedEl is cleared in handleDragEnd
    }
    function handleDragEnd(e) {
        if (draggedEl) {
            draggedEl.classList.remove('dragging');
            draggedEl = null;
        }
        // Save Order
        const newOrder = Array.from(appGrid.children).map(c => c.dataset.path);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newOrder));
    }

    // --- NAVIGATION CONTROLLER ---
    function handleHomeGesture() {
        if (currentAppPath) {
            // App is Open -> Go to Recents
            minimizeApp();
            openSwitcher();
        } else if (isSwitcherMode) {
            // In Recents -> Go Home
            closeSwitcher();
        } else if (runningApps.length > 0) {
            // On Home, apps are running -> Go to Recents
            openSwitcher();
        }
    }

    // --- APP LIFECYCLE ---
    function launchApp(appData) {
        let app = runningApps.find(a => a.path === appData.path);
        
        if (!app) {
            app = createAppInstance(appData);
            runningApps.push(app);
        } else {
            runningApps = runningApps.filter(a => a.path !== appData.path);
            runningApps.push(app); // Move to end (most recent)
        }

        closeSwitcher();
        
        // Restore iframe if it was in the card
        if (app.cardEl) restoreIframe(app);

        requestAnimationFrame(() => {
            app.windowEl.classList.add('active');
            runningApps.forEach(a => a.windowEl.style.zIndex = 10);
            app.windowEl.style.zIndex = 20;
            
            homeScreen.classList.add('zoomed-out');
            currentAppPath = app.path;
        });
    }

    function createAppInstance(data) {
        const win = document.createElement('div');
        win.className = 'app-window';
        
        const sandboxRules = "allow-scripts allow-forms allow-popups allow-modals";
        
        const iframe = document.createElement('iframe');
        iframe.className = 'app-iframe';
        iframe.src = data.path;
        iframe.setAttribute('sandbox', sandboxRules);
        
        win.appendChild(iframe);
        appWindowContainer.appendChild(win);

        return { ...data, windowEl: win, cardEl: null };
    }

    function minimizeApp() {
        if (!currentAppPath) return;
        const app = runningApps.find(a => a.path === currentAppPath);
        if (app) app.windowEl.classList.remove('active');
        
        homeScreen.classList.remove('zoomed-out');
        currentAppPath = null;
    }

    function closeApp(path) {
        const idx = runningApps.findIndex(a => a.path === path);
        if (idx === -1) return;
        const app = runningApps[idx];

        app.windowEl.remove();
        if (app.cardEl) app.cardEl.remove();
        runningApps.splice(idx, 1);

        if (runningApps.length === 0) {
            emptyRecents.style.display = 'block';
        }
        if (currentAppPath === path) currentAppPath = null;
    }

    // --- APP SWITCHER (RECENTS) ---
    function openSwitcher() {
        isSwitcherMode = true;
        homeScreen.classList.add('zoomed-out');
        appSwitcher.style.display = 'flex';
        emptyRecents.style.display = runningApps.length === 0 ? 'block' : 'none';
        statusBar.style.pointerEvents = 'none';

        renderSwitcherCards();
        
        setTimeout(() => {
            // Scroll to end (most recent) - index 0 is at the end of the container array
            const mostRecentCard = switcherContainer.lastElementChild;
            if (mostRecentCard) {
                appSwitcher.scrollLeft = mostRecentCard.offsetLeft - (appSwitcher.clientWidth / 2) + (mostRecentCard.offsetWidth / 2);
            }
            handleSwitcherScroll(); 
        }, 10);
    }

    function closeSwitcher() {
        isSwitcherMode = false;
        appSwitcher.style.display = 'none';
        homeScreen.classList.remove('zoomed-out');
        emptyRecents.style.display = 'none';
        statusBar.style.pointerEvents = 'auto';

        // Move all iframes back to their window container
        runningApps.forEach(restoreIframe);
    }

    function renderSwitcherCards() {
        switcherContainer.innerHTML = '';
        
        // Render in REVERSE order (most recent is now last in array, should be last visually for snap)
        // Note: Running apps are pushed, so array[n-1] is the most recent.
        const reversedApps = [...runningApps].reverse();

        reversedApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'switcher-card';
            
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<span class="card-icon-small">${app.icon}</span><span class="card-title">${app.title}</span>`;
            card.appendChild(header);

            const content = document.createElement('div');
            content.style.width = '100%'; 
            content.style.height = '100%';
            content.style.pointerEvents = 'none';
            content.className = 'card-content-area';
            
            // Move iframe from window container to card
            const iframe = app.windowEl.querySelector('iframe');
            if (iframe) content.appendChild(iframe);
            card.appendChild(content);
            
            // Click to Open
            card.addEventListener('click', (e) => {
                const isInteractive = content.style.pointerEvents === 'auto';
                // Only launch if it's the center card and the click wasn't inside the iframe
                if (isInteractive && e.target === card) { 
                    launchApp(app);
                }
            });

            applyFlickLogic(card, app);

            switcherContainer.appendChild(card);
            app.cardEl = card;
        });
    }

    function restoreIframe(app) {
        if (!app.cardEl || !app.windowEl) return;
        const iframe = app.cardEl.querySelector('iframe');
        if (iframe) {
            // Reset pointer events for fullscreen use
            iframe.style.pointerEvents = 'auto'; 
            app.windowEl.appendChild(iframe);
            // Clear card reference since it's now visually empty
            app.cardEl.remove();
            app.cardEl = null;
        }
    }

    // Handle "Flick Up" to close
    function applyFlickLogic(card, app) {
        let startY = 0;
        let isDragging = false;

        card.addEventListener('touchstart', (e) => {
            if (card.querySelector('.card-content-area').style.pointerEvents === 'none') return;
            startY = e.touches[0].clientY;
            isDragging = true;
            // Temporarily disable iframe interaction if dragging starts
            card.querySelector('iframe').style.pointerEvents = 'none'; 
        });

        card.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const dy = e.touches[0].clientY - startY;
            if (dy < 0) {
                e.preventDefault();
                card.style.transition = 'none';
                card.style.transform = `translateY(${dy}px) scale(${1 + dy/5000})`;
            }
        });

        card.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            const dy = e.changedTouches[0].clientY - startY;
            
            // Restore iframe pointer events
            card.querySelector('iframe').style.pointerEvents = 'auto';

            if (dy < -100) {
                // Flicked away
                card.style.transition = 'transform 0.3s ease-out';
                card.style.transform = `translateY(-100vh)`;
                setTimeout(() => closeApp(app.path), 300);
            } else {
                // Reset
                card.style.transition = 'transform 0.2s cubic-bezier(0.165, 0.84, 0.44, 1)';
                card.style.transform = 'translateY(0)';
            }
        });
    }

    // Determine which card is centered and make it interactive
    function handleSwitcherScroll() {
        if (!isSwitcherMode) return;
        
        const scrollCenter = appSwitcher.scrollLeft + (appSwitcher.clientWidth / 2);
        
        runningApps.forEach(app => {
            if (!app.cardEl) return;
            const card = app.cardEl;
            const content = card.querySelector('.card-content-area');

            const cardCenter = card.offsetLeft + (card.offsetWidth / 2);
            const dist = Math.abs(cardCenter - scrollCenter);
            
            // Threshold: if within 40px of center
            if (dist < 40) {
                content.style.pointerEvents = 'auto'; 
                card.style.transform = 'scale(1)';
                card.style.opacity = '1';
                // For debug: card.style.border = '2px solid red';
            } else {
                content.style.pointerEvents = 'none';
                card.style.transform = 'scale(0.95)';
                card.style.opacity = '0.7';
                // For debug: card.style.border = 'none';
            }
        });
    }
    
    // --- UTIL ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = 
            now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
    }

    init();
</script>
</body>
</html>
