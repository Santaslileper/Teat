<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Santaslileper OS</title>
  <style>
    /* --- CORE STYLES & RESET --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
        background: #000; display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
        /* Global Text Selection Disable */
        user-select: none; -webkit-user-select: none; cursor: default;
        overflow: hidden; /* Prevent body scroll */
    }

    /* --- PHONE FRAME & UI --- */
    .status-bar { height: 44px; padding: 0 20px; display: flex; align-items: flex-end; justify-content: space-between; padding-bottom: 8px; color: #fff; font-size: 15px; font-weight: 600; z-index: 100; pointer-events: none; }
    
    /* Home Indicator (The Gesture Target) */
    .home-indicator { 
        position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; 
        display: flex; justify-content: center; align-items: center; z-index: 999; 
        touch-action: none; /* Crucial for JS gestures */
    }
    .home-indicator::before { content: ''; display: block; width: 140px; height: 5px; background: rgba(255,255,255,0.4); border-radius: 3px; }

    /* --- LAYOUT CONTAINERS --- */
    .phone { 
        position: relative; width: 100%; height: 100%; max-width: 375px; max-height: 812px;
        background: #000; overflow: hidden; display: flex; flex-direction: column;
    }
    /* Desktop Phone styling */
    @media (min-width: 768px) {
        .phone { height: 812px; border-radius: 50px; box-shadow: 0 0 0 12px #2c2c2e, 0 20px 60px rgba(0,0,0,0.8); }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 180px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 100; }
    }
    
    .screen { position: relative; width: 100%; height: 100%; overflow: hidden; }

    /* --- HOME SCREEN --- */
    .home-screen { 
        padding: 60px 20px 80px 20px; height: 100%; overflow-y: auto;
        transition: transform 0.4s cubic-bezier(0.32, 0, 0.67, 0), filter 0.4s linear;
        will-change: transform, filter;
    }
    .home-screen.zoomed-out {
        transform: scale(0.85);
        filter: brightness(0.5) blur(10px);
        pointer-events: none;
    }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    /* Icons */
    .app-icon-wrapper { 
        display: flex; flex-direction: column; align-items: center; 
        transition: transform 0.2s ease;
        touch-action: none; /* Prevent scrolling while dragging icons */
    }
    .app-icon { 
        width: 60px; height: 60px; border-radius: 14px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 30px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #333, #555); /* Default */
    }
    /* Icon Gradients */
    .app-icon.camera { background: linear-gradient(135deg, #667eea, #764ba2); }
    .app-icon.mic { background: linear-gradient(135deg, #f093fb, #f5576c); }
    .app-icon.motion { background: linear-gradient(135deg, #4facfe, #00f2fe); }
    .app-icon.torch { background: linear-gradient(135deg, #ffd89b, #19547b); }
    .app-icon.touch { background: linear-gradient(135deg, #a8edea, #fed6e3); }
    .app-icon.speaker { background: linear-gradient(135deg, #ff9a9e, #fecfef); }
    
    .app-icon:active { filter: brightness(0.8); transform: scale(0.95); }
    .app-label { color: #fff; font-size: 11px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

    /* Dragging Visuals */
    .app-icon-wrapper.dragging { opacity: 0.5; z-index: 999; }
    
    /* --- APP DISPLAY (Running Apps) --- */
    .app-display { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 50; pointer-events: none; /* Let clicks pass to home if empty */
    }
    
    /* Active App Window */
    .app-window {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff;
        transform: translate3d(100%, 0, 0); /* Hidden to right by default */
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); /* iOS Spring-ish */
        pointer-events: auto;
        overflow: hidden;
    }
    .app-window.active { transform: translate3d(0, 0, 0); }
    
    .app-iframe { width: 100%; height: 100%; border: none; display: block; }

    /* --- APP SWITCHER (Recents) --- */
    .app-switcher {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: transparent;
        z-index: 40;
        display: none; /* Hidden by default */
        overflow-x: auto; overflow-y: hidden;
        white-space: nowrap;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding: 0 40px; /* Center alignment padding */
        pointer-events: auto;
    }
    
    .switcher-container {
        display: inline-flex; height: 100%; align-items: center; gap: 20px;
        padding-right: 40px; /* Spacer */
    }

    .switcher-card {
        position: relative;
        width: 75vw; max-width: 300px; height: 70vh;
        background: #222; border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        scroll-snap-align: center;
        flex-shrink: 0;
        transform-origin: center;
        transition: transform 0.2s;
        overflow: hidden;
    }
    
    /* Header inside card (Icon + Title) */
    .card-header {
        position: absolute; top: 0; left: 0; width: 100%; height: 40px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        z-index: 10; pointer-events: none;
    }
    .card-title { color: #fff; font-size: 14px; font-weight: 600; margin-left: 8px; }
    .card-icon-small { font-size: 16px; }

    /* The iframe inside the card */
    .switcher-iframe {
        width: 100%; height: 100%; border: none; background: #fff;
        pointer-events: none; /* Disabled by default, enabled via JS if active */
    }

    /* Message when empty */
    .empty-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #666; font-size: 16px; pointer-events: none;
    }
  </style>
</head>
<body>

<div class="phone">
    <div class="notch"></div>

    <div class="screen">
        <div class="status-bar">
            <span id="clock">12:00</span>
            <span>5G 100%</span>
        </div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid"></div>
        </div>

        <div class="app-display" id="appDisplay">
            <div id="appWindowContainer"></div>
        </div>

        <div class="app-switcher" id="appSwitcher">
            <div class="switcher-container" id="switcherContainer"></div>
        </div>
        
        <div id="emptyRecents" class="empty-msg" style="display: none;">No Recent Apps</div>

        <div class="home-indicator" id="homeIndicator"></div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    const STORAGE_KEY = 'appLauncherOrder_v2';
    const appGrid = document.getElementById('appGrid');
    const appWindowContainer = document.getElementById('appWindowContainer');
    const appSwitcher = document.getElementById('appSwitcher');
    const switcherContainer = document.getElementById('switcherContainer');
    const homeScreen = document.getElementById('homeScreen');
    const emptyRecents = document.getElementById('emptyRecents');
    
    // Core State
    let runningApps = []; // { path, title, icon, windowEl, cardEl }
    let currentAppPath = null; // Path of the app currently full screen
    let isSwitcherMode = false;

    // --- INITIALIZATION ---
    async function init() {
        updateClock();
        setInterval(updateClock, 1000);
        await loadApps();
        
        // Attach Global Gesture Listener to Home Indicator
        const indicator = document.getElementById('homeIndicator');
        let startY = 0;
        
        indicator.addEventListener('touchstart', e => { startY = e.touches[0].clientY; });
        indicator.addEventListener('touchend', e => {
            const deltaY = e.changedTouches[0].clientY - startY;
            if (deltaY < -40) { // Swiped Up
                handleHomeGesture();
            }
        });
        
        // Scroll Listener for Switcher (to activate centered card)
        appSwitcher.addEventListener('scroll', handleSwitcherScroll);
    }

    // --- DATA LOADING & RENDERING ---
    async function loadApps() {
        try {
            const res = await fetch('apps.json');
            if (!res.ok) throw new Error("No apps.json");
            let apps = await res.json();
            
            // Apply saved sort order
            const savedOrder = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (savedOrder) {
                apps.sort((a, b) => {
                    const idxA = savedOrder.indexOf(a.path);
                    const idxB = savedOrder.indexOf(b.path);
                    return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                });
            }

            renderIcons(apps);
        } catch (e) {
            appGrid.innerHTML = `<div style="color:white; grid-column:1/-1; text-align:center;">Error loading apps.json</div>`;
        }
    }

    function renderIcons(apps) {
        appGrid.innerHTML = '';
        apps.forEach(app => {
            const el = document.createElement('div');
            el.className = 'app-icon-wrapper';
            el.draggable = true;
            el.dataset.path = app.path;
            el.innerHTML = `
                <div class="app-icon ${app.class || ''}">${app.icon}</div>
                <div class="app-label">${app.title}</div>
            `;
            
            // Launch on click
            el.addEventListener('click', () => {
                if(!el.classList.contains('dragging')) launchApp(app);
            });

            // Drag Events
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragover', handleDragOver);
            el.addEventListener('drop', handleDrop);
            
            appGrid.appendChild(el);
        });
    }

    // --- DRAG & DROP LOGIC ---
    let draggedEl = null;
    function handleDragStart(e) {
        draggedEl = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    function handleDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('.app-icon-wrapper');
        if (target && target !== draggedEl) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientX - rect.left) / rect.width > 0.5;
            appGrid.insertBefore(draggedEl, next ? target.nextSibling : target);
        }
    }
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('dragging');
        // Save Order
        const newOrder = Array.from(appGrid.children).map(c => c.dataset.path);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newOrder));
    }

    // --- NAVIGATION CONTROLLER ---
    function handleHomeGesture() {
        if (currentAppPath) {
            // App is Open -> Go to Home (minimize)
            minimizeApp();
        } else if (!isSwitcherMode && runningApps.length > 0) {
            // On Home -> Go to Recents
            openSwitcher();
        } else {
            // In Recents -> Go Home
            closeSwitcher();
        }
    }

    // --- APP LIFECYCLE ---
    function launchApp(appData) {
        // 1. Check if running
        let app = runningApps.find(a => a.path === appData.path);
        
        if (!app) {
            // Create new App Instance
            app = createAppInstance(appData);
            runningApps.push(app);
        } else {
            // Move to end (most recent)
            runningApps = runningApps.filter(a => a.path !== appData.path);
            runningApps.push(app);
        }

        // 2. UI Transitions
        closeSwitcher(); // Ensure switcher is gone
        
        // Wait a tick for DOM
        requestAnimationFrame(() => {
            // Slide in
            app.windowEl.classList.add('active');
            // Bring to front Z-index
            runningApps.forEach(a => a.windowEl.style.zIndex = 10);
            app.windowEl.style.zIndex = 20;
            
            // Zoom out home screen
            homeScreen.classList.add('zoomed-out');
            
            currentAppPath = app.path;
        });
    }

    function createAppInstance(data) {
        // Create Fullscreen Window
        const win = document.createElement('div');
        win.className = 'app-window';
        
        // Sandbox Permissions: Allow scripts/forms. 
        // NOTE: 'allow-same-origin' is DANGEROUS if loading external sites. Removed for safety.
        // Special case: If path includes 'map', maybe relax?
        const sandboxRules = "allow-scripts allow-forms allow-popups allow-modals";
        
        win.innerHTML = `<iframe class="app-iframe" src="${data.path}" sandbox="${sandboxRules}"></iframe>`;
        appWindowContainer.appendChild(win);

        return { ...data, windowEl: win, cardEl: null };
    }

    function minimizeApp() {
        if (!currentAppPath) return;
        
        const app = runningApps.find(a => a.path === currentAppPath);
        if (app) {
            app.windowEl.classList.remove('active');
        }
        
        homeScreen.classList.remove('zoomed-out');
        currentAppPath = null;
    }

    function closeApp(path) {
        // Find app
        const idx = runningApps.findIndex(a => a.path === path);
        if (idx === -1) return;
        const app = runningApps[idx];

        // Remove DOM
        app.windowEl.remove();
        if (app.cardEl) app.cardEl.remove();

        // Remove from state
        runningApps.splice(idx, 1);

        // UI Updates
        if (runningApps.length === 0) {
            emptyRecents.style.display = 'block';
        }
        
        // If this was the active app, reset
        if (currentAppPath === path) currentAppPath = null;
    }

    // --- APP SWITCHER (RECENTS) ---
    function openSwitcher() {
        isSwitcherMode = true;
        homeScreen.classList.add('zoomed-out'); // Blur home
        appSwitcher.style.display = 'flex';
        emptyRecents.style.display = runningApps.length === 0 ? 'block' : 'none';

        renderSwitcherCards();
        
        // Scroll to end (most recent)
        setTimeout(() => {
            appSwitcher.scrollLeft = appSwitcher.scrollWidth;
            handleSwitcherScroll(); // Trigger interaction check
        }, 10);
    }

    function closeSwitcher() {
        isSwitcherMode = false;
        appSwitcher.style.display = 'none';
        homeScreen.classList.remove('zoomed-out');
        emptyRecents.style.display = 'none';
    }

    function renderSwitcherCards() {
        switcherContainer.innerHTML = '';
        
        // Render in order (runningApps)
        runningApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'switcher-card';
            
            // Clone iframe? No, moving iframes reloads them.
            // Technique: We actually move the iframe DOM node into the card
            // When exiting switcher, we move it back to windowContainer.
            // BUT for simplicity in this single-file demo, we will use a distinct visual approach:
            // We use the *same* iframe.
            
            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<span class="card-icon-small">${app.icon}</span><span class="card-title">${app.title}</span>`;
            card.appendChild(header);

            // Container for iframe content
            const content = document.createElement('div');
            content.style.width = '100%'; 
            content.style.height = '100%';
            content.style.pointerEvents = 'none'; // Default to non-interactive
            content.className = 'card-content-area';
            
            // Move iframe to card
            content.appendChild(app.windowEl.querySelector('iframe'));
            card.appendChild(content);
            
            // Attach Events
            // 1. Click to Open
            card.addEventListener('click', (e) => {
                // If interactive, let click pass through. If not, launch.
                if (content.style.pointerEvents === 'none') {
                    // Restore iframe to window container first
                    restoreIframe(app);
                    launchApp(app);
                }
            });

            // 2. Tinder Flick Logic
            applyFlickLogic(card, app);

            switcherContainer.appendChild(card);
            app.cardEl = card;
        });
    }

    // When closing switcher or launching app, we must put iframes back!
    function restoreIframe(app) {
        if (!app.cardEl) return;
        const iframe = app.cardEl.querySelector('iframe');
        if (iframe) {
            app.windowEl.appendChild(iframe);
        }
    }

    // Handle "Flick Up" to close
    function applyFlickLogic(card, app) {
        let startY = 0;
        let isDragging = false;

        card.addEventListener('touchstart', (e) => {
            // Only allow drag if we are NOT interacting with content
            // Simple check: if scrolling switcher, don't flick
            startY = e.touches[0].clientY;
            isDragging = true;
        });

        card.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const dy = e.touches[0].clientY - startY;
            if (dy < 0) { // Only up
                e.preventDefault(); // Stop scroll
                card.style.transform = `translateY(${dy}px) scale(${1 + dy/1000})`;
            }
        });

        card.addEventListener('touchend', (e) => {
            isDragging = false;
            const dy = e.changedTouches[0].clientY - startY;
            
            if (dy < -100) {
                // Flicked away!
                card.style.transition = 'transform 0.3s ease';
                card.style.transform = `translateY(-100vh)`;
                setTimeout(() => closeApp(app.path), 300);
            } else {
                // Reset
                card.style.transition = 'transform 0.2s ease';
                card.style.transform = '';
            }
        });
    }

    // Determine which card is centered and make it interactive
    function handleSwitcherScroll() {
        if (!isSwitcherMode) return;
        
        const centerLine = appSwitcher.scrollLeft + (appSwitcher.clientWidth / 2);
        
        runningApps.forEach(app => {
            if (!app.cardEl) return;
            const rect = app.cardEl.getBoundingClientRect();
            // Calculate card center relative to scrolling container logic isn't strictly needed
            // Just check screen center matches card center
            
            // Simpler: Distance from screen center
            const cardCenter = app.cardEl.offsetLeft + (app.cardEl.offsetWidth / 2);
            const dist = Math.abs(cardCenter - centerLine);
            
            const content = app.cardEl.querySelector('.card-content-area');
            
            // Threshold: if within 20px of center
            if (dist < 40) {
                content.style.pointerEvents = 'auto'; // Interactive!
                app.cardEl.style.transform = 'scale(1)';
                app.cardEl.style.opacity = '1';
            } else {
                content.style.pointerEvents = 'none'; // Static
                app.cardEl.style.transform = 'scale(0.95)';
                app.cardEl.style.opacity = '0.7';
            }
        });
    }
    
    // --- UTIL ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = 
            now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
    }

    init();
</script>
</body>
</html>
