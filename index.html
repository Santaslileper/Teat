<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1,minimum-scale=1,viewport-fit=cover">
<title>Santaslileper OS</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNhbnRhc2xpbGVwZXIgT1MiLAogICJzaG9ydF9uYW1lIjogIlNhbnRhc09TIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAic3RhcnRfdXJsIjogIi8iCn0=">

<style>
/* --- CORE --- */
*{margin:0;padding:0;box-sizing:border-box}
body,html{touch-action:none;overscroll-behavior:none;height:100%;overflow:hidden;background:#000}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;user-select:none;-webkit-user-select:none}

/* Phone Container */
.p{position:relative;width:100%;height:100%;background-color:#050505;overflow:hidden;display:flex;flex-direction:column;background-position: center; background-size: cover; transition: background-image 0.3s;}
@media(min-width:768px){.p{max-width:375px;max-height:812px;margin:20px auto;border-radius:50px;box-shadow:0 0 0 12px #2c2c2e;border:1px solid #333}}

/* --- SYSTEM UI --- */
.s{position:relative;width:100%;height:100%;z-index:2}
.sb{height:44px;padding:0 20px;display:flex;align-items:flex-end;justify-content:space-between;padding-bottom:8px;color:#fff;font-size:15px;font-weight:600;z-index:100;pointer-events:none;position:absolute;width:100%;top:0;text-shadow: 0 1px 2px rgba(0,0,0,0.5);}

/* HOME INDICATOR */
.hi {position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; display: flex; justify-content: center; align-items: center; z-index: 10000; pointer-events: auto; touch-action: none;}
.hi::before{content:'';display:block;width:140px;height:5px;background:rgba(255,255,255,.7);border-radius:3px;box-shadow: 0 1px 4px rgba(0,0,0,0.5);}

/* --- GRID SYSTEM --- */
.h{position:absolute;top:0;left:0;right:0;bottom:0;padding-top:60px;transition:transform .4s,filter .4s;overflow-y:auto;overflow-x:hidden;display:block}
.h.zo{transform:scale(.85);filter:brightness(.6)blur(5px);pointer-events:none}
#ag{position:relative;width:100%;min-height:100vh;padding-bottom:200px}

/* ITEMS */
.grid-item{position:absolute;transition:left .3s cubic-bezier(.34,1.56,.64,1),top .3s cubic-bezier(.34,1.56,.64,1);touch-action:none;z-index:10}
.grid-item.resizing{transition:none;z-index:100;opacity:.9;background:rgba(44,44,46,.9)!important;border:1px solid #007aff!important;border-radius:20px}
.edit-mode .grid-item:not(.resizing):not(.dragging){animation:jiggle .3s infinite linear;cursor:grab}
.edit-mode .grid-item.dragging{z-index:100;animation:none;transform:scale(1.1);opacity:.8;transition:none}
@keyframes jiggle{0%{transform:rotate(-1.5deg)}50%{transform:rotate(1.5deg)}100%{transform:rotate(-1.5deg)}}

/* ICONS & COLORS */
.aiw{width:80px;height:95px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
.ai{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.3);background:linear-gradient(135deg,#333,#555)}

/* Original Styles */
.ai.files { background: linear-gradient(135deg, #1CB5E0 0%, #000851 100%); }
.ai.news { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #93a5cf 100%); }
.ai.info { background: linear-gradient(135deg, #e1eec3 0%, #f05053 100%); }
.ai.settings { background: linear-gradient(135deg, #cfd9df 0%, #e2ebf0 100%); color:#333; }

/* NEW Styles from Hybrid OS mapping */
.ai.motion { background: linear-gradient(135deg, #5e5ce6, #3b3a99); }
.ai.torch { background: linear-gradient(135deg, #ff9f0a, #d48200); }
.ai.speaker { background: linear-gradient(135deg, #30d158, #1ea340); }
.ai.camera { background: linear-gradient(135deg, #ff375f, #d61e42); }
.ai.mic { background: linear-gradient(135deg, #0a84ff, #0056b3); }
.ai.touch { background: linear-gradient(135deg, #32ade6, #007aff); }

.al{color:#fff;font-size:11px;margin-top:5px;text-shadow:0 1px 2px rgba(0,0,0,.8);text-align:center;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* WIDGETS */
.widget{background:0 0;backdrop-filter:none;border:none;border-radius:20px;overflow:hidden;color:#fff;display:flex;flex-direction:column;transition:background .3s,border .3s,backdrop-filter .3s}
.edit-mode .widget{background:rgba(30,41,59,.6);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.15);box-shadow:0 4px 15px rgba(0,0,0,.3)}
.widget-content{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:10px;text-align:center;width:100%;height:100%;overflow:hidden;text-shadow:0 2px 8px rgba(0,0,0,.6)}
.del-btn{position:absolute;top:-8px;left:-8px;width:24px;height:24px;background:#ff3b30;border-radius:50%;display:none;z-index:20;color:#fff;font-weight:700;font-size:16px;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,.3)}
.resize-handle{position:absolute;bottom:0;right:0;width:40px;height:40px;z-index:30;display:none;touch-action:none}
.resize-handle::after{content:'';position:absolute;bottom:8px;right:8px;width:15px;height:15px;border-bottom:3px solid rgba(255,255,255,.8);border-right:3px solid rgba(255,255,255,.8);border-radius:2px}
.edit-mode .del-btn,.edit-mode .resize-handle{display:block}
.loader {border: 4px solid rgba(255, 255, 255, 0.1);border-left-color: #fff;border-radius: 50%;width: 30px;height: 30px;animation: spin 1s linear infinite;}
@keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}

/* --- APP WINDOW --- */
.aw{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;transform:translate3d(100%,0,0);transition:transform .4s cubic-bezier(.19,1,.22,1);pointer-events:auto;overflow:hidden;display:flex;flex-direction:column;z-index:50}
.aw.ac{transform:translate3d(0,0,0)}
/* App Content Container */
.awc{width:100%;height:100%;overflow:hidden;background:#000;position:relative} 
.aif{width:100%;height:100%;border:none;display:block;background:#fff;}

/* --- SWITCHER --- */
.as{position:absolute;top:0;left:0;width:100%;height:100%;background:transparent;z-index:40;display:none;flex-direction:row;align-items:center;overflow-x:auto;overflow-y:hidden;white-space:nowrap;scroll-snap-type:x mandatory;padding:0 20px;pointer-events:auto; -webkit-overflow-scrolling: touch;}
.sc{display:flex;height:100%;align-items:center;gap:20px;min-width:min-content}
.scd{position:relative;width:75vw;max-width:300px;height:70vh;background:#1c1c1e;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.5);scroll-snap-align:center;flex-shrink:0;overflow:hidden;transform:scale(1);transition:transform 0.1s}
.ch{position:absolute;top:0;left:0;width:100%;height:40px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);z-index:20;pointer-events:none}
.ctl{position:absolute;top:40px;left:0;width:100%;height:calc(100% - 40px);z-index:200;} 
.rcx{position:absolute;top:50px;right:20px;width:30px;height:30px;background:rgba(60,60,60,.8);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;cursor:pointer;z-index:200;display:none}
.em{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:16px;pointer-events:none;z-index: 10;}

/* UI */
#edit-ui{position:fixed;bottom:40px;left:20px;right:20px;height:50px;display:flex;justify-content:center;gap:15px;z-index:200;pointer-events:none;opacity:0;transition:opacity .3s}
.edit-mode #edit-ui{opacity:1;pointer-events:auto}
button.ui-btn{padding:10px 20px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:none;border-radius:20px;color:#fff;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.3)}
#add-panel{position:fixed;bottom:-400px;left:0;width:100%;height:350px;background:#1c1c1e;border-radius:20px 20px 0 0;z-index:300;transition:bottom .3s;padding:20px;display:flex;flex-direction:column;gap:10px}
#add-panel.open{bottom:0}
.add-opt{padding:15px;background:#2c2c2e;color:#fff;border-radius:12px;display:flex;align-items:center;gap:10px;font-size:16px;cursor:pointer}

/* INTERNAL APPS */
.tc{padding:60px 20px;color:#fff;text-align:center;background:#000;height:100%;width:100%;overflow-y:auto;}
.fb{padding:5px 10px;background:#007aff;border-radius:5px;border:none;color:white}

/* SETTINGS UI */
.sg{width:100%;max-width:320px;margin-bottom:25px;margin-left:auto;margin-right:auto;}
.sh{font-size:13px;color:#8e8e93;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;text-align:left;padding:0 15px}
.so{background:#1c1c1e;border-radius:10px;overflow:hidden}
.si{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid #2c2c2e;min-height:44px}
.si:last-child{border-bottom:none}
.sl{color:#fff;font-size:16px}
.sr{display:flex;align-items:center;gap:10px}
.sr select,.sr input{padding:6px 10px;font-size:14px;border-radius:6px;background:#2c2c2e;color:#fff;border:1px solid #3a3a3c}
.sr input[type="file"]{display:none}
.bgp{width:100px;height:60px;border-radius:6px;background-size:cover;background-position:center;border:2px solid #3a3a3c;cursor:pointer}
.db{background:#ff3b30!important}

/* PWA PROMPT */
.pwa-prompt{position:fixed;bottom:20px;left:20px;right:20px;background:rgba(0,122,255,.95);color:#fff;padding:15px;border-radius:12px;font-size:14px;z-index:10000;display:none;backdrop-filter:blur(10px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.pwa-prompt button{background:#fff;color:#007aff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;margin-top:10px;cursor:pointer}
</style>
</head>
<body>

<div class="pwa-prompt" id="pwaPrompt">
  <div id="promptText"></div>
  <button onclick="document.getElementById('pwaPrompt').style.display='none'">Got it</button>
</div>

<div class="p" id="phone">
    <div class="s">
        <div class="sb"><span id="c">17:55</span><span id="batt">100%</span></div>
        <div class="h" id="h"><div id="ag"></div></div>
        <div class="aw" id="app-window"><div class="awc" id="awc"></div></div>
        <div class="as" id="switcher"><div class="sc" id="scc"></div></div>
        <div id="rcb" class="rcx" onclick="closeSwitcher()">‚úï</div>
        <div id="er" class="em" style="display:none">No Recent Apps</div>
        <div id="edit-ui">
            <button class="ui-btn" onclick="openAddPanel()">+ Widget</button>
            <button class="ui-btn" style="background:#007aff" onclick="toggleEdit(false)">Done</button>
        </div>
        <div class="hi" id="hi"></div>
    </div>
</div>

<div id="add-panel">
    <h3 style="color:#fff;margin-bottom:10px">Add Widget</h3>
    <div class="add-opt" onclick="addWidget('clock')">‚è∞ Clock</div>
    <div class="add-opt" onclick="addWidget('weather')">‚òÅÔ∏è Weather</div>
    <div class="add-opt" onclick="addWidget('calendar')">üìÖ Calendar</div>
    <div class="add-opt" onclick="addWidget('photo')">üñºÔ∏è Photo</div>
    <div class="add-opt" style="background:#3a3a3c;justify-content:center" onclick="closeAddPanel()">Cancel</div>
</div>

<script>
// --- CONFIG & PREFS ---
const COL_COUNT=4, ROW_HEIGHT=100;
let SCREEN_W = document.getElementById("ag").clientWidth || window.innerWidth;
let COL_WIDTH = SCREEN_W / COL_COUNT;
let isEditMode = false;
let items = []; 
let runningApps = []; 
let currentApp = null; 
let isSwitcherMode = false;

// Keys
const STORAGE_KEY = 'os_layout_updated_v1'; // Changed key to force reload new apps
const PREFS = { t:'appLauncherTheme', f:'appLauncherFont', bg:'appLauncherBg', bb:'appLauncherBattery', pw:'pwaPromptShown' };

// --- REPLACED APP LIST (From Hybrid Card OS) ---
const defaultApps = [
  // Mapped from Hybrid Card OS
  { "title": "Grapple Ascent", "icon": "üéÆ", "path": "page3.html", "class": "motion" },
  { "title": "Calculator", "icon": "üßÆ", "path": "page4.html", "class": "torch" },
  { "title": "AI Learning", "icon": "ü§ñ", "path": "page6.html", "class": "speaker" },
  { "title": "News Reader", "icon": "üì∞", "path": "page9.html", "class": "motion" },
  { "title": "Cycle Counter", "icon": "‚è±Ô∏è", "path": "page11.html", "class": "touch" },
  
  // Mapped "Theme Switcher" to native System Settings for full functionality
  { "title": "Settings", "icon": "üé®", "path": "system:settings", "class": "speaker" },
  
  { "title": "Files", "icon": "üóÉÔ∏è", "path": "page17.html", "class": "camera" },
  { "title": "Mortis Cloud", "icon": "‚ò†Ô∏è", "path": "page67.html", "class": "camera" },
  { "title": "Secure Chat", "icon": "üí¨", "path": "page69.html", "class": "mic" },
  { "title": "Test Page", "icon": "üöß", "path": "page3000.html", "class": "torch" },
  
  // Music Apps
  { "title": "Spotify", "icon": "üü¢", "path": "https://open.spotify.com", "class": "speaker" },
  { "title": "SoundCloud", "icon": "‚òÅÔ∏è", "path": "https://soundcloud.com/discover", "class": "speaker" },
  { "title": "Apple Music", "icon": "üéµ", "path": "https://music.apple.com", "class": "speaker" }
];

function init() {
    updateClock(); setInterval(updateClock, 1000);
    applyPreferences(); // Load Theme/Font/Bg
    initPWA();          // Check for Add to Home Screen

    const savedLayout = localStorage.getItem(STORAGE_KEY);
    if (savedLayout) {
        try {
            const layoutData = JSON.parse(savedLayout);
            // Quick check if layout is valid, otherwise load defaults
            if(layoutData.length === 0) throw new Error("Empty layout");
            layoutData.forEach(itemData => createItem(itemData.type, itemData.x, itemData.y, itemData.cols, itemData.rows, itemData));
        } catch(e) { loadDefaultApps(); }
    } else {
        loadDefaultApps();
    }

    // --- HOME GESTURES ---
    const hi = document.getElementById("hi");
    let startY = 0;
    hi.addEventListener("touchstart", (e) => { startY = e.touches[0].clientY; e.stopPropagation(); }, {passive:false});
    hi.addEventListener("touchend", (e) => {
        if(e.changedTouches[0].clientY - startY < -30) handleHomeGesture();
    }, {passive:false});

    // Edit Mode
    const grid = document.getElementById("ag");
    let pressTimer;
    grid.addEventListener("touchstart", e => {
        if(e.target === grid || e.target.classList.contains('aiw')) {
            pressTimer = setTimeout(() => {
                if(navigator.vibrate) navigator.vibrate(50); // Haptic added
                toggleEdit(true);
            }, 800);
        }
    });
    grid.addEventListener("touchend", () => clearTimeout(pressTimer));
}

// --- PREFERENCES LOGIC ---
function gv(k,d){return localStorage.getItem(k)||d}
function sv(k,v){localStorage.setItem(k,v)}

function applyPreferences() {
    // 1. Theme
    const t = gv(PREFS.t, 'dark');
    const p = document.getElementById('phone');
    const bg = gv(PREFS.bg, '');
    const m = {
        light:['linear-gradient(135deg,#e0e0e0,#f5f5f5)','#000'],
        blue:['linear-gradient(135deg,#1e3c72,#2a5298)','#fff'],
        purple:['linear-gradient(135deg,#2d1b69,#5b3a9d)','#fff'],
        green:['linear-gradient(135deg,#0f2027,#203a43,#2c5364)','#fff'],
        red:['linear-gradient(135deg,#c31432,#240b36)','#fff'],
        orange:['linear-gradient(135deg,#f46b45,#eea849)','#fff'],
        pink:['linear-gradient(135deg,#ff9a9e,#fecfef)','#000']
    };

    if(bg) {
        p.style.background = '#000';
        p.style.backgroundImage = `url(${bg})`;
        p.style.backgroundSize = 'cover';
        p.style.backgroundPosition = 'center';
    } else if(m[t]) {
        p.style.backgroundImage = 'none';
        p.style.background = m[t][0];
        document.getElementById('h').style.color = m[t][1];
        document.querySelectorAll('.al').forEach(l => l.style.color = m[t][1]);
    } else {
        // Default Dark
        p.style.backgroundImage = 'radial-gradient(circle at center,#1a1a1a 0%,#000 100%)';
        p.style.backgroundColor = '#050505';
    }

    // 2. Font
    const f = gv(PREFS.f, 'system');
    const fm = {
        system:'-apple-system,BlinkMacSystemFont,"SF Pro Display",sans-serif',
        serif:'Georgia,"Times New Roman",serif',
        mono:'"Courier New",Courier,monospace',
        rounded:'ui-rounded,"SF Pro Rounded",system-ui,sans-serif'
    };
    document.body.style.fontFamily = fm[f]||fm.system;

    // 3. Battery
    const bb = gv(PREFS.bb, 'show');
    document.getElementById('batt').style.display = bb==='hide'?'none':'block';
}

function initPWA() {
    const isIOS=/iPhone|iPad|iPod/.test(navigator.userAgent);
    const isChrome=/CriOS/.test(navigator.userAgent);
    const isSafari=isIOS&&/Safari/.test(navigator.userAgent)&&!/CriOS/.test(navigator.userAgent);
    const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;

    if(!isStandalone && !gv(PREFS.pw,'')){
        const prompt=document.getElementById('pwaPrompt'), text=document.getElementById('promptText');
        if(isChrome&&isIOS){
            text.innerHTML='<strong>üì± Best Experience</strong><br>Open in Safari ‚Üí Share ‚Üí Add to Home Screen for fullscreen mode!';
            prompt.style.display='block';
            setTimeout(()=>{if(prompt.style.display!=='none'){sv(PREFS.pw,'1')}},8000);
        } else if(isSafari){
            text.innerHTML='<strong>üì± Add to Home Screen</strong><br>Tap Share button ‚Üí Add to Home Screen for the best experience!';
            prompt.style.display='block';
            setTimeout(()=>{if(prompt.style.display!=='none'){sv(PREFS.pw,'1')}},8000);
        }
    }
}

function loadDefaultApps() {
    // Widgets first
    createItem('widget', 0, 0, 2, 2, {subtype:'clock'});
    createItem('widget', 2 * COL_WIDTH, 0, 2, 2, {subtype:'weather'});
    
    // Apps below
    let startRow = 2; 
    defaultApps.forEach((app, index) => {
        const col = index % 4;
        const row = startRow + Math.floor(index / 4);
        createItem('app', col * COL_WIDTH, row * ROW_HEIGHT, 1, 1, app);
    });
    saveLayout();
}

function saveLayout() {
    const layout = items.map(i => ({
        type: i.type, subtype: i.subtype, x: i.x, y: i.y, cols: i.cols, rows: i.rows,
        title: i.title, icon: i.icon, path: i.path, class: i.class
    }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(layout));
}

function handleHomeGesture() {
    if(currentApp) { minimizeApp(); openSwitcher(); }
    else if(isSwitcherMode) { closeSwitcher(); }
    else if(runningApps.length > 0 && !isEditMode) { openSwitcher(); }
}

// --- GRID ENGINE ---
function createItem(type, x, y, wUnit, hUnit, data={}) {
    const el = document.createElement("div");
    el.classList.add("grid-item");
    const wPx = wUnit * COL_WIDTH - (type === "app" ? 0 : 15);
    const hPx = hUnit * ROW_HEIGHT - (type === "app" ? 10 : 15);

    if (type === "app") {
        el.classList.add("aiw");
        // Use data.class if present, default to 'files'
        el.innerHTML = `<div class="ai ${data.class||'files'}">${data.icon}</div><div class="al">${data.title}</div>`;
        el.onclick = () => { if(!isEditMode) launchApp(data); };
    } else {
        el.classList.add("widget");
        el.innerHTML = `<div class="del-btn">√ó</div><div class="resize-handle"></div><div class="widget-content">${data.subtype === 'loading' ? '<div class="loader"></div>' : getWidgetHTML(data.subtype, wUnit)}</div>`;
        el.querySelector(".del-btn").onclick = (e) => { e.stopPropagation(); deleteItem(el); };
    }
    document.getElementById("ag").appendChild(el);
    const itemObj = { 
        el: el, type: type, subtype: data.subtype, 
        x: x, y: y, w: wPx, h: hPx, cols: wUnit, rows: hUnit,
        title: data.title, icon: data.icon, path: data.path, class: data.class
    };
    updateVisualPosition(itemObj);
    setupDrag(itemObj);
    if(type === "widget") setupResize(itemObj);
    items.push(itemObj);
    updateContainerHeight();
    
    // Apply theme colors to label immediately
    applyPreferences();
    return itemObj;
}

function addWidget(type) {
    closeAddPanel();
    const spot = findNextEmptySpot(2, 2);
    const widgetItem = createItem("widget", spot.x, spot.y, 2, 2, { subtype: "loading" });
    resolveCollisions(widgetItem); updateVisualPosition(widgetItem); toggleEdit(true);
    setTimeout(() => {
        widgetItem.subtype = type;
        widgetItem.el.querySelector(".widget-content").innerHTML = getWidgetHTML(type, 2);
        if(type === 'clock') updateClock();
        resolveCollisions(widgetItem); updateVisualPosition(widgetItem); saveLayout();
    }, 1000);
}

function getWidgetHTML(type, cols) {
    if(type === "clock") return `<h1 style="margin:0;font-size:${cols>=3?"48px":"34px"};font-weight:300" id="w-clock">17:55</h1><div style="font-size:11px;opacity:0.7;margin-top:-2px;letter-spacing:1px">NEW YORK</div>`;
    if(type === "weather") return `<div style="font-size:35px;margin-bottom:5px">‚õàÔ∏è</div><div style="font-size:22px;font-weight:bold">16¬∞</div><div style="font-size:11px;opacity:0.7">Heavy Rain</div>`;
    if(type === "photo") return '<img src="https://images.unsplash.com/photo-1494548162494-384bba4ab999?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" style="width:100%;height:100%;object-fit:cover;border-radius:20px;">';
    if(type === "calendar") return `<div style="color:#ff3b30;font-weight:bold;font-size:20px">DEC</div><div style="font-size:40px">2</div>`;
    return "Widget";
}

// --- APP LOGIC ---
function launchApp(appData) {
    let existing = runningApps.find(a => a.path === appData.path);
    if(!existing) {
        existing = { ...appData, dom: createInternalAppDOM(appData) };
        runningApps.push(existing);
    }
    restoreContentToWindow(existing);

    const awc = document.getElementById("awc");
    awc.innerHTML = ''; 
    awc.appendChild(existing.dom);
    
    requestAnimationFrame(() => {
        document.getElementById("app-window").classList.add("ac");
        document.getElementById("h").classList.add("zo");
    });
    currentApp = existing;
    if(isSwitcherMode) closeSwitcher();
}

function createInternalAppDOM(data) {
    const w = document.createElement("div");
    w.style.width = "100%"; w.style.height = "100%";
    
    // -- SETTINGS APP --
    if(data.path === "system:settings") {
        w.innerHTML = `
        <div class="tc">
            <div style="font-size:60px;margin-bottom:20px">‚öôÔ∏è</div><h2 style="margin-bottom:30px">Settings</h2>
            
            <div class="sg"><div class="sh">Appearance</div><div class="so">
                <div class="si"><span class="sl">Theme</span><div class="sr"><select id="tsl"><option value="dark">Dark</option><option value="light">Light</option><option value="blue">Ocean Blue</option><option value="purple">Purple</option><option value="green">Forest</option><option value="red">Red Velvet</option><option value="orange">Sunset</option><option value="pink">Pink Dream</option></select></div></div>
                <div class="si"><span class="sl">Font</span><div class="sr"><select id="fsl"><option value="system">System</option><option value="serif">Serif</option><option value="mono">Mono</option><option value="rounded">Rounded</option></select></div></div>
                <div class="si"><span class="sl">Background</span><div class="sr"><div class="bgp" id="bgp"></div><label for="bgi" class="fb" style="cursor:pointer">Upload</label><input type="file" id="bgi" accept="image/*"></div></div>
            </div></div>

            <div class="sg"><div class="sh">Status Bar</div><div class="so">
                <div class="si"><span class="sl">Battery</span><div class="sr"><select id="bbs"><option value="show">Show</option><option value="hide">Hide</option></select></div></div>
            </div></div>

            <div class="sg"><div class="sh">Advanced</div><div class="so">
                <div class="si"><span class="sl">Clear Background</span><div class="sr"><button class="fb db" id="cbg">Clear</button></div></div>
                <div class="si"><span class="sl">Reset Layout</span><div class="sr"><button class="fb db" onclick="resetFactory()">Reset</button></div></div>
            </div></div>
        </div>`;
        hydrateSettingsEvents(w);
    } 
    // -- DEFAULT IFRAME LOADER --
    else {
        const i = document.createElement("iframe");
        i.className = "aif"; 
        // Allow scripts and forms for the new apps
        i.setAttribute("sandbox", "allow-scripts allow-forms allow-same-origin allow-modals allow-popups allow-presentation");
        i.src = data.path.includes("system") ? "about:blank" : data.path; 
        w.appendChild(i);
    }
    return w;
}

// Logic to make the Settings HTML work
function hydrateSettingsEvents(container) {
    setTimeout(() => {
        const ts = container.querySelector('#tsl'), fs = container.querySelector('#fsl'), bbs = container.querySelector('#bbs');
        const bgi = container.querySelector('#bgi'), bgp = container.querySelector('#bgp'), cbg = container.querySelector('#cbg');

        if(ts) {
            ts.value = gv(PREFS.t, 'dark');
            fs.value = gv(PREFS.f, 'system');
            bbs.value = gv(PREFS.bb, 'show');
            
            const bg = gv(PREFS.bg, '');
            if(bg) bgp.style.backgroundImage = `url(${bg})`;

            ts.onchange = e => { sv(PREFS.t, e.target.value); sv(PREFS.bg, ''); applyPreferences(); };
            fs.onchange = e => { sv(PREFS.f, e.target.value); applyPreferences(); };
            bbs.onchange = e => { sv(PREFS.bb, e.target.value); applyPreferences(); };

            bgi.onchange = e => {
                const f = e.target.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload = ev => {
                        const b64 = ev.target.result;
                        sv(PREFS.bg, b64);
                        bgp.style.backgroundImage = `url(${b64})`;
                        applyPreferences();
                    };
                    r.readAsDataURL(f);
                }
            };

            cbg.onclick = () => {
                if(confirm('Clear custom wallpaper?')) {
                    sv(PREFS.bg, '');
                    bgp.style.backgroundImage = '';
                    applyPreferences();
                }
            };
        }
    }, 100);
}

function resetFactory() {
    if(confirm("Reset entire OS layout?")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

function minimizeApp() {
    if(!currentApp) return;
    document.getElementById("app-window").classList.remove("ac");
    currentApp = null;
}

function closeApp(app) {
    const idx = runningApps.indexOf(app);
    if(idx > -1) { runningApps.splice(idx, 1); app.dom.remove(); if(app.cardEl) app.cardEl.remove(); }
    if(runningApps.length === 0) closeSwitcher();
    updateRecentsEmptyState();
}

function updateRecentsEmptyState() {
    document.getElementById("er").style.display = runningApps.length === 0 ? "block" : "none";
}

// --- SWITCHER ---
function openSwitcher() {
    isSwitcherMode = true;
    const s = document.getElementById("switcher");
    const sc = document.getElementById("scc");
    const h = document.getElementById("h");
    s.style.display = 'flex';
    document.getElementById("rcb").style.display = 'flex';
    h.classList.add("zo");
    sc.innerHTML = '';
    
    updateRecentsEmptyState();

    runningApps.forEach(app => {
        const card = document.createElement("div");
        card.className = "scd";
        const header = document.createElement("div");
        header.className = "ch";
        header.innerHTML = `<span style="color:#fff;font-size:12px;font-weight:bold">${app.title}</span>`;
        card.appendChild(header);
        
        const contentHolder = document.createElement("div");
        // Ensure background is opaque for cards
        contentHolder.style.cssText = "width:100%;height:100%;pointer-events:none;padding-top:40px;background:#111";
        
        // Move live DOM into card
        if(app.dom.parentNode) app.dom.parentNode.removeChild(app.dom);
        contentHolder.appendChild(app.dom);
        
        card.appendChild(contentHolder);
        
        const touchLayer = document.createElement("div");
        touchLayer.className = "ctl";
        card.appendChild(touchLayer);
        setupSwitcherGestures(touchLayer, card, app);
        sc.appendChild(card);
        app.cardEl = card; 
    });
}

function restoreContentToWindow(app) {
    if(app.dom.parentNode) app.dom.parentNode.removeChild(app.dom);
}

function closeSwitcher() {
    isSwitcherMode = false;
    document.getElementById("switcher").style.display = 'none';
    document.getElementById("rcb").style.display = 'none';
    document.getElementById("h").classList.remove("zo");
}

function setupSwitcherGestures(touchLayer, card, app) {
    let startX = 0, startY = 0, isVertical = false, isHorizontal = false;
    
    touchLayer.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isVertical = false;
        isHorizontal = false;
    }, {passive:false});

    touchLayer.addEventListener('touchmove', (e) => {
        if(isHorizontal) return; 
        
        const cx = e.touches[0].clientX;
        const cy = e.touches[0].clientY;
        const dx = cx - startX;
        const dy = cy - startY;

        if(!isVertical && !isHorizontal) {
            if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 5) {
                isHorizontal = true;
            } else if(Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 5) {
                isVertical = true;
            }
        }

        if(isVertical) {
            e.preventDefault(); 
            if(dy < 0) {
                 card.style.transform = `scale(0.9) translateY(${dy}px)`;
                 card.style.opacity = `${1 - Math.abs(dy)/500}`;
            }
        }
    }, {passive:false});

    touchLayer.addEventListener('touchend', (e) => {
        if(isVertical) {
            const dy = e.changedTouches[0].clientY - startY;
            if(dy < -100) {
                card.style.transition = "transform 0.3s ease, opacity 0.3s";
                card.style.transform = "translateY(-100vh)";
                card.style.opacity = "0";
                setTimeout(() => closeApp(app), 300);
            } else {
                card.style.transition = "transform 0.2s ease, opacity 0.2s";
                card.style.transform = "scale(1)";
                card.style.opacity = "1";
            }
        } else if(!isHorizontal) {
             const dy = e.changedTouches[0].clientY - startY;
             const dx = e.changedTouches[0].clientX - startX;
             if(Math.abs(dx) < 10 && Math.abs(dy) < 10) {
                 launchApp(app);
             }
        }
    });
}

// --- UTILS ---
function updateVisualPosition(item) {
    const offsetX = (item.cols * COL_WIDTH - item.w) / 2;
    const offsetY = (item.rows * ROW_HEIGHT - item.h) / 2;
    item.el.style.left = (item.x + offsetX) + "px";
    item.el.style.top = (item.y + offsetY) + "px";
}
function resolveCollisions(movedItem) {
    items.filter(i => i !== movedItem).forEach(other => {
        if(rectIntersect(movedItem, other)) {
            const others = items.filter(x => x !== other);
            const nextSpot = findNextEmptySpot(other.cols, other.rows, others);
            other.x = nextSpot.x; other.y = nextSpot.y;
            updateVisualPosition(other);
        }
    });
}
function rectIntersect(i1, i2) {
    const margin = 10;
    return (i1.x + margin < i2.x + i2.cols * COL_WIDTH) && (i1.x + i1.cols * COL_WIDTH - margin > i2.x) &&
           (i1.y + margin < i2.y + i2.rows * ROW_HEIGHT) && (i1.y + i1.rows * ROW_HEIGHT - margin > i2.y);
}
function findNextEmptySpot(cols, rows, currentItems = items) {
    let rowIdx = 0;
    while(true) {
        for(let colIdx = 0; colIdx < COL_COUNT; colIdx++) {
            if(colIdx + cols > COL_COUNT) continue; 
            const testX = colIdx * COL_WIDTH; const testY = rowIdx * ROW_HEIGHT;
            const collision = currentItems.some(i => testX < i.x + i.cols * COL_WIDTH && testX + cols * COL_WIDTH > i.x && testY < i.y + i.rows * ROW_HEIGHT && testY + rows * ROW_HEIGHT > i.y);
            if(!collision) return {x: testX, y: testY};
        }
        rowIdx++; if(rowIdx > 500) return {x:0, y:0};
    }
}
function updateContainerHeight() {
    let max = 0; items.forEach(i => { const bottom = i.y + i.h; if(bottom > max) max = bottom; });
    document.getElementById("ag").style.minHeight = (max + 300) + "px";
}
function toggleEdit(val) { isEditMode = val; document.body.classList.toggle("edit-mode", val); closeAddPanel(); }
function openAddPanel(){ document.getElementById("add-panel").classList.add("open"); }
function closeAddPanel(){ document.getElementById("add-panel").classList.remove("open"); }
function deleteItem(el) { 
    const idx = items.findIndex(i => i.el === el); 
    if(idx > -1) { items.splice(idx, 1); el.remove(); updateContainerHeight(); saveLayout(); } 
}
function updateClock() { const d = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); document.getElementById("c").innerText = d; document.querySelectorAll("#w-clock").forEach(e => e.innerText = d); }

// --- DRAG/RESIZE HANDLERS ---
function setupDrag(item){
    let startX, startY, startLeft, startTop;
    const onStart = (e) => {
        if(isEditMode && !e.target.className.includes("resize-handle") && !e.target.className.includes("del-btn")){
            e.preventDefault(); item.el.classList.add("dragging");
            startX = e.touches?e.touches[0].clientX:e.clientX; startY = e.touches?e.touches[0].clientY:e.clientY;
            startLeft = parseFloat(item.el.style.left); startTop = parseFloat(item.el.style.top);
            document.addEventListener("touchmove", onMove, {passive:false}); document.addEventListener("touchend", onEnd);
            document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onEnd);
        }
    };
    const onMove = (e) => {
        e.preventDefault(); const clientX = e.touches?e.touches[0].clientX:e.clientX; const clientY = e.touches?e.touches[0].clientY:e.clientY;
        item.el.style.left = startLeft + (clientX - startX) + "px"; item.el.style.top = startTop + (clientY - startY) + "px";
    };
    const onEnd = () => {
        document.removeEventListener("touchmove", onMove); document.removeEventListener("touchend", onEnd);
        document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onEnd);
        item.el.classList.remove("dragging");
        const left = parseFloat(item.el.style.left); const top = parseFloat(item.el.style.top);
        let col = Math.round(left / COL_WIDTH); let row = Math.round(top / ROW_HEIGHT);
        if(col < 0) col = 0; if(col > COL_COUNT - item.cols) col = COL_COUNT - item.cols; if(row < 0) row = 0;
        item.x = col * COL_WIDTH; item.y = row * ROW_HEIGHT;
        resolveCollisions(item); updateVisualPosition(item); updateContainerHeight(); saveLayout();
    };
    item.el.addEventListener("touchstart", onStart, {passive:false}); item.el.addEventListener("mousedown", onStart);
}
function setupResize(item){
    const handle = item.el.querySelector(".resize-handle");
    let startX, startY, startW, startH;
    const onStart = (e) => {
        e.stopPropagation(); e.preventDefault(); item.el.classList.add("resizing");
        startX = e.touches?e.touches[0].clientX:e.clientX; startY = e.touches?e.touches[0].clientY:e.clientY;
        startW = item.w; startH = item.h;
        document.addEventListener("touchmove", onMove, {passive:false}); document.addEventListener("touchend", onEnd);
        document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onEnd);
    };
    const onMove = (e) => {
        e.preventDefault(); const clientX = e.touches?e.touches[0].clientX:e.clientX; const clientY = e.touches?e.touches[0].clientY:e.clientY;
        let newCols = Math.round((startW + (clientX - startX)) / COL_WIDTH); let newRows = Math.round((startH + (clientY - startY)) / ROW_HEIGHT);
        if(newCols < 1) newCols = 1; if(newCols > 4) newCols = 4; if(newRows < 1) newRows = 1; if(newRows > 6) newRows = 6;
        const pxW = newCols * COL_WIDTH - 15; const pxH = newRows * ROW_HEIGHT - 15;
        item.el.style.width = pxW + "px"; item.el.style.height = pxH + "px";
        if(newCols !== item.cols || newRows !== item.rows) {
            item.cols = newCols; item.rows = newRows; item.w = pxW; item.h = pxH;
            if(item.subtype !== 'loading') item.el.querySelector(".widget-content").innerHTML = getWidgetHTML(item.subtype, item.cols);
            if(item.subtype === "clock") updateClock();
            resolveCollisions(item); updateVisualPosition(item); updateContainerHeight();
        }
    };
    const onEnd = () => {
        document.removeEventListener("touchmove", onMove); document.removeEventListener("touchend", onEnd);
        document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onEnd);
        item.el.classList.remove("resizing"); updateVisualPosition(item); saveLayout();
    };
    handle.addEventListener("touchstart", onStart, {passive:false}); handle.addEventListener("mousedown", onStart);
}
window.addEventListener("resize", () => {
    SCREEN_W = document.getElementById("ag").clientWidth || window.innerWidth;
    COL_WIDTH = SCREEN_W / COL_COUNT;
    items.forEach(i => {
        const col = Math.round(i.x / (SCREEN_W/COL_COUNT)); 
        i.x = col * COL_WIDTH; i.w = i.cols * COL_WIDTH - (i.type==="app"?0:15);
        updateVisualPosition(i);
    });
});
init();
</script>
</body>
</html>
