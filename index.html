<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1,minimum-scale=1,viewport-fit=cover">
<title>Santaslileper OS v8</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body,html{touch-action:none;overscroll-behavior:none;height:100%;height:100dvh;width:100%;overflow:hidden;background:#000}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;user-select:none;-webkit-user-select:none;color:#fff}
.p{position:relative;background-color:#000;overflow:hidden;display:flex;flex-direction:column;background-position:center;background-size:cover;transition:background-image .3s,background-color .3s;width:100%;height:100%}
@media (min-width:768px),(orientation:landscape){.p{width:auto!important;height:95vh!important;aspect-ratio:9/19.5!important;margin:0 auto!important;position:absolute!important;top:50%!important;left:50%!important;transform:translate(-50%,-50%)!important;border-radius:40px!important;box-shadow:0 0 0 10px #2c2c2e;border:2px solid #333}}

/* --- FIX: NOTCH / SAFE AREA SUPPORT --- */
:root {
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 20px);
}

#lock-screen{
    position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);z-index:10000;display:flex;flex-direction:column;align-items:center;transition:transform .4s cubic-bezier(.2,.8,.2,1);
    padding-top: calc(100px + var(--safe-top));
}
#ls-clock{font-size:80px;font-weight:200;text-shadow:0 2px 10px rgba(0,0,0,.3)}
#ls-date{font-size:20px;font-weight:500;margin-top:-10px;opacity:.9}
.swipe-hint{position:absolute;bottom:30px;width:100%;text-align:center;font-size:14px;opacity:.7;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.4;transform:translateY(0)}50%{opacity:1;transform:translateY(-5px)}}
.hi{position:absolute;bottom:0;left:0;width:100%;height:30px;z-index:9000;pointer-events:auto;display:flex;justify-content:center;align-items:center}.hi::after{content:'';display:block;width:130px;height:5px;background:rgba(255,255,255,.5);border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.3)}

.h{
    position:absolute;top:0;left:0;right:0;bottom:0;
    padding-top: calc(20px + var(--safe-top));
    transition:transform .4s,filter .4s;overflow-y:auto;overflow-x:hidden;display:block
}
.h.zo{transform:scale(.85);filter:brightness(.6) blur(5px);pointer-events:none}
#ag{position:relative;width:100%;min-height:100vh;padding-bottom:200px}

.grid-item{position:absolute;transition:left .3s cubic-bezier(.34,1.56,.64,1),top .3s cubic-bezier(.34,1.56,.64,1);touch-action:none;z-index:10}.grid-item.resizing{transition:none;z-index:100;opacity:.9;background:rgba(44,44,46,.9)!important;border:1px solid #007aff!important;border-radius:20px}.edit-mode .grid-item:not(.resizing):not(.dragging){animation:jiggle .3s infinite linear;cursor:grab}.edit-mode .grid-item.dragging{z-index:100;animation:none;transform:scale(1.1);opacity:.8;transition:none}@keyframes jiggle{0%{transform:rotate(-1.5deg)}50%{transform:rotate(1.5deg)}100%{transform:rotate(-1.5deg)}}
.aiw{width:80px;height:95px;display:flex;flex-direction:column;align-items:center}.ai{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.3);background:linear-gradient(135deg,#333,#555)}.al{color:#fff;font-size:11px;margin-top:5px;text-shadow:0 1px 2px rgba(0,0,0,.8);text-align:center;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ai.store{background:linear-gradient(135deg,#007aff,#00c6ff)}.ai.motion{background:linear-gradient(135deg,#5e5ce6,#3b3a99)}.ai.torch{background:linear-gradient(135deg,#ff9f0a,#d48200)}.ai.speaker{background:linear-gradient(135deg,#30d158,#1ea340)}.ai.camera{background:linear-gradient(135deg,#ff375f,#d61e42)}.ai.mic{background:linear-gradient(135deg,#0a84ff,#0056b3)}.ai.touch{background:linear-gradient(135deg,#32ade6,#007aff)}.ai.settings{background:linear-gradient(135deg,#8e8e93,#636366)}.widget{background:0 0;border-radius:20px;overflow:hidden;color:#fff;display:flex;flex-direction:column}.edit-mode .widget{background:rgba(30,41,59,.6);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.15)}.widget-content{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:10px;text-align:center;width:100%;height:100%;overflow:hidden;text-shadow:0 2px 8px rgba(0,0,0,.6)}.del-btn{position:absolute;top:-5px;left:0;width:22px;height:22px;background:rgba(255,255,255,.3);backdrop-filter:blur(5px);border-radius:50%;display:none;z-index:20;color:#fff;font-weight:700;font-size:14px;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,.3);border:1px solid rgba(0,0,0,.1)}.del-btn::after{content:'‚úï'}.resize-handle{position:absolute;bottom:0;right:0;width:40px;height:40px;z-index:30;display:none}.resize-handle::after{content:'';position:absolute;bottom:8px;right:8px;width:15px;height:15px;border-bottom:3px solid #fff;border-right:3px solid #fff;border-radius:2px}.edit-mode .del-btn,.edit-mode .resize-handle{display:flex}.aiw .del-btn{top:-8px;left:0;background:#333;color:#fff}.aw{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;transform:translate3d(100%,0,0);transition:transform .4s cubic-bezier(.19,1,.22,1);z-index:50;display:flex;flex-direction:column}.aw.ac{transform:translate3d(0,0,0)}

.app-header{
    height: calc(44px + var(--safe-top));
    padding-top: var(--safe-top);
    display:flex;align-items:center;justify-content:space-between;padding-left:15px;padding-right:15px;background:rgba(20,20,20,.95);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.1);z-index:60
}

.ah-title{font-weight:600;font-size:15px;display:flex;align-items:center;gap:8px}.ah-btn{width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;color:#007aff;text-decoration:none;font-size:14px}.awc{flex:1;width:100%;position:relative;background:#fff;overflow-x:hidden;overflow-y:auto;touch-action:pan-y;overscroll-behavior-x:none}.awc.r90{overflow:hidden!important}iframe.aif{width:100%;height:100%;border:none;display:block}.blocked-layer{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1c1c1e;color:#fff;text-align:center;padding:20px;z-index:1}

/* --- FIX: APP STORE LOCKED SCROLL --- */
.store-app {
    background: #1c1c1e;
    color: #fff;
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    touch-action: pan-y;
    overscroll-behavior-x: none;
    overflow-x: hidden !important;
}
.store-header{padding:50px 20px 10px;background:rgba(28,28,30,.9);backdrop-filter:blur(10px);position:sticky;top:0;z-index:10;border-bottom:1px solid #333}.store-title{font-size:30px;font-weight:bold;margin-bottom:10px}.store-search{width:100%;background:#2c2c2e;border:none;padding:10px 15px;border-radius:10px;color:#fff;font-size:16px;outline:none}
.store-grid {
    padding: 20px;
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    width: 100%;
    box-sizing: border-box;
}

.store-item{background:#2c2c2e;padding:15px;border-radius:16px;display:flex;align-items:center;gap:15px}.store-icon{width:50px;height:50px;border-radius:12px;font-size:24px;display:flex;align-items:center;justify-content:center;background:#333}.store-info{flex:1}.store-name{font-weight:600;font-size:16px;margin-bottom:4px}.store-cat{font-size:12px;color:#8e8e93}.store-btn{background:#2c2c2e;color:#007aff;border:none;font-weight:bold;font-size:14px;padding:6px 14px;border-radius:14px;cursor:pointer;background:rgba(0,122,255,.15);transition:.2s;white-space:nowrap}.store-btn.installed{background:#333;color:#888;pointer-events:none}.as{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:40;display:none;flex-direction:row;align-items:center;overflow-x:auto;padding:0 calc(50vw - 35vw);scroll-snap-type:x mandatory}.sc{display:flex;height:100%;align-items:center;gap:20px;padding-left:20px;padding-right:20px}.scd{position:relative;width:70vw;max-width:300px;height:65vh;background:#222;border-radius:20px;scroll-snap-align:center;flex-shrink:0;overflow:hidden;transform:scale(1);box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;flex-direction:column}.scd iframe,.scd .blocked-layer,.scd .store-app,.scd .tc{pointer-events:none}.ch{height:40px;display:flex;align-items:center;justify-content:center;background:#333;color:#fff;font-size:12px;font-weight:bold;flex-shrink:0}.em{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;font-size:18px;display:none;text-align:center;pointer-events:none}#edit-ui{position:fixed;bottom:40px;left:20px;right:20px;height:50px;display:flex;justify-content:center;gap:15px;z-index:200;pointer-events:none;opacity:0}.edit-mode #edit-ui{opacity:1;pointer-events:auto}.ui-btn{padding:10px 20px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:none;border-radius:20px;color:#fff;font-weight:600}#add-panel{position:fixed;bottom:-400px;left:0;width:100%;background:#1c1c1e;border-radius:20px 20px 0 0;z-index:300;padding:20px;transition:bottom .3s}#add-panel.open{bottom:0}.add-opt{padding:15px;background:#2c2c2e;color:#fff;border-radius:12px;margin-bottom:10px;text-align:center}.tc{padding:60px 20px;color:#fff;text-align:center;background:#000;height:100%;overflow-y:auto;touch-action:pan-y;overscroll-behavior-x:none}.sg{max-width:320px;margin:20px auto;text-align:left}.sh{font-size:13px;color:#888;margin-bottom:8px;padding-left:15px;text-transform:uppercase}.so{background:#1c1c1e;border-radius:12px;overflow:hidden}.si{padding:12px 15px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}.si:last-child{border-bottom:none}select,input{background:#333;color:#fff;border:none;padding:5px 10px;border-radius:6px}.sr{display:flex;align-items:center;gap:10px}.sl{font-size:16px}.bgp{width:100px;height:60px;border-radius:6px;background-size:cover;background-position:center;border:2px solid #3a3a3c;cursor:pointer}.fb{padding:5px 10px;background:#007aff;border-radius:5px;border:none;color:white;cursor:pointer}.db{background:#ff3b30!important}input[type="file"]{display:none}

/* FORCED NOTCH OVERRIDES */
body.force-notch .app-header { padding-top: 47px !important; height: 91px !important; }
body.force-notch .h { padding-top: 60px !important; }
body.force-notch #lock-screen { padding-top: 140px !important; }
</style>
</head>
<body>
<div class="p" id="phone">
<div id="lock-screen"><div style="font-size:40px;margin-bottom:10px">üîì</div><div id="ls-clock">12:00</div><div id="ls-date">Wednesday, October 10</div><div class="swipe-hint">Swipe up to unlock</div></div>
<div class="h" id="h"><div id="ag"></div></div>
<div class="aw" id="app-window"><div class="app-header"><div class="ah-title"><span id="aw-icon"></span><span id="aw-title">App</span><span style="font-size:10px;opacity:0.5;margin-left:5px;cursor:pointer" onclick="rotateApp()">üîÑ</span></div><a href="#" target="_blank" id="aw-link" class="ah-btn">‚Üó</a></div><div class="awc" id="awc"></div></div>
<div class="as" id="switcher"><div class="sc" id="scc"></div><div class="em" id="empty-msg">No Recent Apps<br><span style="font-size:14px;opacity:0.6">Tap to close</span></div></div>
<div class="hi" id="hi"></div>
<div id="edit-ui"><button class="ui-btn" onclick="openAddPanel()">+ Widget</button><button class="ui-btn" style="background:#007aff" onclick="toggleEdit(false)">Done</button></div>
</div>

<div id="add-panel">
    <h3 style="color:#fff;margin-bottom:15px;text-align:center">Add Widget</h3>
    <div class="add-opt" onclick="addWidget('clock')">‚è∞ Clock</div>
    <div class="add-opt" onclick="addWidget('weather')">‚òÅÔ∏è Weather</div>
    <div class="add-opt" onclick="addWidget('calendar')">üìÖ Calendar</div>
    <div class="add-opt" onclick="addWidget('search')">üîç Google Bar</div>
    <div class="add-opt" onclick="closeAddPanel()">Cancel</div>
</div>

<script>
/* --- UPDATED PC REDIRECT (Lower threshold for "Request Desktop Site") --- */
function checkPlatform() {
    const ua = navigator.userAgent.toLowerCase();
    const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
    
    // CHANGED TO 768px (Common "Desktop Mode" virtual width is 980px)
    if (!isMobile && window.innerWidth > 768) {
        window.location.href = "indexpc.html";
    }
}
checkPlatform();

/* --- SAFE AREA CHECKER --- */
function checkSafeAreas() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isIOS && isStandalone) {
        document.body.classList.add('force-notch');
    }
}

/* --- APP DATA --- */
const STORE_APPS=[{id:'yt-trend',title:"TV Trending",icon:"üì∫",url:"https://www.youtube.com/embed?listType=playlist&list=PLrEnWoR732-BHrPp_Pm8_VleD92fq9KSz",cat:"Video",class:"camera"},{id:'music-lofi',title:"Lofi Girl",icon:"‚òï",url:"https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1",cat:"Music",class:"speaker"},{id:'radio',title:"Radio Garden",icon:"üåç",url:"http://radio.garden/visit/london/bP1_4s8M",cat:"Music",class:"speaker"},{id:'soundcloud',title:"SoundCloud",icon:"‚òÅÔ∏è",url:"https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/123456789&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true",cat:"Music",class:"speaker"},{id:'vimeo',title:"Vimeo Watch",icon:"‚ñ∂Ô∏è",url:"https://player.vimeo.com/video/76979871",cat:"Video",class:"camera"},{id:'ted',title:"TED Talks",icon:"CX",url:"https://embed.ted.com/talks/blaise_aguera_y_arcas_how_computers_are_learning_to_be_creative",cat:"Education",class:"mic"},{id:'grapple',title:"Grapple",icon:"ü™ù",url:"page3.html",cat:"Games",class:"motion"},{id:'minecraft',title:"Minecraft Classic",icon:"üß±",url:"https://classic.minecraft.net",cat:"Games",class:"touch"},{id:'2048',title:"2048",icon:"üî¢",url:"https://play2048.co/",cat:"Games",class:"torch"},{id:'hextris',title:"Hextris",icon:"six",url:"https://hextris.io/",cat:"Games",class:"motion"},{id:'chess',title:"Lichess",icon:"‚ôüÔ∏è",url:"https://lichess.org/tv/frame?theme=brown&bg=dark",cat:"Games",class:"settings"},{id:'solitaire',title:"Solitaire",icon:"üÉè",url:"https://www.solitr.com/",cat:"Games",class:"touch"},{id:'sudoku',title:"Web Sudoku",icon:"‚úèÔ∏è",url:"https://www.websudoku.com/?widget=yes&in=yes",cat:"Games",class:"torch"},{id:'pokedex',title:"Pokedex",icon:"üî¥",url:"https://pokedex.org/",cat:"Games",class:"camera"},{id:'dino',title:"Dino Run",icon:"ü¶ñ",url:"https://chromedino.com/",cat:"Games",class:"settings"},{id:'geo',title:"GeoGuessr Free",icon:"üåé",url:"https://geoguessr.com/free",cat:"Games",class:"touch"},{id:'calc',title:"Calculator",icon:"üßÆ",url:"https://www.desmos.com/scientific",cat:"Utilities",class:"torch"},{id:'graph',title:"Graphing Calc",icon:"üìà",url:"https://www.desmos.com/calculator",cat:"Utilities",class:"torch"},{id:'translate',title:"Bing Translate",icon:"Êñá",url:"https://www.bing.com/translator",cat:"Utilities",class:"mic"},{id:'maps',title:"Google Maps",icon:"üó∫Ô∏è",url:"http://googleusercontent.com/maps.google.com/embed?pb=!1m14!1m12!1m3!1d3312.3810141979455!2d-118.2437!3d34.0522!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0",cat:"Navigation",class:"touch"},{id:'speed',title:"Speed Test",icon:"üöÄ",url:"https://fast.com",cat:"Utilities",class:"motion"},{id:'convert',title:"Unit Converter",icon:"‚öñÔ∏è",url:"https://www.unitconverters.net/",cat:"Utilities",class:"settings"},{id:'timer',title:"Stopwatch",icon:"‚è±Ô∏è",url:"https://vclock.com/embed/stopwatch/",cat:"Utilities",class:"touch"},{id:'dictionary',title:"Dictionary",icon:"üìñ",url:"https://www.dictionary.com",cat:"Reference",class:"speaker"},{id:'periodic',title:"Periodic Table",icon:"üß™",url:"https://www.ptable.com/?wide=1",cat:"Education",class:"motion"},{id:'vscode',title:"VS Code",icon:"üíª",url:"https://vscode.dev",cat:"Dev",class:"motion"},{id:'photopea',title:"Photopea",icon:"üé®",url:"https://www.photopea.com",cat:"Creative",class:"camera"},{id:'codepen',title:"CodePen",icon:"‚úíÔ∏è",url:"https://codepen.io/pen/",cat:"Dev",class:"touch"},{id:'glitch',title:"Glitch",icon:"üéè",url:"https://glitch.com/",cat:"Dev",class:"motion"},{id:'excalidraw',title:"Whiteboard",icon:"‚úèÔ∏è",url:"https://excalidraw.com/",cat:"Creative",class:"torch"},{id:'drum',title:"Drum Machine",icon:"ü•Å",url:"https://drumbit.app/",cat:"Creative",class:"speaker"},{id:'pixel',title:"Pixel Art",icon:"üëæ",url:"https://www.piskelapp.com/p/create",cat:"Creative",class:"camera"},{id:'wiki',title:"Wikipedia",icon:"üìö",url:"https://m.wikipedia.org",cat:"Reference",class:"settings"},{id:'bing',title:"Bing Search",icon:"üîç",url:"https://www.bing.com",cat:"Search",class:"touch"},{id:'duck',title:"DuckDuckGo",icon:"ü¶Ü",url:"https://duckduckgo.com",cat:"Search",class:"motion"},{id:'hackernews',title:"Hacker News",icon:"OY",url:"https://news.ycombinator.com/",cat:"News",class:"mic"},{id:'cnn',title:"CNN Lite",icon:"üì∞",url:"https://lite.cnn.com",cat:"News",class:"speaker"},{id:'npr',title:"NPR Text",icon:"üìª",url:"https://text.npr.org",cat:"News",class:"speaker"},{id:'meteo',title:"Wind Map",icon:"ww",url:"https://embed.windy.com",cat:"Weather",class:"camera"},{id:'discord',title:"Discord",icon:"üí¨",url:"https://discord.com/app",cat:"Social",class:"mic"},{id:'telegram',title:"Telegram",icon:"‚úàÔ∏è",url:"https://web.telegram.org/k/",cat:"Social",class:"touch"},{id:'mastodon',title:"Mastodon",icon:"üêò",url:"https://mastodon.social/explore",cat:"Social",class:"motion"},{id:'slack',title:"Slack",icon:"#",url:"https://app.slack.com/client",cat:"Social",class:"settings"},{id:'files',title:"Files",icon:"üóÉÔ∏è",url:"page17.html",cat:"System",class:"camera"},{id:'mortis',title:"Mortis Cloud",icon:"‚ò†Ô∏è",url:"page67.html",cat:"System",class:"torch"},{id:'chat',title:"Secure Chat",icon:"üí¨",url:"page69.html",cat:"Social",class:"mic"},{id:'test',title:"Test Page",icon:"üöß",url:"page3000.html",cat:"Dev",class:"settings"}];const COL_COUNT=4,ROW_HEIGHT=100;let SCREEN_W=document.getElementById("ag").clientWidth||window.innerWidth;let COL_WIDTH=SCREEN_W/COL_COUNT;let items=[],runningApps=[],currentApp=null,isEditMode=!1,isSwitcherMode=!1;const STORAGE_KEY='santas_os_v8_layout',PREFS={t:'os_theme',f:'os_font',bg:'os_bg'};function gv(k,d){return localStorage.getItem(k)||d}function sv(k,v){localStorage.setItem(k,v)}function applyPreferences(){const t=gv(PREFS.t,'dark'),p=document.getElementById('phone'),bg=gv(PREFS.bg,''),m={light:['linear-gradient(135deg,#e0e0e0,#f5f5f5)','#000'],blue:['linear-gradient(135deg,#1e3c72,#2a5298)','#fff'],purple:['linear-gradient(135deg,#2d1b69,#5b3a9d)','#fff'],green:['linear-gradient(135deg,#0f2027,#203a43,#2c5364)','#fff'],red:['linear-gradient(135deg,#c31432,#240b36)','#fff'],orange:['linear-gradient(135deg,#f46b45,#eea849)','#fff'],pink:['linear-gradient(135deg,#ff9a9e,#fecfef)','#000']};if(bg){p.style.background='#000';p.style.backgroundImage=`url(${bg})`;p.style.backgroundSize='cover';p.style.backgroundPosition='center';document.querySelectorAll('.al').forEach(l=>l.style.color='#fff')}else if(m[t]){p.style.backgroundImage='none';p.style.background=m[t][0];document.body.style.color=m[t][1];document.querySelectorAll('.al').forEach(l=>l.style.color=m[t][1])}else{p.style.backgroundImage='none';p.style.backgroundColor='#000';document.querySelectorAll('.al').forEach(l=>l.style.color='#fff')}const f=gv(PREFS.f,'system'),fm={system:'-apple-system,BlinkMacSystemFont,"SF Pro Display",sans-serif',serif:'Georgia,"Times New Roman",serif',mono:'"Courier New",Courier,monospace',rounded:'ui-rounded,"SF Pro Rounded",system-ui,sans-serif'};document.body.style.fontFamily=fm[f]||fm.system}function init(){updateClock();setInterval(updateClock,1000);setupLockScreen();applyPreferences();setupSwitcherClick();checkSafeAreas();const saved=localStorage.getItem(STORAGE_KEY);if(saved){try{const data=JSON.parse(saved);data.forEach(d=>createItem(d.type,d.x,d.y,d.cols,d.rows,d))}catch(e){loadDefaults()}}else{loadDefaults()}const grid=document.getElementById("ag");let pressTimer;grid.addEventListener("touchstart",e=>{if(e.target===grid||e.target.classList.contains("aiw")){pressTimer=setTimeout(()=>{if(navigator.vibrate)navigator.vibrate(50);toggleEdit(!0)},800)}});grid.addEventListener("touchend",()=>clearTimeout(pressTimer));setupHomeGesture();window.addEventListener("resize",checkOrientation)}function checkOrientation(){if(window.innerWidth>window.innerHeight&&currentApp){rotateApp(!0)}else if(currentApp){rotateApp(!1)}}function loadDefaults(){createItem('widget',0,0,2,2,{subtype:'clock'});createItem('widget',2*COL_WIDTH,0,2,2,{subtype:'weather'});const initialApps=[{title:"App Store",icon:"üÖ∞Ô∏è",path:"system:store",class:"store"},{title:"Settings",icon:"‚öôÔ∏è",path:"system:settings",class:"settings"},{title:"Grapple",icon:"ü™ù",path:"page3.html",class:"motion"},{title:"Calculator",icon:"üßÆ",path:"https://www.desmos.com/scientific",class:"torch"},{title:"AI Learn",icon:"ü§ñ",path:"page6.html",class:"speaker"},{title:"News",icon:"üì∞",path:"https://lite.cnn.com",class:"motion"},{title:"Files",icon:"üóÉÔ∏è",path:"page17.html",class:"camera"},{title:"Chat",icon:"üí¨",path:"page69.html",class:"mic"},{title:"Maps",icon:"üó∫Ô∏è",path:"http://googleusercontent.com/maps.google.com/embed?pb=!1m14!1m12!1m3!1d3312.3810141979455!2d-118.2437!3d34.0522!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0",class:"touch"}];initialApps.forEach((app,i)=>{const row=2+Math.floor(i/4),col=i%4;createItem('app',col*COL_WIDTH,row*ROW_HEIGHT,1,1,app)});saveLayout()}function setupLockScreen(){const ls=document.getElementById("lock-screen");let sy=0;ls.addEventListener("touchstart",e=>sy=e.touches[0].clientY);ls.addEventListener("touchmove",e=>{const dy=e.touches[0].clientY-sy;if(dy<0)ls.style.transform=`translateY(${dy}px)`});ls.addEventListener("touchend",e=>{const dy=e.changedTouches[0].clientY-sy;if(dy<-150){ls.style.transform=`translateY(-100%)`;ls.style.opacity='0';setTimeout(()=>ls.style.display='none',400)}else{ls.style.transform=`translateY(0)`}})}function updateClock(){const now=new Date(),time=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),date=now.toLocaleDateString([],{weekday:'long',month:'long',day:'numeric'});document.getElementById("ls-clock").innerText=time;document.getElementById("ls-date").innerText=date;const wc=document.getElementById("w-clock");if(wc)wc.innerText=time}function setupHomeGesture(){const hi=document.getElementById("hi");let sy=0;hi.addEventListener("touchstart",e=>{sy=e.touches[0].clientY;e.stopPropagation()});hi.addEventListener("touchend",e=>{const dy=e.changedTouches[0].clientY-sy;if(dy<-30){if(currentApp){minimizeApp();openSwitcher()}else if(isSwitcherMode){closeSwitcher()}else if(runningApps.length>0&&!isEditMode){openSwitcher()}}})}function createItem(type,x,y,cw,ch,data){const el=document.createElement("div");el.className="grid-item";const w=cw*COL_WIDTH-(type==="app"?0:15),h=ch*ROW_HEIGHT-(type==="app"?10:15);if(data.w)el.style.width=data.w+"px";if(data.h)el.style.height=data.h+"px";let inner='';if(type==="app"){el.classList.add("aiw");inner=`<div class="del-btn"></div><div class="ai ${data.class||'touch'}">${data.icon}</div><div class="al">${data.title}</div>`;el.onclick=()=>{if(!isEditMode)launchApp(data)}}else{el.classList.add("widget");inner=`<div class="del-btn"></div><div class="resize-handle"></div><div class="widget-content">${getWidgetHTML(data.subtype)}</div>`}el.innerHTML=inner;el.querySelector(".del-btn").onclick=e=>{e.stopPropagation();deleteItem(el)};document.getElementById("ag").appendChild(el);const item={el,type,subtype:data.subtype,x,y,w,h,cols:cw,rows:ch,...data};if(!item.w)item.w=w;if(!item.h)item.h=h;items.push(item);updateVisuals(item);if(type==="widget")setupResize(item);setupDrag(item);updateContainer();return item}

function getWidgetHTML(type){
    if(type==="clock")return `<h1 style="margin:0;font-size:34px;font-weight:300" id="w-clock">--:--</h1><div style="font-size:11px;opacity:0.7">LOCAL</div>`;
    if(type==="weather")return `<div style="font-size:35px">‚õàÔ∏è</div><div style="font-size:22px;font-weight:bold">16¬∞</div>`;
    if(type==="calendar")return `<div style="color:#ff3b30;font-weight:bold">OCT</div><div style="font-size:40px">10</div>`;
    if(type==="search") return `<div style="width:90%;height:40px;background:#fff;border-radius:20px;display:flex;align-items:center;padding:0 10px;box-shadow:0 2px 10px rgba(0,0,0,0.2);"><span style="font-size:18px;margin-right:8px;color:#000">üîç</span><input type="text" placeholder="Search Google..." style="flex:1;border:none;background:transparent;color:#000;font-size:14px;outline:none;" onkeydown="if(event.key==='Enter') runSearch(this.value)" ontouchstart="event.stopPropagation()" onmousedown="event.stopPropagation()"></div>`;
    return ""
}

function runSearch(q){if(!q)return;launchApp({title:"Google",icon:"üîç",path:"https://www.google.com/search?igu=1&q="+encodeURIComponent(q),class:"touch"});}

function launchApp(data){let app=runningApps.find(a=>a.path===data.path);if(!app){app={...data,dom:createAppDOM(data)};runningApps.push(app)}const aw=document.getElementById("app-window"),awc=document.getElementById("awc"),link=document.getElementById("aw-link");document.getElementById("aw-title").innerHTML=`<span id="aw-icon">${data.icon}</span><span id="aw-title">${data.title}</span><span style="font-size:10px;opacity:0.5;margin-left:5px;cursor:pointer" onclick="rotateApp()">üîÑ</span>`;if(data.path.startsWith("http")){link.style.display="flex";link.href=data.path}else{link.style.display="none"}if(!awc.contains(app.dom)){awc.appendChild(app.dom)}Array.from(awc.children).forEach(child=>{child.style.display='none'});app.dom.style.display='block';currentApp=app;aw.classList.add("ac");awc.classList.remove('r90');awc.style.transform='';awc.style.width='';awc.style.height='';if(window.innerWidth>window.innerHeight){rotateApp(!0)}document.getElementById("h").classList.add("zo");closeSwitcher()}function rotateApp(forceState){const aw=document.getElementById("app-window"),awc=document.getElementById("awc"),isRotated=awc.classList.contains("r90"),shouldRotate=forceState!==undefined?forceState:!isRotated;if(shouldRotate){awc.classList.add("r90");const w=aw.offsetHeight,h=aw.offsetWidth;awc.style.width=w+"px";awc.style.height=h+"px";awc.style.position="absolute";awc.style.top="50%";awc.style.left="50%";awc.style.transform="translate(-50%, -50%) rotate(90deg)"}else{awc.classList.remove("r90");awc.style.width="";awc.style.height="";awc.style.transform="";awc.style.position="relative";awc.style.top="";awc.style.left=""}}function createAppDOM(data){const d=document.createElement("div");d.style.cssText="width:100%;height:100%;background:#fff;";if(data.path==="system:store"){renderAppStore(d)}else if(data.path==="system:settings"){d.innerHTML=`<div class="tc"><div style="font-size:60px;margin-bottom:20px;color:#000">‚öôÔ∏è</div><h2 style="margin-bottom:30px;color:#000">Settings</h2><div class="sg"><div class="sh">Appearance</div><div class="so"><div class="si"><span class="sl">Theme</span><div class="sr"><select id="tsl"><option value="dark">Dark</option><option value="light">Light</option><option value="blue">Ocean Blue</option><option value="purple">Purple</option><option value="green">Forest</option><option value="red">Red Velvet</option><option value="orange">Sunset</option><option value="pink">Pink Dream</option></select></div></div><div class="si"><span class="sl">Font</span><div class="sr"><select id="fsl"><option value="system">System</option><option value="serif">Serif</option><option value="mono">Mono</option><option value="rounded">Rounded</option></select></div></div><div class="si"><span class="sl">Background</span><div class="sr"><div class="bgp" id="bgp"></div><label for="bgi" class="fb">Upload</label><input type="file" id="bgi" accept="image/*"></div></div></div></div><div class="sg"><div class="sh">System</div><div class="so"><div class="si"><span class="sl">Clear Wallpaper</span><div class="sr"><button class="fb db" id="cbg">Clear</button></div></div><div class="si"><span class="sl">Reset OS</span><div class="sr"><button class="fb db" onclick="resetOS()">Reset</button></div></div></div></div></div>`;hydrateSettingsEvents(d)}else{d.innerHTML=`<div class="blocked-layer"><div style="font-size:40px;margin-bottom:10px">${data.icon}</div><h3>${data.title}</h3><p style="opacity:0.6;margin:10px 0;font-size:13px">Loading inside OS...</p><p style="opacity:0.4;font-size:11px">If blank, this site blocks embedding.<br>Tap the arrow ‚Üó above to view.</p></div><iframe src="${data.path}" class="aif" allow="autoplay; fullscreen; geolocation; microphone; camera" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-modals" onload="this.style.position='relative';this.style.zIndex='2'"></iframe>`}return d}function hydrateSettingsEvents(container){setTimeout(()=>{const ts=container.querySelector('#tsl'),fs=container.querySelector('#fsl'),bgi=container.querySelector('#bgi'),bgp=container.querySelector('#bgp'),cbg=container.querySelector('#cbg');if(ts){ts.value=gv(PREFS.t,'dark');fs.value=gv(PREFS.f,'system');const bg=gv(PREFS.bg,'');if(bg)bgp.style.backgroundImage=`url(${bg})`;ts.onchange=e=>{sv(PREFS.t,e.target.value);sv(PREFS.bg,'');applyPreferences()};fs.onchange=e=>{sv(PREFS.f,e.target.value);applyPreferences()};bgi.onchange=e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>{const b64=ev.target.result;sv(PREFS.bg,b64);bgp.style.backgroundImage=`url(${b64})`;applyPreferences()};r.readAsDataURL(f)}};cbg.onclick=()=>{if(confirm('Clear wallpaper?')){sv(PREFS.bg,'');bgp.style.backgroundImage='';applyPreferences()}}}},100)}function resetOS(){if(confirm("Factory Reset: Clear all data and layout?")){localStorage.clear();location.reload()}}function renderAppStore(container){container.innerHTML=`<div class="store-app"><div class="store-header"><div class="store-title">App Store</div><input type="text" class="store-search" placeholder="Search apps..." onkeyup="filterStore(this.value)"></div><div class="store-grid" id="store-grid"></div></div>`;const grid=container.querySelector("#store-grid");STORE_APPS.forEach(app=>{const isInstalled=items.some(i=>i.path===app.url),el=document.createElement("div");el.className="store-item";el.setAttribute("data-name",app.title.toLowerCase());el.innerHTML=`<div class="store-icon" style="${getIconStyle(app.class)}">${app.icon}</div><div class="store-info"><div class="store-name">${app.title}</div><div class="store-cat">${app.cat}</div></div><button class="store-btn" onclick="launchStoreApp('${app.id}')">Open</button><button class="store-btn ${isInstalled?'installed':''}" onclick="installApp('${app.id}', this)">${isInstalled?'Added':'Get'}</button>`;grid.appendChild(el)})}function getIconStyle(cls){if(cls==='motion')return 'background: linear-gradient(135deg, #5e5ce6, #3b3a99)';if(cls==='speaker')return 'background: linear-gradient(135deg, #30d158, #1ea340)';if(cls==='camera')return 'background: linear-gradient(135deg, #ff375f, #d61e42)';if(cls==='mic')return 'background: linear-gradient(135deg, #0a84ff, #0056b3)';if(cls==='torch')return 'background: linear-gradient(135deg, #ff9f0a, #d48200)';return 'background: #555'}function filterStore(query){const q=query.toLowerCase();document.querySelectorAll(".store-item").forEach(el=>{el.style.display=el.getAttribute("data-name").includes(q)?"flex":"none"})}function installApp(id,btn){const app=STORE_APPS.find(a=>a.id===id);if(!app)return;const spot=findNextEmptySpot(1,1);createItem('app',spot.x,spot.y,1,1,{title:app.title,icon:app.icon,path:app.url,class:app.class});saveLayout();btn.innerText="Added";btn.classList.add("installed")}function launchStoreApp(id){const app=STORE_APPS.find(a=>a.id===id);if(app)launchApp({title:app.title,icon:app.icon,path:app.url})}function openSwitcher(){isSwitcherMode=!0;const sw=document.getElementById("switcher"),sc=document.getElementById("scc"),msg=document.getElementById("empty-msg");sw.style.display="flex";sc.innerHTML="";if(runningApps.length===0){msg.style.display="block"}else{msg.style.display="none";runningApps.forEach(app=>{const card=document.createElement("div");card.className="scd";card.innerHTML=`<div class="ch">${app.title}</div><div class="card-body" style="flex:1;background:#fff;position:relative;overflow:hidden"></div>`;const cardBody=card.querySelector('.card-body');app.dom.style.display='block';cardBody.appendChild(app.dom);card.onclick=e=>{e.stopPropagation();launchApp(app)};let sy=0;card.addEventListener("touchstart",e=>{sy=e.touches[0].clientY;e.stopPropagation()});card.addEventListener("touchend",e=>{e.stopPropagation();if(e.changedTouches[0].clientY-sy<-50){closeApp(app);openSwitcher()}});sc.appendChild(card)})}}function setupSwitcherClick(){const sw=document.getElementById("switcher");sw.onclick=e=>{if(e.target===sw||e.target.id==='empty-msg'||e.target.parentElement.id==='empty-msg'){closeSwitcher()}}}function closeSwitcher(){isSwitcherMode=!1;document.getElementById("switcher").style.display="none";document.getElementById("h").classList.remove("zo");if(currentApp)launchApp(currentApp)}function minimizeApp(){document.getElementById("app-window").classList.remove("ac");currentApp=null}function closeApp(app){if(app.dom&&app.dom.parentNode){app.dom.parentNode.removeChild(app.dom)}const idx=runningApps.indexOf(app);if(idx>-1)runningApps.splice(idx,1);if(currentApp===app)currentApp=null}function toggleEdit(v){isEditMode=v;document.body.classList.toggle("edit-mode",v);if(!v)saveLayout()}function openAddPanel(){document.getElementById("add-panel").classList.add("open")}function closeAddPanel(){document.getElementById("add-panel").classList.remove("open")}function addWidget(type){closeAddPanel();const s=findNextEmptySpot(2,2);createItem('widget',s.x,s.y,2,2,{subtype:type});saveLayout()}function deleteItem(el){const i=items.findIndex(x=>x.el===el);if(i>-1){items.splice(i,1);el.remove();saveLayout()}}function updateVisuals(i){const ox=(i.cols*COL_WIDTH-i.w)/2,oy=(i.rows*ROW_HEIGHT-i.h)/2;i.el.style.left=(i.x+ox)+"px";i.el.style.top=(i.y+oy)+"px";i.el.style.width=i.w+"px";i.el.style.height=i.h+"px"}

/* --- NEW BUMPING LOGIC (Taken from your example) --- */
function findNextEmptySpot(w,h,excludeList=items){let o=0;for(;;){for(let i=0;i<COL_COUNT;i++){if(i+w>COL_COUNT)continue;const d=i*COL_WIDTH,s=o*ROW_HEIGHT;if(!excludeList.some(n=>d<n.x+n.cols*COL_WIDTH&&d+w*COL_WIDTH>n.x&&s<n.y+n.rows*ROW_HEIGHT&&s+h*ROW_HEIGHT>n.y))return{x:d,y:s}}o++;if(o>500)return{x:0,y:o*ROW_HEIGHT}}}

function rectIntersect(e,t){return e.x+10<t.x+t.cols*COL_WIDTH&&e.x+e.cols*COL_WIDTH-10>t.x&&e.y+10<t.y+t.rows*ROW_HEIGHT&&e.y+e.rows*ROW_HEIGHT-10>t.y}

function resolveCollisions(e){items.filter(t=>t!==e).forEach(t=>{if(rectIntersect(e,t)){const n=items.filter(x=>x!==t),o=findNextEmptySpot(t.cols,t.rows,n);t.x=o.x;t.y=o.y;updateVisuals(t)}})}

function updateContainer(){let max=0;items.forEach(i=>max=Math.max(max,i.y+i.h));document.getElementById("ag").style.minHeight=(max+200)+"px"}
function saveLayout(){const data=items.map(i=>({type:i.type,subtype:i.subtype,x:i.x,y:i.y,cols:i.cols,rows:i.rows,title:i.title,icon:i.icon,path:i.path,class:i.class,w:i.w,h:i.h}));localStorage.setItem(STORAGE_KEY,JSON.stringify(data))}

function setupDrag(item){let sx,sy,sl,st;const move=e=>{const cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;item.el.style.left=(sl+cx-sx)+"px";item.el.style.top=(st+cy-sy)+"px";e.preventDefault()};const end=()=>{document.removeEventListener("touchmove",move);document.removeEventListener("mousemove",move);document.removeEventListener("touchend",end);document.removeEventListener("mouseup",end);item.el.classList.remove("dragging");
    /* MODIFIED: Snap and Bump Logic */
    const l=parseFloat(item.el.style.left),t=parseFloat(item.el.style.top);
    let o=Math.round(l/COL_WIDTH)*COL_WIDTH,i=Math.round(t/ROW_HEIGHT)*ROW_HEIGHT;
    if(o<0)o=0; if(o>SCREEN_W-item.w)o=SCREEN_W-item.cols*COL_WIDTH;
    if(i<0)i=0;
    item.x=o; item.y=i;
    resolveCollisions(item);
    updateVisuals(item);
    updateContainer();
    saveLayout();
};const start=e=>{if(isEditMode&&!e.target.classList.contains("del-btn")&&!e.target.className.includes("resize")){item.el.classList.add("dragging");sx=e.touches?e.touches[0].clientX:e.clientX;sy=e.touches?e.touches[0].clientY:e.clientY;sl=parseFloat(item.el.style.left);st=parseFloat(item.el.style.top);document.addEventListener("touchmove",move,{passive:!1});document.addEventListener("mousemove",move);document.addEventListener("touchend",end);document.addEventListener("mouseup",end)}};item.el.addEventListener("touchstart",start,{passive:!1});item.el.addEventListener("mousedown",start)}

function setupResize(item){const h=item.el.querySelector(".resize-handle");if(!h)return;let sx,sy,sw,sh;const move=e=>{const cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY,nw=sw+(cx-sx),nh=sh+(cy-sy);item.el.style.width=nw+"px";item.el.style.height=nh+"px";e.preventDefault();e.stopPropagation()};const end=()=>{document.removeEventListener("touchmove",move);document.removeEventListener("touchend",end);item.el.classList.remove("resizing");
    const nw=parseFloat(item.el.style.width),nh=parseFloat(item.el.style.height);
    item.cols=Math.max(1,Math.min(4,Math.round(nw/COL_WIDTH)));
    item.rows=Math.max(1,Math.min(6,Math.round(nh/ROW_HEIGHT)));
    item.w=item.cols*COL_WIDTH-15;item.h=item.rows*ROW_HEIGHT-15;
    item.el.querySelector(".widget-content").innerHTML=getWidgetHTML(item.subtype);
    /* MODIFIED: Resolve Collisions on Resize */
    resolveCollisions(item);
    updateVisuals(item);
    saveLayout()
};h.addEventListener("touchstart",e=>{e.stopPropagation();item.el.classList.add("resizing");sx=e.touches[0].clientX;sy=e.touches[0].clientY;sw=item.w;sh=item.h;document.addEventListener("touchmove",move,{passive:!1});document.addEventListener("touchend",end)})}
init();
</script>
</body>
</html>