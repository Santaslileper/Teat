<script>
// --- CONFIG ---
const COL_COUNT=4, ROW_HEIGHT=100;
let SCREEN_W = document.getElementById("ag").clientWidth || window.innerWidth;
let COL_WIDTH = SCREEN_W / COL_COUNT;
let isEditMode = false;
let items = []; 
let runningApps = []; 
let currentApp = null; 
let isSwitcherMode = false;
const STORAGE_KEY = 'os_layout_final_v3';

// --- INITIAL LAYOUT ---
const defaultApps = [
    { title: "Files", icon: "üóÉÔ∏è", class: "files", path: "system:files" },
    { title: "News", icon: "üì∞", class: "news", path: "system:news" },
    { title: "Info", icon: "‚ÑπÔ∏è", class: "info", path: "system:tutorial" },
    { title: "Chat", icon: "üí¨", class: "chat", path: "system:chat" },
    { title: "Mortis", icon: "‚ò†Ô∏è", class: "mortis", path: "system:mortis" },
    { title: "AI Learn", icon: "ü§ñ", class: "ai-learn", path: "system:ai" },
    { title: "Themes", icon: "üé®", class: "themes", path: "system:themes" },
    { title: "Test 3k", icon: "üöß", class: "test", path: "system:test" },
    { title: "Grapple", icon: "üéÆ", class: "grapple", path: "system:game" },
    { title: "Cycles", icon: "‚è±Ô∏è", class: "cycles", path: "system:clock" },
    { title: "Settings", icon: "‚öôÔ∏è", class: "settings", path: "system:settings" },
    { title: "Calc", icon: "üßÆ", class: "calc", path: "system:calc" }
];

function init() {
    updateClock(); setInterval(updateClock, 1000);

    const savedLayout = localStorage.getItem(STORAGE_KEY);
    if (savedLayout) {
        try {
            const layoutData = JSON.parse(savedLayout);
            layoutData.forEach(itemData => createItem(itemData.type, itemData.x, itemData.y, itemData.cols, itemData.rows, itemData));
        } catch(e) { loadDefaultApps(); }
    } else {
        loadDefaultApps();
    }

    // --- HOME GESTURES ---
    const hi = document.getElementById("hi");
    let startY = 0;
    hi.addEventListener("touchstart", (e) => { startY = e.touches[0].clientY; e.stopPropagation(); }, {passive:false});
    hi.addEventListener("touchend", (e) => {
        if(e.changedTouches[0].clientY - startY < -30) handleHomeGesture();
    }, {passive:false});

    // Edit Mode
    const grid = document.getElementById("ag");
    let pressTimer;
    grid.addEventListener("touchstart", e => {
        if(e.target === grid || e.target.classList.contains('aiw')) {
            pressTimer = setTimeout(() => toggleEdit(true), 800);
        }
    });
    grid.addEventListener("touchend", () => clearTimeout(pressTimer));
}

function loadDefaultApps() {
    createItem('widget', 0, 0, 2, 2, {subtype:'clock'});
    createItem('widget', 2 * COL_WIDTH, 0, 2, 2, {subtype:'weather'});
    let startRow = 2; 
    defaultApps.forEach((app, index) => {
        const col = index % 4;
        const row = startRow + Math.floor(index / 4);
        createItem('app', col * COL_WIDTH, row * ROW_HEIGHT, 1, 1, app);
    });
    saveLayout();
}

function saveLayout() {
    const layout = items.map(i => ({
        type: i.type, subtype: i.subtype, x: i.x, y: i.y, cols: i.cols, rows: i.rows,
        title: i.title, icon: i.icon, path: i.path, class: i.class
    }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(layout));
}

function handleHomeGesture() {
    if(currentApp) { minimizeApp(); openSwitcher(); }
    else if(isSwitcherMode) { closeSwitcher(); }
    else if(runningApps.length > 0 && !isEditMode) { openSwitcher(); }
}

// --- GRID ENGINE ---
function createItem(type, x, y, wUnit, hUnit, data={}) {
    const el = document.createElement("div");
    el.classList.add("grid-item");
    const wPx = wUnit * COL_WIDTH - (type === "app" ? 0 : 15);
    const hPx = hUnit * ROW_HEIGHT - (type === "app" ? 10 : 15);

    if (type === "app") {
        el.classList.add("aiw");
        el.innerHTML = `<div class="ai ${data.class||'files'}">${data.icon}</div><div class="al">${data.title}</div>`;
        el.onclick = () => { if(!isEditMode) launchApp(data); };
    } else {
        el.classList.add("widget");
        el.innerHTML = `<div class="del-btn">√ó</div><div class="resize-handle"></div><div class="widget-content">${data.subtype === 'loading' ? '<div class="loader"></div>' : getWidgetHTML(data.subtype, wUnit)}</div>`;
        el.querySelector(".del-btn").onclick = (e) => { e.stopPropagation(); deleteItem(el); };
    }
    document.getElementById("ag").appendChild(el);
    const itemObj = { 
        el: el, type: type, subtype: data.subtype, 
        x: x, y: y, w: wPx, h: hPx, cols: wUnit, rows: hUnit,
        title: data.title, icon: data.icon, path: data.path, class: data.class
    };
    updateVisualPosition(itemObj);
    setupDrag(itemObj);
    if(type === "widget") setupResize(itemObj);
    items.push(itemObj);
    updateContainerHeight();
    return itemObj;
}

function addWidget(type) {
    closeAddPanel();
    const spot = findNextEmptySpot(2, 2);
    const widgetItem = createItem("widget", spot.x, spot.y, 2, 2, { subtype: "loading" });
    resolveCollisions(widgetItem); updateVisualPosition(widgetItem); toggleEdit(true);
    setTimeout(() => {
        widgetItem.subtype = type;
        widgetItem.el.querySelector(".widget-content").innerHTML = getWidgetHTML(type, 2);
        if(type === 'clock') updateClock();
        resolveCollisions(widgetItem); updateVisualPosition(widgetItem); saveLayout();
    }, 1000);
}

function getWidgetHTML(type, cols) {
    if(type === "clock") return `<h1 style="margin:0;font-size:${cols>=3?"48px":"34px"};font-weight:300" id="w-clock">17:55</h1><div style="font-size:11px;opacity:0.7;margin-top:-2px;letter-spacing:1px">NEW YORK</div>`;
    if(type === "weather") return `<div style="font-size:35px;margin-bottom:5px">‚õàÔ∏è</div><div style="font-size:22px;font-weight:bold">16¬∞</div><div style="font-size:11px;opacity:0.7">Heavy Rain</div>`;
    if(type === "photo") return '<img src="https://images.unsplash.com/photo-1494548162494-384bba4ab999?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" style="width:100%;height:100%;object-fit:cover;border-radius:20px;">';
    if(type === "calendar") return `<div style="color:#ff3b30;font-weight:bold;font-size:20px">DEC</div><div style="font-size:40px">2</div>`;
    return "Widget";
}

// --- NEW DOM TRANSFER HELPERS ---

// Moves app content from the main window (awc) to the card (cardEl)
function moveContentToCard(app) {
    if (app.dom.parentNode) {
        app.dom.parentNode.removeChild(app.dom);
    }
    if (app.cardEl) {
        // Find the designated content holder on the card
        const contentHolder = app.cardEl.querySelector('.content-holder-class'); 
        if (contentHolder) {
            contentHolder.appendChild(app.dom);
        }
    }
}

// Moves app content from the card (cardEl) back to the main window (awc)
function restoreContentToWindow(app) {
    const awc = document.getElementById("awc");
    if (app.dom.parentNode) {
        app.dom.parentNode.removeChild(app.dom);
    }
    awc.appendChild(app.dom);
}

// --- MODIFIED APP LOGIC ---
function launchApp(appData) {
    let existing = runningApps.find(a => a.path === appData.path);
    if(!existing) {
        existing = { ...appData, dom: createInternalAppDOM(appData) };
        runningApps.push(existing);
    }
    
    // RESTORE content from card and append to main window container
    restoreContentToWindow(existing);

    requestAnimationFrame(() => {
        document.getElementById("app-window").classList.add("ac");
        document.getElementById("h").classList.add("zo");
    });
    currentApp = existing;
    if(isSwitcherMode) closeSwitcher();
}

function createInternalAppDOM(data) {
    const w = document.createElement("div");
    w.style.width = "100%"; w.style.height = "100%";
    if(data.path === "system:settings") {
        w.innerHTML = `<div class="tc"><div style="font-size:60px;margin-bottom:20px">‚öôÔ∏è</div><h2>Settings</h2><br><button class="fb db" onclick="resetFactory()">Reset Home Layout</button></div>`;
    } else {
        const i = document.createElement("iframe");
        i.className = "aif"; i.src = data.path.includes("system") ? "about:blank" : data.path; 
        w.appendChild(i);
    }
    return w;
}

function resetFactory() {
    if(confirm("Reset layout to default?")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

function minimizeApp() {
    if(!currentApp) return;
    document.getElementById("app-window").classList.remove("ac");
    currentApp = null;
}

function closeApp(app) {
    const idx = runningApps.indexOf(app);
    if(idx > -1) { 
        // Ensure content is restored/detached before removal
        if(app.cardEl) {
            moveContentToCard(app); // Ensure the DOM is in the card before removal if it was active
            app.cardEl.remove();
        } else if (app.dom.parentNode) {
            app.dom.parentNode.removeChild(app.dom); // Clean up if it was in the main window
        }

        runningApps.splice(idx, 1); 
    }
    if(runningApps.length === 0) closeSwitcher();
}

// --- MODIFIED SWITCHER ---
function openSwitcher() {
    isSwitcherMode = true;
    const s = document.getElementById("switcher");
    const sc = document.getElementById("scc");
    const h = document.getElementById("h");
    s.style.display = 'flex';
    document.getElementById("rcb").style.display = 'flex';
    h.classList.add("zo");
    sc.innerHTML = '';
    
    runningApps.forEach(app => {
        const card = document.createElement("div");
        card.className = "scd";
        const header = document.createElement("div");
        header.className = "ch";
        header.innerHTML = `<span style="color:#fff;font-size:12px;font-weight:bold">${app.title}</span>`;
        card.appendChild(header);
        
        // This is the dedicated container for the app DOM
        const contentHolder = document.createElement("div");
        contentHolder.className = "content-holder-class"; // Add class for helper function
        contentHolder.style.cssText = "width:100%;height:100%;pointer-events:none;padding-top:40px;background:#000";
        card.appendChild(contentHolder);
        
        const touchLayer = document.createElement("div");
        touchLayer.className = "ctl";
        card.appendChild(touchLayer);
        setupSwitcherGestures(touchLayer, card, app);
        sc.appendChild(card);
        app.cardEl = card; 
        
        // MOVE the content now that the card structure is ready
        moveContentToCard(app); 
    });
}


function closeSwitcher() {
    isSwitcherMode = false;
    document.getElementById("switcher").style.display = 'none';
    document.getElementById("rcb").style.display = 'none';
    document.getElementById("h").classList.remove("zo");

    // Restore all app contents back to the main app window (awc)
    runningApps.forEach(app => {
        if(app.cardEl) {
            restoreContentToWindow(app);
            app.cardEl.remove();
            app.cardEl = null;
        }
    });
}

function setupSwitcherGestures(touchLayer, card, app) {
    let startX = 0, startY = 0, isVertical = false, isHorizontal = false;
    
    touchLayer.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isVertical = false;
        isHorizontal = false;
    }, {passive:false});

    touchLayer.addEventListener('touchmove', (e) => {
        if(isHorizontal) return; // If scrolling left/right, ignore vertical
        
        const cx = e.touches[0].clientX;
        const cy = e.touches[0].clientY;
        const dx = cx - startX;
        const dy = cy - startY;

        // Determine axis
        if(!isVertical && !isHorizontal) {
            if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 5) {
                isHorizontal = true;
            } else if(Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 5) {
                isVertical = true;
            }
        }

        if(isVertical) {
            e.preventDefault(); // Stop scrolling, start moving card
            if(dy < 0) {
                 card.style.transform = `scale(0.9) translateY(${dy}px)`;
                 card.style.opacity = `${1 - Math.abs(dy)/500}`;
            }
        }
    }, {passive:false});

    touchLayer.addEventListener('touchend', (e) => {
        if(isVertical) {
            const dy = e.changedTouches[0].clientY - startY;
            if(dy < -100) {
                card.style.transition = "transform 0.3s ease, opacity 0.3s";
                card.style.transform = "translateY(-100vh)";
                card.style.opacity = "0";
                setTimeout(() => closeApp(app), 300);
            } else {
                card.style.transition = "transform 0.2s ease, opacity 0.2s";
                card.style.transform = "scale(1)";
                card.style.opacity = "1";
            }
        } else if(!isHorizontal) {
             // If we didn't scroll much in either direction, treat as tap
             const dy = e.changedTouches[0].clientY - startY;
             const dx = e.changedTouches[0].clientX - startX;
             if(Math.abs(dx) < 10 && Math.abs(dy) < 10) {
                 launchApp(app);
             }
        }
    });
}

// --- UTILS ---
function updateVisualPosition(item) {
    const offsetX = (item.cols * COL_WIDTH - item.w) / 2;
    const offsetY = (item.rows * ROW_HEIGHT - item.h) / 2;
    item.el.style.left = (item.x + offsetX) + "px";
    item.el.style.top = (item.y + offsetY) + "px";
}
function resolveCollisions(movedItem) {
    items.filter(i => i !== movedItem).forEach(other => {
        if(rectIntersect(movedItem, other)) {
            const others = items.filter(x => x !== other);
            const nextSpot = findNextEmptySpot(other.cols, other.rows, others);
            other.x = nextSpot.x; other.y = nextSpot.y;
            updateVisualPosition(other);
        }
    });
}
function rectIntersect(i1, i2) {
    const margin = 10;
    return (i1.x + margin < i2.x + i2.cols * COL_WIDTH) && (i1.x + i1.cols * COL_WIDTH - margin > i2.x) &&
           (i1.y + margin < i2.y + i2.rows * ROW_HEIGHT) && (i1.y + i1.rows * ROW_HEIGHT - margin > i2.y);
}
function findNextEmptySpot(cols, rows, currentItems = items) {
    let rowIdx = 0;
    while(true) {
        for(let colIdx = 0; colIdx < COL_COUNT; colIdx++) {
            if(colIdx + cols > COL_COUNT) continue; 
            const testX = colIdx * COL_WIDTH; const testY = rowIdx * ROW_HEIGHT;
            const collision = currentItems.some(i => testX < i.x + i.cols * COL_WIDTH && testX + cols * COL_WIDTH > i.x && testY < i.y + i.rows * ROW_HEIGHT && testY + rows * ROW_HEIGHT > i.y);
            if(!collision) return {x: testX, y: testY};
        }
        rowIdx++; if(rowIdx > 500) return {x:0, y:0};
    }
}
function updateContainerHeight() {
    let max = 0; items.forEach(i => { const bottom = i.y + i.h; if(bottom > max) max = bottom; });
    document.getElementById("ag").style.minHeight = (max + 300) + "px";
}
function toggleEdit(val) { isEditMode = val; document.body.classList.toggle("edit-mode", val); closeAddPanel(); }
function openAddPanel(){ document.getElementById("add-panel").classList.add("open"); }
function closeAddPanel(){ document.getElementById("add-panel").classList.remove("open"); }
function deleteItem(el) { 
    const idx = items.findIndex(i => i.el === el); 
    if(idx > -1) { items.splice(idx, 1); el.remove(); updateContainerHeight(); saveLayout(); } 
}
function updateClock() { const d = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); document.getElementById("c").innerText = d; document.querySelectorAll("#w-clock").forEach(e => e.innerText = d); }

// --- DRAG/RESIZE HANDLERS ---
function setupDrag(item){
    let startX, startY, startLeft, startTop;
    const onStart = (e) => {
        if(isEditMode && !e.target.className.includes("resize-handle") && !e.target.className.includes("del-btn")){
            e.preventDefault(); item.el.classList.add("dragging");
            startX = e.touches?e.touches[0].clientX:e.clientX; startY = e.touches?e.touches[0].clientY:e.clientY;
            startLeft = parseFloat(item.el.style.left); startTop = parseFloat(item.el.style.top);
            document.addEventListener("touchmove", onMove, {passive:false}); document.addEventListener("touchend", onEnd);
            document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onEnd);
        }
    };
    const onMove = (e) => {
        e.preventDefault(); const clientX = e.touches?e.touches[0].clientX:e.clientX; const clientY = e.touches?e.touches[0].clientY:e.clientY;
        item.el.style.left = startLeft + (clientX - startX) + "px"; item.el.style.top = startTop + (clientY - startY) + "px";
    };
    const onEnd = () => {
        document.removeEventListener("touchmove", onMove); document.removeEventListener("touchend", onEnd);
        document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onEnd);
        item.el.classList.remove("dragging");
        const left = parseFloat(item.el.style.left); const top = parseFloat(item.el.style.top);
        let col = Math.round(left / COL_WIDTH); let row = Math.round(top / ROW_HEIGHT);
        if(col < 0) col = 0; if(col > COL_COUNT - item.cols) col = COL_COUNT - item.cols; if(row < 0) row = 0;
        item.x = col * COL_WIDTH; item.y = row * ROW_HEIGHT;
        resolveCollisions(item); updateVisualPosition(item); updateContainerHeight(); saveLayout();
    };
    item.el.addEventListener("touchstart", onStart, {passive:false}); item.el.addEventListener("mousedown", onStart);
}
function setupResize(item){
    const handle = item.el.querySelector(".resize-handle");
    let startX, startY, startW, startH;
    const onStart = (e) => {
        e.stopPropagation(); e.preventDefault(); item.el.classList.add("resizing");
        startX = e.touches?e.touches[0].clientX:e.clientX; startY = e.touches?e.touches[0].clientY:e.clientY;
        startW = item.w; startH = item.h;
        document.addEventListener("touchmove", onMove, {passive:false}); document.addEventListener("touchend", onEnd);
        document.addEventListener("mousemove", onMove); document.addEventListener("mouseup", onEnd);
    };
    const onMove = (e) => {
        e.preventDefault(); const clientX = e.touches?e.touches[0].clientX:e.clientX; const clientY = e.touches?e.touches[0].clientY:e.clientY;
        let newCols = Math.round((startW + (clientX - startX)) / COL_WIDTH); let newRows = Math.round((startH + (clientY - startY)) / ROW_HEIGHT);
        if(newCols < 1) newCols = 1; if(newCols > 4) newCols = 4; if(newRows < 1) newRows = 1; if(newRows > 6) newRows = 6;
        const pxW = newCols * COL_WIDTH - 15; const pxH = newRows * ROW_HEIGHT - 15;
        item.el.style.width = pxW + "px"; item.el.style.height = pxH + "px";
        if(newCols !== item.cols || newRows !== item.rows) {
            item.cols = newCols; item.rows = newRows; item.w = pxW; item.h = pxH;
            if(item.subtype !== 'loading') item.el.querySelector(".widget-content").innerHTML = getWidgetHTML(item.subtype, item.cols);
            if(item.subtype === "clock") updateClock();
            resolveCollisions(item); updateVisualPosition(item); updateContainerHeight();
        }
    };
    const onEnd = () => {
        document.removeEventListener("touchmove", onMove); document.removeEventListener("touchend", onEnd);
        document.removeEventListener("mousemove", onMove); document.removeEventListener("mouseup", onEnd);
        item.el.classList.remove("resizing"); updateVisualPosition(item); saveLayout();
    };
    handle.addEventListener("touchstart", onStart, {passive:false}); handle.addEventListener("mousedown", onStart);
}
window.addEventListener("resize", () => {
    SCREEN_W = document.getElementById("ag").clientWidth || window.innerWidth;
    COL_WIDTH = SCREEN_W / COL_COUNT;
    items.forEach(i => {
        const col = Math.round(i.x / (SCREEN_W/COL_COUNT)); 
        i.x = col * COL_WIDTH; i.w = i.cols * COL_WIDTH - (i.type==="app"?0:15);
        updateVisualPosition(i);
    });
});
init();
</script>
