<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1,minimum-scale=1,viewport-fit=cover">
<title>Santaslileper OS</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNhbnRhc2xpbGVwZXIgT1MiLAogICJzaG9ydF9uYW1lIjogIlNhbnRhc09TIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAic3RhcnRfdXJsIjogIi8iCn0=">

<style>
/* =========================================
   ORIGINAL OS CSS
   ========================================= */
*{margin:0;padding:0;box-sizing:border-box}
body,html{touch-action:none;overscroll-behavior:none;min-height:100vh;min-height:-webkit-fill-available}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;background:#000;display:flex;justify-content:center;align-items:center;min-height:100vh;min-height:-webkit-fill-available;padding:20px;user-select:none;-webkit-user-select:none;cursor:default;overflow:hidden;position:fixed;width:100%;height:100%;top:0;left:0}
html{height:-webkit-fill-available}
.p,.s,.h,.ad,.aw,.as{touch-action:none}
.p{position:relative;width:100%;height:100%;max-width:375px;max-height:812px;background-color:#050505;background-image:radial-gradient(circle at center,#1a1a1a 0%,#000 100%);overflow:hidden;display:flex;flex-direction:column;border:1px solid #333}
@media(min-width:768px){.p{height:812px;border-radius:50px;box-shadow:0 0 0 12px #2c2c2e,0 20px 60px rgba(0,0,0,.8)}.n{position:absolute;top:0;left:50%;transform:translateX(-50%);width:180px;height:30px;background:#000;border-radius:0 0 20px 20px;z-index:100}}
.s{position:relative;width:100%;height:100%;overflow:hidden;z-index:2}
.sb{height:44px;padding:0 20px;display:flex;align-items:flex-end;justify-content:space-between;padding-bottom:8px;color:#fff;font-size:15px;font-weight:600;z-index:100;pointer-events:none;position:absolute;width:100%;top:0}
/* Modified .h to relative to allow absolute widgets inside */
.h{padding:60px 20px 80px 20px;height:100%;overflow-y:auto;transition:transform .4s cubic-bezier(.32,0,.67,0),filter .4s linear;will-change:transform,filter; position: relative;}
.h.zo{transform:scale(.85);filter:brightness(.6)blur(5px);pointer-events:none}
.ag{display:grid;grid-template-columns:repeat(4,1fr);gap:20px; padding-bottom: 200px;} /* Added padding for widgets space */
.aiw{display:flex;flex-direction:column;align-items:center;transition:transform .2s ease;touch-action:none}
.ai{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.3);background:linear-gradient(135deg,#333,#555)}
.ai.i{background:linear-gradient(135deg,#3498db,#2980b9)}
.ai.st{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}
.ai:active{filter:brightness(.8);transform:scale(.95)}
.al{color:#fff;font-size:11px;margin-top:5px;text-shadow:0 1px 2px rgba(0,0,0,.8)}
.ad{position:absolute;top:0;left:0;width:100%;height:100%;z-index:50;pointer-events:none}
.aw{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;transform:translate3d(100%,0,0);transition:transform .4s cubic-bezier(.19,1,.22,1);pointer-events:auto;overflow:hidden;display:flex;flex-direction:column}
.aw.ac{transform:translate3d(0,0,0)}
.awc{width:100%;height:calc(100% - 40px);overflow:auto;touch-action:pan-y pan-x;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.aif{width:100%;min-height:calc(100vh - 80px);border:none;display:block}
.as{position:absolute;top:0;left:0;width:100%;height:100%;background:transparent;z-index:40;display:none;flex-direction:row;align-items:center;overflow-x:auto;overflow-y:hidden;white-space:nowrap;scroll-snap-type:x mandatory;padding:0 20px;pointer-events:auto}
.sc{display:flex;height:100%;align-items:center;gap:20px;min-width:min-content}
.scd{position:relative;width:75vw;max-width:300px;height:70vh;background:#222;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.5);scroll-snap-align:center;flex-shrink:0;transform-origin:center;transition:transform .2s;overflow:hidden}
.ch{position:absolute;top:0;left:0;width:100%;height:40px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);z-index:20;pointer-events:none}
.ctl{position:absolute;top:40px;left:0;width:100%;height:calc(100% - 40px);z-index:15}
.rcx{position:absolute;top:50px;right:20px;width:30px;height:30px;background:rgba(60,60,60,.8);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:16px;cursor:pointer;z-index:200;backdrop-filter:blur(5px);display:none}
.em{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:16px;pointer-events:none}
.tc{width:100%;height:100%;background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:40px 20px;text-align:center;overflow-y:auto}
.ts{margin-bottom:15px;font-size:18px;color:#ccc}
.hi{position:absolute;bottom:0;left:0;width:100%;height:40px;display:flex;justify-content:center;align-items:center;z-index:999;touch-action:none;pointer-events:auto}
.hi::before{content:'';display:block;width:140px;height:5px;background:rgba(255,255,255,.7);border-radius:3px}
.aw .hi{z-index:1000;background:linear-gradient(to top,rgba(0,0,0,.8) 0%,rgba(0,0,0,.6) 60%,transparent 100%)}
.sg{width:100%;max-width:320px;margin-bottom:25px}
.sh{font-size:13px;color:#8e8e93;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;text-align:left;padding:0 15px}
.so{background:#1c1c1e;border-radius:10px;overflow:hidden}
.si{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid #2c2c2e;min-height:44px}
.si:last-child{border-bottom:none}
.sl{color:#fff;font-size:16px}
.sr{display:flex;align-items:center;gap:10px}
.sr select,.sr input{padding:6px 10px;font-size:14px;border-radius:6px;background:#2c2c2e;color:#fff;border:1px solid #3a3a3c}
.sr input[type="file"]{display:none}
.fb{padding:8px 15px;font-size:14px;border-radius:6px;background:#007aff;color:#fff;border:none;cursor:pointer}
.fb:active{background:#0051d5}
.db{background:#ff3b30}
.db:active{background:#d32f2f}
.bgp{width:100px;height:60px;border-radius:6px;background-size:cover;background-position:center;border:2px solid #3a3a3c;cursor:pointer}
select,button,input{font-family:inherit}
.pwa-prompt{position:fixed;bottom:20px;left:20px;right:20px;background:rgba(0,122,255,.95);color:#fff;padding:15px;border-radius:12px;font-size:14px;z-index:10000;display:none;backdrop-filter:blur(10px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.pwa-prompt button{background:#fff;color:#007aff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;margin-top:10px;cursor:pointer}

/* =========================================
   ADDED WIDGET CSS
   ========================================= */
  :root{--w-accent:#3b82f6;--w-panel:#1e293b;--w-glass:rgba(255,255,255,0.05);}
  
  /* Edit Mode Grid Background on the Phone Screen (.p) */
  .p.edit-mode .h {
    background-image: radial-gradient(rgba(59,130,246,0.3) 1px, transparent 1px);
    background-size: 24px 24px;
    background-attachment: local;
  }

  /* --- WIDGET STYLING --- */
  .widget {
    position: absolute; /* Allows them to float over/around the grid */
    min-width: 80px; min-height: 80px;
    border-radius: 16px;
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255,255,255,0.05);
    overflow: hidden;
    touch-action: none;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    z-index: 10;
  }
  
  .widget-inner {
    flex: 1;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Default View Mode */
  .title-bar { display: none; } 
  .resize-handle { display: none; } 
  .content { padding: 10px; height: 100%; overflow:hidden; font-size:12px; }
  
  /* --- EDIT MODE STYLES --- */
  .p.edit-mode .widget {
    border: 1px solid rgba(59,130,246,0.5);
    background: rgba(30, 41, 59, 0.9);
    animation: wiggle 0.3s infinite alternate ease-in-out;
    cursor: grab;
    z-index: 50;
  }
  
  .p.edit-mode .widget.dragging {
    animation: none;
    transform: scale(1.05);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    z-index: 100;
  }

  .p.edit-mode .title-bar {
    display: flex; align-items: center; justify-content: space-between;
    height: 24px; padding: 0 5px;
    background: rgba(255,255,255,0.1);
    font-size: 10px; color: #94a3b8;
  }
  
  .p.edit-mode .delete-btn {
    width: 16px; height: 16px; background: #ef4444;
    border-radius: 50%; display: grid; place-items: center;
    color: white; font-size: 10px; cursor: pointer;
  }

  .p.edit-mode .resize-handle {
    display: block; position: absolute; width: 25px; height: 25px; z-index: 30;
  }
  .resize-handle.se { bottom: 0; right: 0; }
  .resize-handle.se::after {
    content: ''; position: absolute; bottom: 4px; right: 4px;
    width: 8px; height: 8px; border-right: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6;
  }

  @keyframes wiggle {
    0% { transform: rotate(-1.5deg); }
    100% { transform: rotate(1.5deg); }
  }

  /* --- WIDGET TOOLBAR (Bottom) --- */
  #editToolbar {
    position: absolute; bottom: -80px; left: 0; right: 0;
    height: 60px; background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; gap: 15px;
    transition: bottom 0.3s; z-index: 200;
    border-radius: 0 0 20px 20px;
  }
  .p.edit-mode #editToolbar { bottom: 0; }

  .w-btn {
    padding: 8px 16px; border-radius: 20px; border: none;
    font-weight: 600; font-size: 12px; cursor: pointer;
  }
  .w-btn-primary { background: #3b82f6; color: white; }
  .w-btn-secondary { background: rgba(255,255,255,0.2); color: #fff; }

  /* --- ADD PANEL --- */
  #addPanel {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 280px; background: var(--w-panel);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px; padding: 15px;
    opacity: 0; pointer-events: none; transition: 0.2s; z-index: 300;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  }
  #addPanel.open { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
  .widget-option {
    padding: 10px; margin: 6px 0; background: var(--w-glass);
    border-radius: 8px; cursor: pointer; color: #fff; font-size: 14px;
  }
  
  /* --- WIDGET CONTENT --- */
  .clock-display { text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; color: #fff; }
  .clock-time { font-size: 1.8em; font-weight: 300; line-height: 1; }
  .clock-date { font-size: 0.8em; color: #94a3b8; margin-top: 4px; }
  .weather-display { display: flex; align-items: center; justify-content: center; height: 100%; font-size: 1.2em; gap: 8px; color: #fff;}
</style>

</head>
<body>
<div class="pwa-prompt" id="pwaPrompt">
  <div id="promptText"></div>
  <button onclick="document.getElementById('pwaPrompt').style.display='none'">Got it</button>
</div>

<div class="p" id="phone">
<div class="n"></div>
<div class="s">
<div class="sb"><span id="c">12:00</span><span id="batt">100%</span></div>

<div class="h" id="h">
    <div class="ag" id="ag"></div>
    </div>

<div class="ad" id="ad"><div id="awc"></div></div>
<div class="as" id="as"><div class="sc" id="scc"></div></div>
<div id="rcb" class="rcx">‚úï</div>
<div id="er" class="em" style="display:none">No Recent Apps</div>
<div class="hi" id="hi"></div>

<div id="editToolbar">
    <button class="w-btn w-btn-secondary" id="btnAddWidget">+ Add</button>
    <button class="w-btn w-btn-primary" id="btnDone">Done</button>
</div>

<div id="addPanel">
    <h3 style="margin-top:0; color:#fff;">Add Widget</h3>
    <div class="widget-option" data-type="text">üìù Note</div>
    <div class="widget-option" data-type="clock">‚è∞ Clock</div>
    <div class="widget-option" data-type="weather">‚òÅÔ∏è Weather</div>
    <button class="w-btn w-btn-secondary" style="width:100%; margin-top:10px" onclick="document.getElementById('addPanel').classList.remove('open')">Cancel</button>
</div>

</div>
</div>

<script>
const D=document,g=n=>D.getElementById(n),q=s=>D.querySelector(s),qa=s=>D.querySelectorAll(s),ce=t=>D.createElement(t),
L=localStorage,K={o:'appLauncherOrder',t:'appLauncherTheme',f:'appLauncherFont',bg:'appLauncherBg',bb:'appLauncherBattery',pw:'pwaPromptShown'},
E={ag:g('ag'),awc:g('awc'),as:g('as'),scc:g('scc'),h:g('h'),er:g('er'),rcb:g('rcb'),p:g('phone'),hi:g('hi'),batt:g('batt')},
A=[{id:999,title:"Info",icon:"‚ÑπÔ∏è",path:"system:tutorial",class:"i"},{id:998,title:"Settings",icon:"‚öôÔ∏è",path:"system:settings",class:"st"}],
S={r:[],c:null,sw:0,dn:null,dr:0,dc:null,ds:{x:0,y:0}},
gv=(k,d)=>L.getItem(k)||d,sv=(k,v)=>L.setItem(k,v),
gt=_=>gv(K.t,'dark'),gf=_=>gv(K.f,'system'),gb=_=>gv(K.bg,''),gbb=_=>gv(K.bb,'show'),
at=_=>{const t=gt(),p=E.p,h=E.h,bg=gb(),m={light:['linear-gradient(135deg,#e0e0e0,#f5f5f5)','#000'],blue:['linear-gradient(135deg,#1e3c72,#2a5298)','#fff'],purple:['linear-gradient(135deg,#2d1b69,#5b3a9d)','#fff'],green:['linear-gradient(135deg,#0f2027,#203a43,#2c5364)','#fff'],red:['linear-gradient(135deg,#c31432,#240b36)','#fff'],orange:['linear-gradient(135deg,#f46b45,#eea849)','#fff'],pink:['linear-gradient(135deg,#ff9a9e,#fecfef)','#000']};if(bg){p.style.background='#000';p.style.backgroundImage=`url(${bg})`;p.style.backgroundSize='cover';p.style.backgroundPosition='center'}else if(m[t]){p.style.backgroundImage='none';p.style.background=m[t][0];h.style.color=m[t][1];qa('.al').forEach(l=>l.style.color=m[t][1])}else{p.style.backgroundImage='radial-gradient(circle at center,#1a1a1a 0%,#000 100%)';p.style.backgroundColor='#050505'}},
af=_=>{const f=gf(),m={system:'-apple-system,BlinkMacSystemFont,"SF Pro Display",sans-serif',serif:'Georgia,"Times New Roman",serif',mono:'"Courier New",Courier,monospace',rounded:'ui-rounded,"SF Pro Rounded",system-ui,sans-serif'};D.body.style.fontFamily=m[f]||m.system},
ab=_=>{const bb=gbb();E.batt.style.display=bb==='hide'?'none':'block'},
up=(x,y)=>{if(S.dc){S.dc.style.left=(x-30)+'px';S.dc.style.top=(y-30)+'px'}},
hts=function(e){const t=e.touches[0];S.ds={x:t.clientX,y:t.clientY};S.dr=0;this.dataset.ht=setTimeout(()=>{S.dr=1;S.dn=this;if(navigator.vibrate)navigator.vibrate(50);S.dc=this.cloneNode(!0);Object.assign(S.dc.style,{position:'fixed',zIndex:'1000',pointerEvents:'none',opacity:'.8',transform:'scale(1.1)',transition:'none'});D.body.appendChild(S.dc);this.style.opacity='.3';up(t.clientX,t.clientY)},300)},
htm=function(e){if(S.dr&&S.dn){e.preventDefault();const t=e.touches[0];up(t.clientX,t.clientY);const el=D.elementFromPoint(t.clientX,t.clientY),tg=el?.closest('.aiw:not([style*="opacity: 0.3"])');if(tg&&tg!==S.dn){const r=tg.getBoundingClientRect(),nx=(t.clientX-r.left)/r.width>.5;E.ag.insertBefore(S.dn,nx?tg.nextSibling:tg)}}else{const t=e.touches[0],d=Math.abs(t.clientX-S.ds.x)+Math.abs(t.clientY-S.ds.y);if(d>10)clearTimeout(this.dataset.ht)}},
hte=function(e){clearTimeout(this.dataset.ht);if(S.dr&&S.dn){e.preventDefault();S.dn.style.opacity='1';if(S.dc){S.dc.remove();S.dc=null}sv(K.o,JSON.stringify(Array.from(E.ag.children).map(t=>t.dataset.path)));S.dn=null;S.dr=0}},
ri=a=>{const el=ce('div');el.className='aiw';el.dataset.path=a.path;el.innerHTML=`<div class="ai ${a.class||''}">${a.icon}</div><div class="al">${a.title}</div>`;el.addEventListener('click',()=>{if(!S.dr)la(a)});el.addEventListener('touchstart',hts);el.addEventListener('touchmove',htm);el.addEventListener('touchend',hte);E.ag.appendChild(el)},
la=async a=>{const ex=S.r.find(x=>x.path===a.path);if(ex){S.r=S.r.filter(x=>x.path!==a.path);S.r.push(ex)}else S.r.push(ca(a));cs();let ac=S.r[S.r.length-1];if(ac.ce)ri2w(ac);requestAnimationFrame(()=>{ac.we.classList.add('ac');S.r.forEach(x=>x.we.style.zIndex=10);ac.we.style.zIndex=20;E.h.classList.add('zo');S.c=ac.path})},
loadApps=async()=>{try{const r=await fetch('apps.json');if(r.ok)A.push(...await r.json())}catch(e){}const o=gv(K.o,''),or=o?JSON.parse(o):[];if(or.length)A.sort((a,b)=>or.indexOf(a.path)-or.indexOf(b.path));E.ag.innerHTML='';A.forEach(ri)},
ca=d=>{const w=ce('div'),wc=ce('div');w.className='aw';wc.className='awc';if(d.path==="system:tutorial"){wc.innerHTML=`<div class="tc"><div style="font-size:60px;margin-bottom:20px;">‚ÑπÔ∏è</div><h2>How to Use</h2><br><div class="ts">1. Swipe Up bar to go Home.</div><div class="ts">2. Hold & Swipe Up for Recents.</div><div class="ts">3. <b>Hold Card</b> & Swipe Up to Close it.</div><div class="ts">4. <b>Long-press & drag</b> icons to reorder.</div><div class="ts" style="margin-top:20px;color:#007aff;">üí° <b>For fullscreen:</b> Add to Home Screen!</div></div>`}else if(d.path==="system:settings"){wc.innerHTML=`<div class="tc"><div style="font-size:60px;margin-bottom:20px;">‚öôÔ∏è</div><h2 style="margin-bottom:30px">Settings</h2><div class="sg"><div class="sh">Appearance</div><div class="so"><div class="si"><span class="sl">Theme</span><div class="sr"><select id="tsl"><option value="dark">Dark</option><option value="light">Light</option><option value="blue">Ocean Blue</option><option value="purple">Purple</option><option value="green">Forest</option><option value="red">Red Velvet</option><option value="orange">Sunset</option><option value="pink">Pink Dream</option></select></div></div><div class="si"><span class="sl">Font</span><div class="sr"><select id="fsl"><option value="system">System</option><option value="serif">Serif</option><option value="mono">Mono</option><option value="rounded">Rounded</option></select></div></div><div class="si"><span class="sl">Background</span><div class="sr"><div class="bgp" id="bgp"></div><label for="bgi" class="fb">Upload</label><input type="file" id="bgi" accept="image/*"></div></div></div></div><div class="sg"><div class="sh">Status Bar</div><div class="so"><div class="si"><span class="sl">Battery</span><div class="sr"><select id="bbs"><option value="show">Show</option><option value="hide">Hide</option></select></div></div></div></div><div class="sg"><div class="sh">Advanced</div><div class="so"><div class="si"><span class="sl">Reset Icon Order</span><div class="sr"><button class="fb" id="rio">Reset</button></div></div><div class="si"><span class="sl">Clear Background</span><div class="sr"><button class="fb db" id="cbg">Clear</button></div></div><div class="si"><span class="sl">Reset All</span><div class="sr"><button class="fb db" id="ra">Reset</button></div></div></div></div></div>`;setTimeout(()=>{const ts=wc.querySelector('#tsl'),fs=wc.querySelector('#fsl'),bbs=wc.querySelector('#bbs'),bgi=wc.querySelector('#bgi'),bgp=wc.querySelector('#bgp'),rio=wc.querySelector('#rio'),cbg=wc.querySelector('#cbg'),ra=wc.querySelector('#ra');ts.value=gt();fs.value=gf();bbs.value=gbb();const bg=gb();if(bg)bgp.style.backgroundImage=`url(${bg})`;bgp.addEventListener('click',()=>bgi.click());ts.addEventListener('change',e=>{sv(K.t,e.target.value);sv(K.bg,'');at()});fs.addEventListener('change',e=>{sv(K.f,e.target.value);af()});bbs.addEventListener('change',e=>{sv(K.bb,e.target.value);ab()});bgi.addEventListener('change',e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>{const b64=ev.target.result;sv(K.bg,b64);bgp.style.backgroundImage=`url(${b64})`;at()};r.readAsDataURL(f)}});cbg.addEventListener('click',()=>{if(confirm('Clear custom background?')){sv(K.bg,'');bgp.style.backgroundImage='';at()}});rio.addEventListener('click',()=>{if(confirm('Reset icon order?')){L.removeItem(K.o);loadApps()}});ra.addEventListener('click',()=>{if(confirm('Reset ALL settings to default?')){L.clear();location.reload()}})},100)}else{const i=ce('iframe');i.className='aif';i.src=d.path;i.setAttribute('sandbox','allow-scripts allow-forms allow-popups allow-modals allow-same-origin');wc.appendChild(i)}const ih=ce('div');ih.className='hi';let sy=0;ih.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;e.preventDefault()});ih.addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-sy<-40)hg()});w.appendChild(wc);w.appendChild(ih);E.awc.appendChild(w);return{...d,we:w,ce:null}},
hg=_=>{if(S.c){ma();os()}else if(S.sw)cs();else if(S.r.length>0)os()},
ma=_=>{if(!S.c)return;const a=S.r.find(x=>x.path===S.c);if(a)a.we.classList.remove('ac');E.h.classList.remove('zo');S.c=null},
cla=p=>{const i=S.r.findIndex(x=>x.path===p);if(i===-1)return;const a=S.r[i];a.we.remove();if(a.ce)a.ce.remove();S.r.splice(i,1);if(S.r.length===0)E.er.style.display='block';if(S.c===p)S.c=null},
os=_=>{S.sw=1;E.h.classList.add('zo');E.as.style.display='flex';E.rcb.style.display='flex';E.er.style.display=S.r.length===0?'block':'none';rsc();setTimeout(()=>{if(E.scc.lastElementChild){const cw=E.scc.lastElementChild.offsetWidth,cow=E.as.offsetWidth,sp=E.scc.lastElementChild.offsetLeft-(cow/2)+(cw/2);E.as.scrollLeft=sp}hss()},10)},
cs=_=>{S.sw=0;E.as.style.display='none';E.rcb.style.display='none';E.h.classList.remove('zo');E.er.style.display='none';S.r.forEach(ri2w)},
rsc=_=>{E.scc.innerHTML='';S.r.forEach(a=>{const c=ce('div');c.className='scd';const h=ce('div');h.className='ch';h.innerHTML=`<span style="color:#fff;font-size:12px;font-weight:bold">${a.title}</span>`;c.appendChild(h);const tl=ce('div');tl.className='ctl';c.appendChild(tl);const ct=ce('div');ct.style.cssText="width:100%;height:100%;pointer-events:none";const fc=a.we.firstChild;if(fc)while(fc.firstChild)ct.appendChild(fc.firstChild);c.appendChild(ct);let htnull,gr=0,sy=0;tl.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;gr=0;ht=setTimeout(()=>{gr=1;c.style.transform='scale(.95)';if(navigator.vibrate)navigator.vibrate(20)},300)});tl.addEventListener('touchmove',e=>{const dy=e.touches[0].clientY-sy;if(!gr&&Math.abs(dy)>5){clearTimeout(ht);gr=1}if(gr){e.preventDefault();if(dy<0){c.style.transition='none';c.style.transform=`scale(.95) translateY(${dy}px)`}}});tl.addEventListener('touchend',e=>{clearTimeout(ht);if(gr){const dy=e.changedTouches[0].clientY-sy;if(dy<-100){c.style.transition='transform .3s ease-out';c.style.transform='translateY(-100vh)';setTimeout(()=>cla(a.path),300)}else{c.style.transition='transform .2s ease';c.style.transform='scale(1)'}gr=0}else la(a)});E.scc.appendChild(c);a.ce=c})},
ri2w=a=>{if(!a.ce)return;const cd=a.ce.children[2];if(cd){const fc=a.we.firstChild;if(fc)while(cd.firstChild)fc.appendChild(cd.firstChild)}a.ce.remove();a.ce=null},
hss=_=>{if(!S.sw)return;const cl=E.as.scrollLeft+(E.as.clientWidth/2);S.r.forEach(a=>{if(!a.ce)return;const c=a.ce,cn=c.offsetLeft+(c.offsetWidth/2),d=Math.abs(cn-cl);c.style.opacity=d<50?1:.5})},
uc=_=>{const n=new Date();g('c').textContent=n.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'})},
initFullscreen=_=>{const isIOS=/iPhone|iPad|iPod/.test(navigator.userAgent);const isChrome=/CriOS/.test(navigator.userAgent);const isSafari=isIOS&&/Safari/.test(navigator.userAgent)&&!/CriOS/.test(navigator.userAgent);const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;if(!isStandalone&&!gv(K.pw,'')){const prompt=g('pwaPrompt'),text=g('promptText');if(isChrome&&isIOS){text.innerHTML='<strong>üì± Best Experience</strong><br>Open in Safari ‚Üí Share ‚Üí Add to Home Screen for fullscreen mode!';prompt.style.display='block';setTimeout(()=>{if(prompt.style.display!=='none'){sv(K.pw,'1')}},8000)}else if(isSafari){text.innerHTML='<strong>üì± Add to Home Screen</strong><br>Tap Share button ‚Üí Add to Home Screen for the best experience!';prompt.style.display='block';setTimeout(()=>{if(prompt.style.display!=='none'){sv(K.pw,'1')}},8000)}}if(isIOS&&isChrome){window.scrollTo(0,1);setTimeout(()=>window.scrollTo(0,1),100)}let hasInteracted=false;const tryFullscreen=()=>{if(hasInteracted)return;hasInteracted=true;const elem=D.documentElement;if(elem.requestFullscreen){elem.requestFullscreen().catch(()=>{})}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen().catch(()=>{})}};D.addEventListener('touchstart',tryFullscreen,{once:true});D.addEventListener('click',tryFullscreen,{once:true})},
init=async()=>{uc();setInterval(uc,1e3);at();af();ab();await loadApps();initFullscreen();let sy=0;E.hi.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;e.preventDefault()});E.hi.addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-sy<-40)hg()});E.rcb.addEventListener('click',cs);E.as.addEventListener('scroll',hss)};
init();

/* =========================================
   ADDED WIDGET LOGIC 
   ========================================= */
(() => {
  const GRID = 20; 
  // We attach widgets to the 'Home' scrollable container
  const container = document.getElementById('h');
  const phone = document.getElementById('phone');
  
  let isEditMode = false;
  let longPressTimer = null;
  
  const snap = (val) => Math.round(val / GRID) * GRID;

  // --- STATE MANAGEMENT ---
  function setEditMode(active) {
    isEditMode = active;
    if (active) {
      phone.classList.add('edit-mode');
    } else {
      phone.classList.remove('edit-mode');
      closeAddPanel();
    }
  }

  // --- COLLISION/BOUNDS ---
  function getContainerBounds() {
    // We use scrollWidth/Height to allow placing widgets further down
    return {
      width: container.clientWidth,
      height: Math.max(container.scrollHeight, 800)
    };
  }

  function constrain(w) {
    const bounds = getContainerBounds();
    let l = parseFloat(w.style.left) || 0;
    let t = parseFloat(w.style.top) || 0;
    let wd = parseFloat(w.style.width);
    let h = parseFloat(w.style.height);
    
    // Boundary checks
    if (l < 0) l = 0;
    if (t < 60) t = 60; // Keep below status bar/padding
    if (l + wd > bounds.width) l = bounds.width - wd;
    
    w.style.left = snap(l) + 'px';
    w.style.top = snap(t) + 'px';
  }
  
  // --- INTERACTION HANDLER ---
  function initWidget(w) {
    let startX, startY, startL, startT, startW, startH;
    let isDragging = false;
    let isResizing = false;

    // Delete
    w.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      w.remove();
    });

    // Resize
    const resizer = w.querySelector('.resize-handle');
    resizer.addEventListener('pointerdown', (e) => {
      if (!isEditMode) return;
      e.stopPropagation();
      isResizing = true;
      w.classList.add('resizing');
      
      startX = e.clientX;
      startY = e.clientY;
      startW = parseFloat(w.style.width);
      startH = parseFloat(w.style.height);
      resizer.setPointerCapture(e.pointerId);
    });

    // Drag / Long Press
    w.addEventListener('pointerdown', (e) => {
      if (e.target.closest('.delete-btn') || e.target.closest('.resize-handle')) return;
      
      startX = e.clientX;
      startY = e.clientY;
      startL = parseFloat(w.style.left) || 0;
      startT = parseFloat(w.style.top) || 0;

      if (!isEditMode) {
        longPressTimer = setTimeout(() => {
          setEditMode(true);
        }, 600);
      } else {
        isDragging = true;
        w.classList.add('dragging');
        w.setPointerCapture(e.pointerId);
      }
    });

    w.addEventListener('pointermove', (e) => {
      if (longPressTimer && (Math.abs(e.clientX - startX) > 10 || Math.abs(e.clientY - startY) > 10)) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }

      if (isResizing) {
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        w.style.width = snap(Math.max(80, startW + dx)) + 'px';
        w.style.height = snap(Math.max(80, startH + dy)) + 'px';
      } 
      else if (isDragging) {
        // Calculate new position relative to container
        // We must account for container scroll if needed, but since we are absolute inside a relative container, 
        // pointer delta is enough.
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        w.style.left = (startL + dx) + 'px';
        w.style.top = (startT + dy) + 'px';
      }
    });

    w.addEventListener('pointerup', (e) => {
      if (longPressTimer) clearTimeout(longPressTimer);

      if (isResizing) {
        isResizing = false;
        w.classList.remove('resizing');
        constrain(w);
      }

      if (isDragging) {
        isDragging = false;
        w.classList.remove('dragging');
        constrain(w);
      }
    });
  }

  // --- BACKGROUND INTERACTION (Trigger Edit Mode) ---
  container.addEventListener('pointerdown', (e) => {
    // Only trigger if clicking empty space (not icon, not widget)
    if (e.target === container || e.target.classList.contains('ag')) {
      if(!isEditMode) {
        longPressTimer = setTimeout(() => {
          setEditMode(true);
          if(navigator.vibrate) navigator.vibrate(50);
        }, 800);
      }
    }
  });

  container.addEventListener('pointerup', () => {
    if (longPressTimer) clearTimeout(longPressTimer);
  });

  // --- UI BUTTONS ---
  document.getElementById('btnDone').addEventListener('click', () => setEditMode(false));
  
  const addPanel = document.getElementById('addPanel');
  
  document.getElementById('btnAddWidget').addEventListener('click', () => {
    addPanel.classList.add('open');
  });

  function closeAddPanel() {
    addPanel.classList.remove('open');
  }

  // --- WIDGET CREATION ---
  const widgetTemplates = {
    text: () => `<div class="content" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white"><h4>Note</h4><p>Tap to edit...</p></div>`,
    clock: () => `<div class="clock-display"><div class="clock-time" data-clock>--:--</div><div class="clock-date" data-date>--</div></div>`,
    weather: () => `<div class="weather-display" style="background:linear-gradient(135deg,#3b82f6,#2563eb)"><span>üåßÔ∏è</span><span>12¬∞C</span></div>`
  };

  document.querySelectorAll('.widget-option').forEach(opt => {
    opt.addEventListener('click', (e) => {
      const type = e.currentTarget.dataset.type;
      createWidget(type);
      closeAddPanel();
    });
  });

  function createWidget(type) {
    const w = document.createElement('div');
    w.className = 'widget';
    w.style.width = '160px';
    w.style.height = '160px';
    
    // Default placement near top, avoiding immediate overlap if possible
    w.style.left = '20px';
    w.style.top = (container.scrollTop + 100) + 'px';
    
    w.innerHTML = `
      <div class="title-bar"><span>${type.toUpperCase()}</span><div class="delete-btn">√ó</div></div>
      <div class="resize-handle se"></div>
      <div class="widget-inner">${widgetTemplates[type]()}</div>
    `;
    
    container.appendChild(w);
    initWidget(w);
    updateClocks();
    setEditMode(true); // Switch to edit mode so user can move it immediately
  }

  // --- CLOCK LOOP ---
  function updateClocks() {
    const now = new Date();
    const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const date = now.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
    document.querySelectorAll('[data-clock]').forEach(el => el.textContent = time);
    document.querySelectorAll('[data-date]').forEach(el => el.textContent = date);
  }
  setInterval(updateClocks, 1000);

})();
</script>
</body>
</html>
