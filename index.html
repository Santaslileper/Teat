<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Santaslileper Fluid App Launcher</title>
  <style>
    /* ----------------------------------------------------------------
       CORE STYLES
    ---------------------------------------------------------------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
        background: #000; display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
        user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; cursor: default;
    }
    .status-bar { height: 44px; background: rgba(0,0,0,0.3); padding: 0 20px; display: flex; align-items: flex-end; justify-content: space-between; padding-bottom: 8px; color: #fff; font-size: 15px; font-weight: 600; z-index: 5; }
    .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 140px; height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; }
    
    /* LAUNCHER VIEWPORT & APP WINDOWS */
    .app-display { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 20; display: none; position: relative; overflow: hidden; }
    
    .app-window { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        transform: translate3d(100%, 0, 0); 
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        will-change: transform; z-index: 10; background: #fff; 
        overflow: hidden; 
        border-radius: 0;
    }
    .app-window.active {
        transform: translate3d(0, 0, 0);
        z-index: 15;
    }
    .app-iframe { width: 100%; height: 100%; border: none; background-color: white; }
    
    .home-screen { 
        flex: 1; padding: 60px 20px 20px 20px; 
        transition: transform 0.4s ease-out, filter 0.4s ease-out;
        will-change: transform;
    }
    .home-screen.hidden {
        transform: scale(0.95);
        filter: blur(2px) brightness(0.9);
        pointer-events: none;
    }

    /* NAVIGATION BAR (Fixed on top of everything) */
    .close-bar { position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: rgba(40, 40, 40, 0.9); display: flex; align-items: center; padding: 0 10px; z-index: 50; backdrop-filter: blur(10px); color: white; }
    .close-btn { color: #fff; background: none; border: none; font-size: 16px; cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: background 0.2s; }
    .close-btn:hover { background: rgba(255, 255, 255, 0.1); }

    /* --- FULL-SCREEN FLICKABLE APP SWITCHER --- */
    .app-switcher {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111;
        z-index: 20; display: none; overflow-x: scroll; overflow-y: hidden; 
        white-space: nowrap; 
        -webkit-overflow-scrolling: touch; 
        scroll-snap-type: x mandatory; 
        padding-top: 50px; /* Space for status bar/close bar */
    }

    /* Container for the horizontal row of cards */
    .switcher-card-container {
        display: inline-flex; 
        height: 100%;
        padding: 0 10px; /* Reduced padding for almost full width */
        gap: 15px; /* Reduced gap */
        align-items: flex-start;
    }
    
    /* Individual App Card: Now takes up most of the viewport */
    .switcher-card {
        width: calc(100vw - 40px); /* Fill screen width minus small margins */
        max-width: 355px; /* Max width for phone wrapper */
        height: 90%; /* Fill vertically */
        flex-shrink: 0; 
        background: #222;
        border-radius: 15px; /* Subtle rounding */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        position: relative;
        cursor: pointer;
        overflow: hidden;
        border: 2px solid #fff;
        transition: transform 0.2s;
        scroll-snap-align: center; 
    }
    .switcher-card:active { transform: scale(0.99); }

    .switcher-card-iframe {
        position: absolute; top: 0; left: 0; 
        width: 100%; height: 100%; 
        /* The iframe content is no longer scaled down, it's displayed directly */
        transform: none; 
        filter: brightness(0.9);
    }
    /* We hide the title/close buttons since the card itself is the primary view now */
    .switcher-card-title, .switcher-close-btn { display: none; }

    /* HOME SCREEN & ICONS (unchanged) */
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .app-icon-wrapper { text-align: center; text-decoration: none; touch-action: none; transition: transform 0.2s ease-out; }
    .app-icon { width: 100%; aspect-ratio: 1; border-radius: 22%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 32px; color: #fff; transition: transform 0.1s, box-shadow 0.1s; }
    .app-icon:active { transform: scale(0.9); box-shadow: 0 2px 3px rgba(0, 0, 0, 0.5); }
    .app-icon-wrapper.dragging { z-index: 100; cursor: grabbing; }
    .app-icon-wrapper.dragging .app-icon { transform: scale(1.15); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); opacity: 0.8; transition: none; }
    .app-icon.camera { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .app-icon.mic { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .app-icon.motion { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .app-icon.torch { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
    .app-icon.touch { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .app-icon.speaker { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    .app-label { color: #fff; font-size: 12px; margin-top: 4px; text-align: center; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.6); }

    /* RESPONSIVENESS (Minified) */
    @media (min-width: 768px) {
        .phone { width: 375px; height: 812px; background: #1d1d1f; border-radius: 50px; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.8); border: 12px solid #2c2c2e; overflow: hidden; display: block; }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 180px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 10; display: block; }
        .camera { position: absolute; width: 12px; height: 12px; background: #1a1a1a; border-radius: 50%; top: 9px; left: 50%; transform: translateX(-30px); border: 1px solid #333; }
        .speaker { position: absolute; width: 60px; height: 6px; background: #1a1a1a; border-radius: 3px; top: 12px; left: 50%; transform: translateX(-50%); }
        .screen { width: 100%; height: 100%; background: #000; border-radius: 38px; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .vol-up, .vol-down, .silent-switch { position: absolute; left: -2px; width: 4px; height: 50px; background: #2c2c2e; border-radius: 2px 0 0 2px; display: block; }
        .vol-up { top: 150px; }
        .vol-down { top: 220px; }
        .silent-switch { top: 100px; height: 30px; }
    }
    @media (max-width: 767px) {
        .phone { width: 100%; height: 100vh; border-radius: 0; border: none; box-shadow: none; padding: 0; }
        .screen { width: 100%; height: 100vh; border-radius: 0; }
        .notch, .vol-up, .vol-down, .silent-switch { display: none !important; }
        .status-bar { padding-top: 50px; padding-bottom: 12px; }
    }
  </style>
</head>
<body>
  
  <div class="phone">
    
    <div class="notch"><div class="camera"></div><div class="speaker"></div></div>
    <div class="vol-up" title="Volume Up"></div>
    <div class="vol-down" title="Volume Down"></div>
    <div class="silent-switch" title="Silent Switch"></div>
    <div class="screen">
      <div class="status-bar"><span id="time">9:41</span><span>‚ö°Ô∏é üì∂ 100%</span></div>
      
      <div class="home-screen" id="homeScreen">
        <div class="app-grid" id="appGrid"></div>
      </div>
      <div class="home-indicator"></div>

      <div class="app-display" id="appDisplay">
        
        <div id="appWindowContainer"></div>
        
        <div class="app-switcher" id="appSwitcher">
            <div class="switcher-card-container" id="switcherCardContainer">
                </div>
        </div>

        <div class="close-bar">
            <span id="app-title-display" style="flex-grow: 1; font-weight: bold; cursor: default;">Home</span>
            <button class="close-btn" id="toggleAppSwitcherBtn">Home / Recents</button>
        </div>

      </div>

    </div>
  </div>

  <script>
    const appGrid = document.getElementById('appGrid');
    const appDisplay = document.getElementById('appDisplay');
    const appWindowContainer = document.getElementById('appWindowContainer');
    const appSwitcher = document.getElementById('appSwitcher');
    const switcherCardContainer = document.getElementById('switcherCardContainer');
    const homeScreen = document.getElementById('homeScreen');
    const appTitleDisplay = document.getElementById('app-title-display');
    const toggleAppSwitcherBtn = document.getElementById('toggleAppSwitcherBtn');
    
    const STORAGE_KEY = 'appLauncherOrder';
    let runningApps = []; 
    let currentAppPath = null;
    let isSwitcherOpen = false;
    let draggedItem = null;

    const BASE_SANDBOX_PERMISSIONS = 'allow-scripts allow-forms allow-popups';
    const MAPS_PATH = 'maps'; 

    // Helper to scroll the switcher to the active app
    function scrollSwitcherToActive() {
        if (!currentAppPath || !isSwitcherOpen) return;
        // The most recent app is the first card (index 0) in the runningApps array
        // which corresponds to the first card in the container (index 0).
        const cardContainer = document.getElementById('switcherCardContainer');
        const activeCard = cardContainer.children[0]; 
        
        if (activeCard) {
             const cardCenter = activeCard.offsetLeft + activeCard.offsetWidth / 2;
             const containerCenter = appSwitcher.offsetWidth / 2;
             // Scroll position to center the first card
             const scrollPos = cardCenter - containerCenter - 10; 
             appSwitcher.scrollLeft = scrollPos;
        }
    }

    // --- Core Icon Rendering and Drag Setup (Minified) ---
    function createAppIcon(app) {
        const wrapper = document.createElement('div');
        wrapper.className = 'app-icon-wrapper block text-center cursor-pointer';
        wrapper.title = app.title; wrapper.dataset.path = app.path; wrapper.dataset.title = app.title;
        wrapper.setAttribute('draggable', true); wrapper.dataset.appId = app.path; 

        const iconDiv = document.createElement('div');
        iconDiv.className = `app-icon ${app.class || 'camera'}`;
        iconDiv.textContent = app.icon.replace(/\s/g, '').replace(/[^A-Za-z0-9\s]/g, '') || app.icon;

        const labelDiv = document.createElement('div');
        labelDiv.className = 'app-label';
        labelDiv.textContent = app.title.replace(/[^A-Za-z0-9\s]/g, '').trim(); 

        wrapper.appendChild(iconDiv); wrapper.appendChild(labelDiv);
        
        wrapper.addEventListener('click', (e) => {
            if (e.currentTarget.classList.contains('just-dragged')) {
                e.currentTarget.classList.remove('just-dragged'); return;
            }
            launchApp(app.path, app.title);
        });
        
        wrapper.addEventListener('dragstart', handleDragStart);
        wrapper.addEventListener('dragover', handleDragOver);
        wrapper.addEventListener('drop', handleDrop);
        wrapper.addEventListener('dragend', handleDragEnd);

        return wrapper;
    }

    // Local Storage Management (Minified)
    function getSavedOrder() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; }
    function saveCurrentOrder() { localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(appGrid.children).map(icon => icon.dataset.appId))); }
    function sortAppData(appData) {
        const savedOrder = getSavedOrder();
        if (!savedOrder || savedOrder.length !== appData.length) return appData;
        const appMap = new Map(appData.map(app => [app.path, app]));
        const sortedData = savedOrder.map(appId => appMap.get(appId)).filter(app => app); 
        const existingAppIds = new Set(savedOrder);
        appData.forEach(app => { if (!existingAppIds.has(app.path)) sortedData.push(app); });
        return sortedData;
    }

    // Drag and Drop Handlers (Minified)
    function handleDragStart(e) { draggedItem = this; e.dataTransfer.setData('text/html', ''); this.classList.add('dragging'); if (navigator.vibrate) navigator.vibrate(50); }
    function handleDragOver(e) {
        e.preventDefault(); 
        const target = e.target.closest('.app-icon-wrapper:not(.dragging)');
        if (!target) return;
        const rect = target.getBoundingClientRect();
        const next = (e.clientX - rect.left) / rect.width > 0.5; 
        if (next) appGrid.insertBefore(draggedItem, target.nextSibling);
        else appGrid.insertBefore(draggedItem, target);
    }
    function handleDrop(e) { e.preventDefault(); draggedItem.classList.add('just-dragged'); saveCurrentOrder(); }
    function handleDragEnd(e) { this.classList.remove('dragging'); draggedItem = null; }


    // --- App Lifecycle Management ---

    function launchApp(path, title) {
        let app = runningApps.find(a => a.path === path);
        const isNewApp = !app;

        if (isNewApp) {
            app = createNewAppWindow(path, title);
            runningApps.unshift(app); // Add new app to the front (most recent)
        } else {
            // If app is already running, move it to the front
            runningApps = runningApps.filter(a => a.path !== path);
            runningApps.unshift(app);
        }

        isSwitcherOpen = false;
        appSwitcher.style.display = 'none';
        
        appDisplay.style.display = 'block';
        
        homeScreen.classList.add('hidden'); 
        
        setTimeout(() => {
            setActiveApp(path, title);
        }, 50);

        appTitleDisplay.textContent = title.replace(/[^A-Za-z0-9\s]/g, '').trim();
    }

    function createNewAppWindow(path, title) {
        const appWindow = document.createElement('div');
        appWindow.className = 'app-window';
        appWindow.dataset.path = path;

        const iframe = document.createElement('iframe');
        iframe.className = 'app-iframe';
        iframe.src = path;
        iframe.title = title;
        
        let sandboxPermissions = BASE_SANDBOX_PERMISSIONS;
        // Conditional sandboxing for maps
        if (path.includes(MAPS_PATH)) {
             sandboxPermissions += ' allow-modals allow-pointer-lock allow-orientation-lock'; 
        }
        
        iframe.setAttribute('sandbox', sandboxPermissions);

        appWindow.appendChild(iframe);
        appWindowContainer.appendChild(appWindow);
        
        return { path, title, windowElement: appWindow };
    }

    function setActiveApp(path, title) {
        runningApps.forEach(app => {
            if (app.path === path) {
                app.windowElement.classList.add('active'); 
                app.windowElement.style.zIndex = 15;
            } else {
                app.windowElement.classList.remove('active');
                app.windowElement.style.zIndex = 10;
            }
        });
        currentAppPath = path;
        appTitleDisplay.textContent = title.replace(/[^A-Za-z0-9\s]/g, '').trim();
    }
    
    function closeApp(path) {
        runningApps = runningApps.filter(app => {
            if (app.path === path) {
                app.windowElement.style.transform = 'translate3d(100%, 0, 0)'; 
                setTimeout(() => app.windowElement.remove(), 400); 
                return false;
            }
            return true;
        });
        
        if (currentAppPath === path) {
            currentAppPath = null;
            if (runningApps.length > 0) {
                renderAppSwitcher();
                appSwitcher.style.display = 'flex';
                isSwitcherOpen = true;
                homeScreen.classList.remove('hidden'); 
            } else {
                 appDisplay.style.display = 'none';
                 appSwitcher.style.display = 'none';
                 isSwitcherOpen = false;
                 homeScreen.classList.remove('hidden'); 
                 appTitleDisplay.textContent = 'Home';
            }
        } else if (isSwitcherOpen) {
            renderAppSwitcher();
        }
    }

    // --- App Switcher/Recents Logic ---
    
    function renderAppSwitcher() {
        switcherCardContainer.innerHTML = '';
        
        if (runningApps.length === 0) {
             switcherCardContainer.innerHTML = '<div style="color: white; padding: 50px;">No recent apps. Tap "Home / Recents" again to go Home.</div>';
             appTitleDisplay.textContent = 'Recents';
             return;
        }

        appTitleDisplay.textContent = 'Recents';
        
        // Render apps in order (most recent is first)
        runningApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'switcher-card';
            card.dataset.path = app.path;
            
            const iframeClone = app.windowElement.querySelector('.app-iframe').cloneNode(true);
            iframeClone.className = 'switcher-card-iframe';
            // IMPORTANT: We do not append the title or close button to maintain the "full app view" look

            card.appendChild(iframeClone);
            switcherCardContainer.appendChild(card);
            
            // Tapping anywhere on the card switches to that app
            card.addEventListener('click', () => { launchApp(app.path, app.title); });
            
            // Double-tap or long-press logic for closing the app (optional, complex for pure JS)
        });
        
        // Move app windows out of the way for the switcher
        runningApps.forEach(app => {
             app.windowElement.style.transform = 'translateY(100%)'; 
             app.windowElement.classList.remove('active'); 
             app.windowElement.style.zIndex = 10;
        });
        
        // After rendering, scroll to center the most recent app (the first card)
        setTimeout(scrollSwitcherToActive, 100); 
    }

    toggleAppSwitcherBtn.addEventListener('click', () => {
        if (!isSwitcherOpen && runningApps.length > 0) {
            // Open Switcher
            renderAppSwitcher();
            appSwitcher.style.display = 'block'; // Use 'block' to allow full scrolling viewport
            isSwitcherOpen = true;
            homeScreen.classList.remove('hidden');
        } else if (isSwitcherOpen && currentAppPath) {
            // Close Switcher to active app (This path is rarely hit now, as clicking a card handles it)
            appSwitcher.style.display = 'none';
            isSwitcherOpen = false;
            const app = runningApps.find(a => a.path === currentAppPath);
            app.windowElement.classList.add('active');
            app.windowElement.style.zIndex = 15;
            appTitleDisplay.textContent = app.title.replace(/[^A-Za-z0-9\s]/g, '').trim();
            homeScreen.classList.add('hidden');
        } else {
            // Go back to home screen
            appDisplay.style.display = 'none';
            appSwitcher.style.display = 'none';
            isSwitcherOpen = false;
            currentAppPath = null;
            appTitleDisplay.textContent = 'Home';
            homeScreen.classList.remove('hidden');
        }
    });

    // --- Initial Render ---
    async function fetchAndRenderApps() {
        try {
            const response = await fetch('./apps.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            let appData = await response.json();
            appData = sortAppData(appData);
            appData.forEach(app => { appGrid.appendChild(createAppIcon(app)); });
        } catch (error) {
            console.error("Could not load app data:", error);
            appGrid.innerHTML = '<div style="color: #ff3b30; grid-column: 1 / -1; margin-top: 50px; text-align: center;">‚ö†Ô∏è Error: Could not load app manifest.</div>';
        }
    }
    fetchAndRenderApps();

    // --- Time Update ---
    function updateTime() {
      const now = new Date();
      const hours = now.getHours() % 12 || 12; 
      document.getElementById('time').textContent = 
        `${hours}:${String(now.getMinutes()).padStart(2, '0')}`;
    }
    updateTime();
    setInterval(updateTime, 1000);
  </script>

</body>
</html>
