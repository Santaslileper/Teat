<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Santaslileper OS</title>
  <style>
    /* --- CORE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
        background: #000; display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; padding: 20px; 
        user-select: none; -webkit-user-select: none; cursor: default;
        overflow: hidden;
    }

    /* --- THEME --- */
    .phone { 
        position: relative; width: 100%; height: 100%; max-width: 375px; max-height: 812px;
        background-color: #050505; 
        background-image: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        overflow: hidden; 
        display: flex; flex-direction: column;
        border: 1px solid #333;
    }
    
    @media (min-width: 768px) {
        .phone { height: 812px; border-radius: 50px; box-shadow: 0 0 0 12px #2c2c2e, 0 20px 60px rgba(0,0,0,0.8); }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 180px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 100; }
    }
    
    .screen { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 2; }
    .status-bar { 
        height: 44px; padding: 0 20px; display: flex; align-items: flex-end; justify-content: space-between; 
        padding-bottom: 8px; color: #fff; font-size: 15px; font-weight: 600; 
        z-index: 100; pointer-events: none; position: absolute; width: 100%; top: 0;
    }

    /* --- HOME SCREEN --- */
    .home-screen { 
        padding: 60px 20px 80px 20px; height: 100%; overflow-y: auto;
        transition: transform 0.4s cubic-bezier(0.32, 0, 0.67, 0), filter 0.4s linear;
        will-change: transform, filter;
    }
    .home-screen.zoomed-out {
        transform: scale(0.85);
        filter: brightness(0.6) blur(5px);
        pointer-events: none;
    }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    .app-icon-wrapper { 
        display: flex; flex-direction: column; align-items: center; 
        transition: transform 0.2s ease; touch-action: none; 
    }
    .app-icon { 
        width: 60px; height: 60px; border-radius: 14px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 30px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #333, #555);
    }
    .app-icon.info { background: linear-gradient(135deg, #3498db, #2980b9); }
    .app-icon:active { filter: brightness(0.8); transform: scale(0.95); }
    .app-label { color: #fff; font-size: 11px; margin-top: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

    /* --- APP WINDOWS --- */
    .app-display { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 50; pointer-events: none;
    }
    .app-window {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff;
        transform: translate3d(100%, 0, 0); 
        transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        pointer-events: auto; overflow: hidden;
    }
    .app-window.active { transform: translate3d(0, 0, 0); }
    .app-iframe { width: 100%; height: 100%; border: none; display: block; }

    /* --- APP SWITCHER (FIXED SCROLLING) --- */
    .app-switcher {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: transparent; z-index: 40; 
        display: none; 
        flex-direction: row;
        align-items: center;
        overflow-x: auto; 
        overflow-y: hidden;
        white-space: nowrap; 
        scroll-snap-type: x mandatory;
        padding-left: 20px;
        padding-right: 20px;
        pointer-events: auto;
    }
    
    .switcher-container { 
        display: flex; 
        height: 100%; 
        align-items: center; 
        gap: 20px; 
        min-width: min-content; 
    }

    .switcher-card {
        position: relative; width: 75vw; max-width: 300px; height: 70vh;
        background: #222; border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        scroll-snap-align: center; 
        flex-shrink: 0;
        transform-origin: center; transition: transform 0.2s;
        overflow: hidden;
    }
    
    .card-header {
        position: absolute; top: 0; left: 0; width: 100%; height: 40px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        z-index: 20; pointer-events: none;
    }
    
    .card-touch-layer {
        position: absolute; top: 40px; left: 0; width: 100%; height: calc(100% - 40px);
        z-index: 15;
    }

    /* Small X button for Recents Menu */
    .recents-close-x {
        position: absolute; top: 50px; right: 20px;
        width: 30px; height: 30px; background: rgba(60,60,60,0.8);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: white; font-weight: bold; font-size: 16px; cursor: pointer;
        z-index: 200; backdrop-filter: blur(5px);
        display: none;
    }

    .empty-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #fff; font-size: 16px; pointer-events: none;
    }

    /* --- TUTORIAL --- */
    .tutorial-content {
        width: 100%; height: 100%; background: #111; color: white;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 40px; text-align: center;
    }
    .tutorial-step { margin-bottom: 15px; font-size: 18px; color: #ccc; }

    /* --- GESTURE BAR --- */
    .home-indicator { 
        position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; 
        display: flex; justify-content: center; align-items: center; z-index: 999; 
        touch-action: none;
    }
    .home-indicator::before { 
        content: ''; display: block; width: 140px; height: 5px; 
        background: rgba(255,255,255,0.7); border-radius: 3px; 
    }
  </style>
</head>
<body>

<div class="phone">
    <div class="notch"></div>
    <div class="screen">
        <div class="status-bar"><span id="clock">12:00</span><span>5G 100%</span></div>

        <div class="home-screen" id="homeScreen">
            <div class="app-grid" id="appGrid"></div>
        </div>

        <div class="app-display" id="appDisplay">
            <div id="appWindowContainer"></div>
        </div>

        <div class="app-switcher" id="appSwitcher">
            <div class="switcher-container" id="switcherContainer"></div>
        </div>
        
        <div id="recentsCloseBtn" class="recents-close-x">✕</div>
        <div id="emptyRecents" class="empty-msg" style="display: none;">No Recent Apps</div>
        <div class="home-indicator" id="homeIndicator"></div>
    </div>
</div>

<script>
    const appGrid = document.getElementById('appGrid');
    const appWindowContainer = document.getElementById('appWindowContainer');
    const appSwitcher = document.getElementById('appSwitcher');
    const switcherContainer = document.getElementById('switcherContainer');
    const homeScreen = document.getElementById('homeScreen');
    const emptyRecents = document.getElementById('emptyRecents');
    const recentsCloseBtn = document.getElementById('recentsCloseBtn');
    
    let runningApps = []; 
    let currentAppPath = null;
    let isSwitcherMode = false;

    // Hardcoded Tutorial
    const TUTORIAL_APP = { id: 999, title: "Info", icon: "ℹ️", path: "system:tutorial", class: "info" };

    async function init() {
        updateClock(); setInterval(updateClock, 1000);
        await loadApps();
        
        // Home Gesture (Swipe Up)
        const indicator = document.getElementById('homeIndicator');
        let startY = 0;
        indicator.addEventListener('touchstart', e => { startY = e.touches[0].clientY; e.preventDefault(); });
        indicator.addEventListener('touchend', e => {
            if (e.changedTouches[0].clientY - startY < -40) handleHomeGesture();
        });
        
        recentsCloseBtn.addEventListener('click', closeSwitcher);
        appSwitcher.addEventListener('scroll', handleSwitcherScroll);
    }

    async function loadApps() {
        renderIcon(TUTORIAL_APP);
        try {
            const res = await fetch('apps.json');
            if (res.ok) {
                let apps = await res.json();
                apps.forEach(renderIcon);
            }
        } catch (e) { console.log("No apps.json"); }
    }

    function renderIcon(app) {
        const el = document.createElement('div');
        el.className = 'app-icon-wrapper';
        el.innerHTML = `<div class="app-icon ${app.class || ''}">${app.icon}</div><div class="app-label">${app.title}</div>`;
        el.addEventListener('click', () => launchApp(app));
        appGrid.appendChild(el);
    }

    // --- NAVIGATION ---
    function handleHomeGesture() {
        if (currentAppPath) { minimizeApp(); openSwitcher(); }
        else if (isSwitcherMode) closeSwitcher();
        else if (runningApps.length > 0) openSwitcher();
    }

    // --- APP LOGIC ---
    function launchApp(appData) {
        // Remove existing instance if any (so we push to end/front)
        let existing = runningApps.find(a => a.path === appData.path);
        if (existing) {
            runningApps = runningApps.filter(a => a.path !== appData.path);
            runningApps.push(existing);
        } else {
            let newApp = createAppInstance(appData);
            runningApps.push(newApp);
        }

        closeSwitcher();
        let activeApp = runningApps[runningApps.length - 1]; // Last item is active

        if (activeApp.cardEl) restoreIframeToWindow(activeApp);

        requestAnimationFrame(() => {
            activeApp.windowEl.classList.add('active');
            runningApps.forEach(a => a.windowEl.style.zIndex = 10);
            activeApp.windowEl.style.zIndex = 20;
            homeScreen.classList.add('zoomed-out');
            currentAppPath = activeApp.path;
        });
    }

    function createAppInstance(data) {
        const win = document.createElement('div');
        win.className = 'app-window';
        
        if (data.path === "system:tutorial") {
            win.innerHTML = `
            <div class="tutorial-content">
                <div style="font-size:60px; margin-bottom:20px;">ℹ️</div>
                <h2>How to Use</h2><br>
                <div class="tutorial-step">1. Swipe Up bar to go Home.</div>
                <div class="tutorial-step">2. Hold & Swipe Up for Recents.</div>
                <div class="tutorial-step">3. <b>Hold Card</b> & Swipe Up to Close it.</div>
            </div>`;
        } else {
            const iframe = document.createElement('iframe');
            iframe.className = 'app-iframe';
            iframe.src = data.path;
            iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups allow-modals');
            win.appendChild(iframe);
        }
        
        appWindowContainer.appendChild(win);
        return { ...data, windowEl: win, cardEl: null };
    }

    function minimizeApp() {
        if (!currentAppPath) return;
        const app = runningApps.find(a => a.path === currentAppPath);
        if (app) app.windowEl.classList.remove('active');
        homeScreen.classList.remove('zoomed-out');
        currentAppPath = null;
    }

    function closeApp(path) {
        const idx = runningApps.findIndex(a => a.path === path);
        if (idx === -1) return;
        const app = runningApps[idx];

        app.windowEl.remove();
        if (app.cardEl) app.cardEl.remove();
        runningApps.splice(idx, 1);

        if (runningApps.length === 0) emptyRecents.style.display = 'block';
        if (currentAppPath === path) currentAppPath = null;
    }

    // --- SWITCHER ---
    function openSwitcher() {
        isSwitcherMode = true;
        homeScreen.classList.add('zoomed-out');
        appSwitcher.style.display = 'flex'; // Make visible
        recentsCloseBtn.style.display = 'flex';
        emptyRecents.style.display = runningApps.length === 0 ? 'block' : 'none';

        renderSwitcherCards();
        
        // Scroll to the end (most recent app)
        setTimeout(() => {
            if (switcherContainer.lastElementChild) {
                const cardWidth = switcherContainer.lastElementChild.offsetWidth;
                const containerWidth = appSwitcher.offsetWidth;
                const scrollPos = switcherContainer.lastElementChild.offsetLeft - (containerWidth / 2) + (cardWidth / 2);
                appSwitcher.scrollLeft = scrollPos;
            }
            handleSwitcherScroll();
        }, 10);
    }

    function closeSwitcher() {
        isSwitcherMode = false;
        appSwitcher.style.display = 'none';
        recentsCloseBtn.style.display = 'none';
        homeScreen.classList.remove('zoomed-out');
        emptyRecents.style.display = 'none';
        runningApps.forEach(restoreIframeToWindow);
    }

    function renderSwitcherCards() {
        switcherContainer.innerHTML = '';
        
        runningApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'switcher-card';
            
            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<span style="color:white; font-size:12px; font-weight:bold;">${app.title}</span>`;
            card.appendChild(header);

            // Grip Layer
            const touchLayer = document.createElement('div');
            touchLayer.className = 'card-touch-layer';
            card.appendChild(touchLayer);

            // Content
            const content = document.createElement('div');
            content.style.cssText = "width:100%; height:100%; pointer-events:none;"; 
            while(app.windowEl.firstChild) { content.appendChild(app.windowEl.firstChild); }
            card.appendChild(content);
            
            // Interaction Logic (FIXED FOR TAP TO FULLSCREEN)
            let holdTimer = null;
            let isGripped = false;
            let startY = 0;

            touchLayer.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                isGripped = false; // Reset grip state
                
                // Start Hold Timer: if it fires, we transition to grip/drag mode
                holdTimer = setTimeout(() => {
                    isGripped = true;
                    // Visual feedback: Shrink card slightly
                    card.style.transform = 'scale(0.95)';
                    if(navigator.vibrate) navigator.vibrate(20);
                }, 300);
            });

            touchLayer.addEventListener('touchmove', (e) => {
                // If we move too much vertically before the hold timer fires,
                // we treat it as an immediate drag (for closing)
                const deltaY = e.touches[0].clientY - startY;
                
                if (!isGripped && Math.abs(deltaY) > 5) { // User started dragging before hold time
                     clearTimeout(holdTimer);
                     isGripped = true; // Immediately enter grip mode
                }

                if (isGripped) {
                    e.preventDefault(); // Stop scrolling the list if we're dragging the card
                    if (deltaY < 0) { // Dragging Up
                        card.style.transition = 'none';
                        card.style.transform = `scale(0.95) translateY(${deltaY}px)`;
                    }
                }
            });

            touchLayer.addEventListener('touchend', (e) => {
                clearTimeout(holdTimer);
                
                if (isGripped) {
                    // Release Logic (Close Gesture)
                    const dy = e.changedTouches[0].clientY - startY;
                    if (dy < -100) {
                        // Swipe Up Successful -> Close
                        card.style.transition = 'transform 0.3s ease-out';
                        card.style.transform = 'translateY(-100vh)';
                        setTimeout(() => closeApp(app.path), 300);
                    } else {
                        // Snap Back
                        card.style.transition = 'transform 0.2s ease';
                        card.style.transform = 'scale(1)';
                    }
                    isGripped = false;
                } else {
                    // It was a Quick Tap -> Launch Fullscreen
                    launchApp(app);
                }
            });

            switcherContainer.appendChild(card);
            app.cardEl = card;
        });
    }

    function restoreIframeToWindow(app) {
        if (!app.cardEl) return;
        const contentDiv = app.cardEl.children[2];
        if(contentDiv) {
             while(contentDiv.firstChild) { app.windowEl.appendChild(contentDiv.firstChild); }
        }
        app.cardEl.remove(); // Remove the card element
        app.cardEl = null;
    }

    function handleSwitcherScroll() {
        if (!isSwitcherMode) return;
        const centerLine = appSwitcher.scrollLeft + (appSwitcher.clientWidth / 2);
        
        runningApps.forEach(app => {
            if (!app.cardEl) return;
            const card = app.cardEl;
            const center = card.offsetLeft + (card.offsetWidth/2);
            const dist = Math.abs(center - centerLine);

            if (dist < 50) card.style.opacity = 1;
            else card.style.opacity = 0.5;
        });
    }
    
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
    }

    init();
</script>
</body>
</html>
